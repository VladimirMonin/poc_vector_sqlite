–≠—Ç–æ –ª–æ–≥–∏—á–Ω—ã–π –∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π —à–∞–≥. **–§–∞–∑–∞ 4.1: –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∏ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¢–µ—Å—Ç–æ–≤–æ–≥–æ –ü–æ–∫—Ä—ã—Ç–∏—è**.

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è AST-–ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –ª–∏–±–æ —É—Å—Ç–∞—Ä–µ—é—Ç, –ª–∏–±–æ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã. –ù–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ "—Ö–ª–µ–±–Ω—ã—Ö –∫—Ä–æ—à–µ–∫" –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑—É–ø—Ä–µ—á–Ω–æ, –ø—Ä–µ–∂–¥–µ —á–µ–º –º—ã –ø–æ–π–¥–µ–º –≤ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å.

–ù–∏–∂–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.

-----

### üó∫Ô∏è –¶–µ–ª–∏ –§–∞–∑—ã 4.1

1. **Unit-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ AST:** –î–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø–∞—Ä—Å–µ—Ä –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä–æ–∏—Ç –¥–µ—Ä–µ–≤–æ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ –Ω–µ –ª–æ–º–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–µ–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å–µ–∫—Ü–∏–π.
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ JSON-—Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (—Å–ø–∏—Å–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –∞—Å—Å–µ—Ç—ã) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ SQLite —á–µ—Ä–µ–∑ Peewee.
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –ü–∞–π–ø–ª–∞–π–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞—Ä—Å–µ—Ä –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è —Ñ–∞–π–ª–∞.
4. **–†–µ–≥—Ä–µ—Å—Å–∏—è:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å—Ç–∞—Ä—ã–π –¥–æ–±—Ä—ã–π —Ç–µ–∫—Å—Ç (`.txt`) –≤—Å—ë –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.

-----

### üìÇ –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¢–µ—Å—Ç–æ–≤

–ú—ã –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–æ–≤ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã.

```text
tests/
‚îú‚îÄ‚îÄ conftest.py                  # –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã (—Å–ª–æ–∂–Ω—ã–µ MD –¥–æ–∫—É–º–µ–Ω—Ç—ã)
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ processing/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ parsers/             # <--- –ù–û–í–û–ï
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ test_markdown_parser.py  # –¢–µ—Å—Ç—ã AST, —Å—Ç–µ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_asset_extraction.py # –¢–µ—Å—Ç—ã –ø–æ–∏—Å–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏/–≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ context/             # <--- –ù–û–í–û–ï
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ test_hierarchical.py     # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–ª–µ–π–∫–∏ "–ó–∞–≥–æ–ª–æ–≤–æ–∫ > –¢–µ–∫—Å—Ç"
‚îÇ   ‚îî‚îÄ‚îÄ domain/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ storage/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_metadata_storage.py # <--- –ù–û–í–û–ï: –ü—Ä–æ–≤–µ—Ä–∫–∞ JSON –ø–æ–ª–µ–π –≤ –ë–î
‚îÇ   ‚îú‚îÄ‚îÄ pipeline/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test_ingestion_routing.py # –ü—Ä–æ–≤–µ—Ä–∫–∞: .md -> MarkdownParser, .txt -> Simple
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

-----

### üõ†Ô∏è –î–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω —Ä–∞–±–æ—Ç

#### 1\. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –§–∏–∫—Å—Ç—É—Ä (`conftest.py`)

–ù–∞–º –Ω—É–∂–Ω—ã "–∑–ª—ã–µ" –ø—Ä–∏–º–µ—Ä—ã Markdown, –∫–æ—Ç–æ—Ä—ã–µ –ª–æ–º–∞—é—Ç –ø—Ä–æ—Å—Ç—ã–µ —Ä–µ–≥—É–ª—è—Ä–∫–∏.

* **–§–∏–∫—Å—Ç—É—Ä–∞ `complex_markdown`:** –°—Ç—Ä–æ–∫–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∞—è:
  * –í–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å H1 -\> H2 -\> H3 -\> H2 (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–±—Ä–æ—Å–∞ —Å—Ç–µ–∫–∞).
  * –ë–ª–æ–∫–∏ –∫–æ–¥–∞, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å `#` (–ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –ø–∞—Ä—Å–µ—Ä –Ω–µ –ø—É—Ç–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –≤ –∫–æ–¥–µ —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏).
  * –ö–∞—Ä—Ç–∏–Ω–∫–∏ —Å –ø–æ–¥–ø–∏—Å—è–º–∏ –∏ –±–µ–∑.
  * HTML-—Ç–µ–≥–∏ –≤–Ω—É—Ç—Ä–∏ Markdown (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º).

#### 2\. Unit-—Ç–µ—Å—Ç—ã –ü–∞—Ä—Å–µ—Ä–∞ (`unit/processing/parsers`)

–ó–¥–µ—Å—å –º—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º `MarkdownNodeParser` –≤ –∏–∑–æ–ª—è—Ü–∏–∏.

* **–¢–µ—Å—Ç –°—Ç–µ–∫–∞ –ó–∞–≥–æ–ª–æ–≤–∫–æ–≤:**
  * *–í—Ö–æ–¥:* `# A \n ## B \n —Ç–µ–∫—Å—Ç \n # C`
  * *–û–∂–∏–¥–∞–Ω–∏–µ:* –ß–∞–Ω–∫ —Å —Ç–µ–∫—Å—Ç–æ–º –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ `['A', 'B']`, –∞ —Å–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ (–ø–æ—Å–ª–µ C) ‚Äî —Ç–æ–ª—å–∫–æ `['C']`. –í–∞–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ 'B' –∏—Å—á–µ–∑–ª–æ –∏–∑ —Å—Ç–µ–∫–∞.
* **–¢–µ—Å—Ç –ó–∞—â–∏—Ç—ã –ö–æ–¥–∞:**
  * *–í—Ö–æ–¥:* –ë–ª–æ–∫ –∫–æ–¥–∞ –Ω–∞ 3000 —Å–∏–º–≤–æ–ª–æ–≤ (–±–æ–ª—å—à–µ chunk\_size).
  * *–û–∂–∏–¥–∞–Ω–∏–µ:* –ü–∞—Ä—Å–µ—Ä –¥–æ–ª–∂–µ–Ω –æ—Ç–¥–∞—Ç—å –µ–≥–æ –∫–∞–∫ —Å–µ–≥–º–µ–Ω—Ç —Ç–∏–ø–∞ `CODE`. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –Ω–∞—Ä–µ–∑–∫–∞ –∫–æ–¥–∞ ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞—Ä–µ–∑–∞–Ω –ø–æ —Å—Ç—Ä–æ–∫–∞–º, –∞ –Ω–µ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π.
* **–¢–µ—Å—Ç –ò–∑–≤–ª–µ—á–µ–Ω–∏—è –ê—Å—Å–µ—Ç–æ–≤:**
  * *–í—Ö–æ–¥:* `![–°—Ö–µ–º–∞](img/schema.png)` –∏ `<img src="video.mp4">`.
  * *–û–∂–∏–¥–∞–Ω–∏–µ:* –ü–∞—Ä—Å–µ—Ä –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –æ–±—ä–µ–∫—Ç—ã `AssetReference` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—É—Ç—è–º–∏.

#### 3\. Unit-—Ç–µ—Å—Ç—ã –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`unit/processing/context`)

–¢–µ—Å—Ç–∏—Ä—É–µ–º `HierarchicalContextStrategy`.

* **–¢–µ—Å—Ç –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:**
  * –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–π —á–∞–Ω–∫ —Å metadata `headers=['–ì–ª–∞–≤–∞ 1', '–í–≤–µ–¥–µ–Ω–∏–µ']`.
  * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã—Ö–æ–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `Document: ... \n Path: –ì–ª–∞–≤–∞ 1 > –í–≤–µ–¥–µ–Ω–∏–µ`.
* **–¢–µ—Å—Ç –ü—É—Å—Ç—ã—Ö –ó–∞–≥–æ–ª–æ–≤–∫–æ–≤:**
  * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –Ω–µ—Ç (–Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞), –ª–∏—à–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ `>` –Ω–µ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è.

#### 4\. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¢–µ—Å—Ç—ã –•—Ä–∞–Ω–∏–ª–∏—â–∞ (`integration/storage`)

–°–∞–º—ã–π –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–ª—è Peewee –∏ SQLite.

* **–¢–µ—Å—Ç JSON –ø–æ–ª—è:**
  * –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫ —Å –±–æ–≥–∞—Ç—ã–º–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (—Å–ø–∏—Å–æ–∫ –∞—Å—Å–µ—Ç–æ–≤, –≤–ª–æ–∂–µ–Ω–Ω—ã–µ —Å–ª–æ–≤–∞—Ä–∏).
  * –ß–∏—Ç–∞–µ–º –µ–≥–æ –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ –ë–î (`NoteChunk.get(...)`).
  * *Assert:* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ Peewee –¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–ª JSON –æ–±—Ä–∞—Ç–Ω–æ –≤ Python-—Å–ª–æ–≤–∞—Ä—å, –∞ –Ω–µ –≤–µ—Ä–Ω—É–ª —Å—Ç—Ä–æ–∫—É.
* **–¢–µ—Å—Ç –§–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–º (–ó–∞–¥–µ–ª –Ω–∞ –±—É–¥—É—â–µ–µ):**
  * –ü–æ–ø—Ä–æ–±—É–µ–º —Å–¥–µ–ª–∞—Ç—å SQL-–∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ Peewee, —Ñ–∏–ª—å—Ç—Ä—É—é—â–∏–π —á–∞–Ω–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö –≤ metadata –µ—Å—Ç—å –∫–ª—é—á `assets`. (–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π `json_extract` –≤ SQLite).

#### 5\. –¢–µ—Å—Ç—ã –ü–∞–π–ø–ª–∞–π–Ω–∞ (`integration/pipeline`)

–ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä.

* **–¢–µ—Å—Ç –†–æ—É—Ç–µ—Ä–∞ (Router Test):**
  * –ü–æ–¥–∞–µ–º –Ω–∞ –≤—Ö–æ–¥ `file.txt`. –ú–æ–∫–∞–µ–º —Å–ø–ª–∏—Ç—Ç–µ—Ä—ã. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–∑–≤–∞–Ω `SimpleSplitter`.
  * –ü–æ–¥–∞–µ–º `file.md`. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–∑–≤–∞–Ω `MarkdownSplitter`.
* **End-to-End –¢–µ—Å—Ç (Mocked AI):**
  * –ë–µ—Ä–µ–º —Ä–µ–∞–ª—å–Ω—ã–π MD —Ñ–∞–π–ª.
  * –ó–∞–ø—É—Å–∫–∞–µ–º `pipeline.run()`.
  * –ò—Å–ø–æ–ª—å–∑—É–µ–º `MockEmbedder` (—á—Ç–æ–±—ã –Ω–µ –ø–ª–∞—Ç–∏—Ç—å Google).
  * –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –ë–î –ø–æ—è–≤–∏–ª–∏—Å—å —á–∞–Ω–∫–∏, –∏ —É –Ω–∏—Ö –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –ø–æ–ª—è `meta_json`.

-----

### ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –£—Å–ø–µ—Ö–∞ –§–∞–∑—ã 4.1

1. –í—Å–µ —Å—Ç–∞—Ä—ã–µ —Ç–µ—Å—Ç—ã –∏–∑ –§–∞–∑—ã 3.1 –ø—Ä–æ—Ö–æ–¥—è—Ç (–∑–µ–ª–µ–Ω—ã–µ).
2. –ú—ã –º–æ–∂–µ–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –¥–æ–∫–∞–∑–∞—Ç—å, —á—Ç–æ –∏–µ—Ä–∞—Ä—Ö–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
3. –ú—ã –≤–∏–¥–∏–º –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –ë–î, —á—Ç–æ –ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏ –ª–µ–∂–∞—Ç –≤ JSON-–ø–æ–ª–µ.
4. –°–∏—Å—Ç–µ–º–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –Ω–∞ "–±–∏—Ç–æ–º" Markdown –∏–ª–∏ –ø—É—Å—Ç—ã—Ö —Ñ–∞–π–ª–∞—Ö.

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ —É –Ω–∞—Å –±—É–¥–µ—Ç **–∂–µ–ª–µ–∑–æ–±–µ—Ç–æ–Ω–Ω–æ–µ —è–¥—Ä–æ**, –≥–æ—Ç–æ–≤–æ–µ –∫ —Ç–æ–º—É, —á—Ç–æ–±—ã –º—ã –ø–æ–¥–∫–ª—é—á–∏–ª–∏ Gemini Vision –∏ –Ω–∞—á–∞–ª–∏ —Ä–µ–∞–ª—å–Ω–æ *—Å–º–æ—Ç—Ä–µ—Ç—å* —ç—Ç–∏ –∫–∞—Ä—Ç–∏–Ω–∫–∏ (–§–∞–∑–∞ 5).
