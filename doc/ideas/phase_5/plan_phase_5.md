# üó∫Ô∏è Phase 5: Async Batching & Key Management

**–¶–µ–ª—å:** –í–Ω–µ–¥—Ä–∏—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (50% —Å–∫–∏–¥–∫–∞) –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ API-–∫–ª—é—á–∞–º–∏.

**–ü—Ä–∏–Ω—Ü–∏–ø—ã:**

* **Safety First:** –ë–∞—Ç—á–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç *—Ç–æ–ª—å–∫–æ* –µ—Å–ª–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–ª—é—á.
* **Deferred Execution:** –ü–∞–π–ø–ª–∞–π–Ω –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É, –∞ —Å—Ç–∞–≤–∏—Ç –∑–∞–¥–∞—á–∏ –≤ –æ—á–µ—Ä–µ–¥—å.
* **Zero-Dependency:** –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–æ–π –∂–µ SQLite –±–∞–∑–µ.

-----

### 1\. –ü–æ–¥–º–æ–¥—É–ª—å –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ (`semantic_core/domain/auth.py`)

–ú—ã —É—Ö–æ–¥–∏–º –æ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö `config.py` –∫ –∏–Ω—ä–µ–∫—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–ó–∞–¥–∞—á–∞:**
–°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å `GoogleKeyring` (–∏–ª–∏ `ProvidersConfig`), –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç—å –ø–æ—Ç–æ–∫–∏ –±–∏–ª–ª–∏–Ω–≥–∞.

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**

* **–ö–ª–∞—Å—Å `GoogleKeyring` (Dataclass):**
  * `default_key`: (str) –û—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á.
  * `batch_key`: (Optional[str]) –ö–ª—é—á –¥–ª—è –º–∞—Å—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
* **–õ–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
  * –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –±–∞—Ç—á, –∞ `batch_key` —Ä–∞–≤–µ–Ω `None` ‚Äî –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å `ValueError("Batch operations require a dedicated API key")`.
  * –≠—Ç–æ –∑–∞—â–∏—Ç–∞ –æ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–∑-–∑–∞ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –ª–∏–º–∏—Ç–æ–≤ Free Tier.

-----

### 2\. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –°—Ö–µ–º—ã –ë–î (`infrastructure/storage/peewee/models.py`)

–ù–∞–º –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ "–ø–∞–∫–µ—Ç–æ–≤" –∏ —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞.

**–ó–∞–¥–∞—á–∞:**
–î–æ–±–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É `BatchJob` –∏ –æ–±–Ω–æ–≤–∏—Ç—å `ChunkModel`.

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**

1. **–ú–æ–¥–µ–ª—å `BatchJob`:**

      * `id`: UUID (Primary Key).
      * `google_job_id`: –°—Ç—Ä–æ–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `batches/123...`).
      * `status`: Enum/String (`CREATED`, `SUBMITTED`, `PROCESSING`, `COMPLETED`, `FAILED`).
      * `stats`: JSONField (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫: –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ/—É—Å–ø–µ—à–Ω–æ/–æ—à–∏–±–æ–∫).
      * `created_at`, `updated_at`.

2. **–ú–∏–≥—Ä–∞—Ü–∏—è `ChunkModel`:**

      * –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `embedding_status`: Enum (`READY`, `PENDING`, `FAILED`). Default: `READY`.
      * –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `batch_job`: ForeignKey –Ω–∞ `BatchJob` (nullable).
      * –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ `error_message`: Text (nullable).

3. **–£—Ç–∏–ª–∏—Ç–∞ –ú–∏–≥—Ä–∞—Ü–∏–∏ (`database.py`):**

      * –ù–∞–ø–∏—Å–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `ensure_schema_compatibility()`.
      * –û–Ω–∞ –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –∏ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Ö (`ALTER TABLE`), –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–µ.

-----

### 3\. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–∞—Ç—á–∏–Ω–≥–∞ (`infrastructure/google/batching`)

–ê–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–≤–æ–µ–≥–æ –∫–æ–¥–∞ –ø–æ–¥ –∑–∞–¥–∞—á—É —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.

**–ó–∞–¥–∞—á–∞:**
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å `GeminiBatchClient`, –∫–æ—Ç–æ—Ä—ã–π —É–º–µ–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å JSONL —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤.

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è:**

* **`create_embedding_job(chunks: List[ChunkDTO]) -> google_job_id`:**

    1. **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ JSONL:**
          * –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç —á–∞—Ç–∞, –º–µ—Ç–æ–¥ API: `models/text-embedding-004:embedContent`.
          * –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å—Ç—Ä–æ–∫–∏:

            ```json
            {
              "request": {
                "model": "models/text-embedding-004",
                "content": {"parts": [{"text": "Title: ... \n Content: ..."}]},
                "taskType": "RETRIEVAL_DOCUMENT"
              }
            }
            ```

          * `custom_id` (–∏–ª–∏ `key`) —Å—Ç—Ä–æ–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω `chunk.id`.
    2. **Upload:** –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ —á–µ—Ä–µ–∑ `genai.files.upload`.
    3. **Submit:** –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ `client.batches.create`.

* **`get_job_status(google_id) -> str`:**

  * –ü—Ä–æ—Å—Ç–∞—è –æ–±–µ—Ä—Ç–∫–∞ –Ω–∞–¥ `client.batches.get`.

* **`retrieve_results(google_id) -> Dict[chunk_id, bytes]`:**

  * –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å `SUCCEEDED`, —Å–∫–∞—á–∏–≤–∞–µ—Ç –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª.
  * –ü–∞—Ä—Å–∏—Ç JSONL.
  * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä (`values`), –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –≤ `bytes` (`struct.pack`).
  * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å `ID -> Blob`.
  * **–í–∞–∂–Ω–æ:** –£–¥–∞–ª—è–µ—Ç –≤—Ö–æ–¥–Ω–æ–π –∏ –≤—ã—Ö–æ–¥–Ω–æ–π —Ñ–∞–π–ª—ã –∏–∑ –æ–±–ª–∞–∫–∞ Google (Cleanup).

-----

### 4\. –ú–µ–Ω–µ–¥–∂–µ—Ä –û—á–µ—Ä–µ–¥–∏ (`core/batch_manager.py`)

–≠—Ç–æ "–ü—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è", –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ—Ä–≥–∞–µ—Ç —Ä—É–∫–∞–º–∏ (–∏–ª–∏ –∫—Ä–æ–Ω–æ–º).

**–ó–∞–¥–∞—á–∞:**
–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å `BatchManager`.

**–ú–µ—Ç–æ–¥—ã:**

1. **`flush_queue(min_size=10) -> batch_id`:**

      * SQL: `SELECT * FROM chunks WHERE embedding_status='PENDING' AND batch_job_id IS NULL`.
      * –ï—Å–ª–∏ –∑–∞–ø–∏—Å–µ–π \< `min_size`, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ—Ç (—á—Ç–æ–±—ã –Ω–µ –≥–æ–Ω—è—Ç—å –ø—É—Å—Ç—ã–µ –±–∞—Ç—á–∏), –µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω —Ñ–ª–∞–≥ `force=True`.
      * –í—ã–∑—ã–≤–∞–µ—Ç `BatchClient.create_embedding_job`.
      * –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å `BatchJob`.
      * **Mass Update:** –û–±–Ω–æ–≤–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ (—Å—Ç–∞–≤–∏—Ç `batch_job_id`, —Å—Ç–∞—Ç—É—Å `SUBMITTED`).

2. **`sync_status()`:**

      * SQL: –ù–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∂–æ–±—ã.
      * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤ Google.
      * –ï—Å–ª–∏ `COMPLETED`:
          * –°–∫–∞—á–∏–≤–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–∞.
          * **CRITICAL:** –í—ã–∑—ã–≤–∞–µ—Ç `store.bulk_update_vectors(vectors_dict)`. (–ù—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –º–µ—Ç–æ–¥ –≤ `VectorStore` —á–µ—Ä–µ–∑ raw SQL `executemany` –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏).
          * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã —á–∞–Ω–∫–æ–≤ –Ω–∞ `READY`.
          * –ó–∞–∫—Ä—ã–≤–∞–µ—Ç –¥–∂–æ–±—É.

-----

### 5\. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–∞–π–ø–ª–∞–π–Ω–∞ (`pipeline.py`)

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏ –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ç–æ–∫.

**–ó–∞–¥–∞—á–∞:**
–ù–∞—É—á–∏—Ç—å `IngestionPipeline` —Ä–∞–±–æ—Ç–∞—Ç—å –ª–µ–Ω–∏–≤–æ.

**–õ–æ–≥–∏–∫–∞ `ingest(doc, mode="auto")`:**

1. **Split:** –†–µ–∂–µ–º –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ —á–∞–Ω–∫–∏ (–∫–∞–∫ –≤ –§–∞–∑–µ 4).
2. **Context:** –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∞ (ContextStrategy).
3. **Decision:**
      * –ï—Å–ª–∏ `mode="sync"`: –í—ã–∑—ã–≤–∞–µ–º `Embedder` —Å—Ä–∞–∑—É -\> –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–µ–∫—Ç–æ—Ä –∏ —á–∞–Ω–∫.
      * –ï—Å–ª–∏ `mode="async"`:
          * –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫ –≤ –ë–î.
          * –ü–æ–ª–µ `embedding` = `None`.
          * –ü–æ–ª–µ `embedding_status` = `PENDING`.
          * **–í–∞–∂–Ω–æ:** –¢–µ–∫—Å—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º) –Ω—É–∂–Ω–æ –ª–∏–±–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å (–≤ `meta_json`), –ª–∏–±–æ —É–º–µ—Ç—å –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –≤ –º–æ–º–µ–Ω—Ç –±–∞—Ç—á–∏–Ω–≥–∞. *–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ `meta_json['_vector_source']`*, —á—Ç–æ–±—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

-----

### –ò—Ç–æ–≥–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º —Ä–∞–±–æ—Ç—ã (User Flow)

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞:**

    ```python
    keys = GoogleKeyring(default="...", batch="PAID_KEY")
    core = SemanticCore(keys=keys)
    ```

2. **–ò–º–ø–æ—Ä—Ç:**

    ```python
    # –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î, —Å—Ç–∞—Ç—É—Å PENDING
    core.ingest_file("book.md", mode="async") 
    ```

3. **–û–±—Ä–∞–±–æ—Ç–∫–∞:**

    ```python
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—É—Å–∫–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ö–æ—á–µ—Ç
    core.batch_manager.flush_queue() 
    ```

4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
    –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –≤–µ–∫—Ç–æ—Ä–∞ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ –±–∞–∑–µ, –∏ –ø–æ–∏—Å–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
