–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ä–∞–∑–≤–æ—Ä–æ—Ç. –ú—ã —Å—Ç—Ä–æ–∏–º **–±–∏–±–ª–∏–æ—Ç–µ–∫—É**, –∞ –Ω–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –∏–ª–∏ —Å–µ—Ä–≤–∏—Å. –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –º—ã –¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –º–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥—å—é, –Ω–æ –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º —Ñ–æ–Ω–æ–≤—ã–µ –ø–æ—Ç–æ–∫–∏ –±–µ–∑ –µ–≥–æ —è–≤–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã.

–ù–∏–∂–µ –¥–µ—Ç–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω **–§–∞–∑—ã 5: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ Batch Processing**.

-----

### üó∫Ô∏è –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: "–û—Ç–ª–æ–∂–µ–Ω–Ω–æ–µ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ" (Deferred Execution)

–ú—ã –≤–≤–æ–¥–∏–º –º–µ—Ö–∞–Ω–∏–∑–º, –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ (—Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤, –æ–ø–∏—Å–∞–Ω–∏–µ –≤–∏–¥–µ–æ) –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å –∏—Ö –ø–∞—á–∫–∞–º–∏ —á–µ—Ä–µ–∑ Batch API Google.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å:

1. `core.ingest(doc, mode='async')` ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏—Ç –≤ –æ—á–µ—Ä–µ–¥—å.
2. `core.batch_manager.process_queue()` ‚Äî —è–≤–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É.

-----

### üì¶ 1. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –°—Ö–µ–º—ã –î–∞–Ω–Ω—ã—Ö (`infrastructure/storage`)

–ù–∞–º –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–¥–∞—á –≤–Ω—É—Ç—Ä–∏ —Ç–æ–π –∂–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –≥–¥–µ –ª–µ–∂–∞—Ç –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–π (zero-dependency, –∫—Ä–æ–º–µ –ë–î).

#### –ê. –ú–æ–¥–µ–ª—å `BatchJob` (–¢–∞–±–ª–∏—Ü–∞ –ø–∞–∫–µ—Ç–æ–≤)

–ñ—É—Ä–Ω–∞–ª –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å Google Batch API.

* **–ü–æ–ª—è:**
  * `id` (UUID/Auto): –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π ID.
  * `external_id`: ID —Ä–∞–±–æ—Ç—ã –≤ Google (–Ω–∞–ø—Ä–∏–º–µ—Ä, `batch-123...`).
  * `job_type`: –¢–∏–ø —Ä–∞–±–æ—Ç—ã (`EMBEDDING`, `MEDIA_DESCRIPTION`).
  * `status`: –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (`CREATED` -\> `SUBMITTED` -\> `PROCESSING` -\> `COMPLETED` / `FAILED`).
  * `created_at`, `updated_at`.
  * `stats`: JSON-–ø–æ–ª–µ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ (—Å–∫–æ–ª—å–∫–æ –∑–∞–¥–∞—á –≤ –±–∞—Ç—á–µ, —Å–∫–æ–ª—å–∫–æ —É—Å–ø–µ—à–Ω–æ).

#### –ë. –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è `Chunk` (–∏ `MediaResource` –≤ –±—É–¥—É—â–µ–º)

–ß–∞–Ω–∫–∏ —Ç–µ–ø–µ—Ä—å –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å –±–µ–∑ –≤–µ–∫—Ç–æ—Ä–∞.

* **–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è:**
  * `embedding_status`: Enum (`READY`, `PENDING`, `FAILED`). –î–µ—Ñ–æ–ª—Ç: `READY` (–µ—Å–ª–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ) –∏–ª–∏ `PENDING` (–µ—Å–ª–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ).
  * `batch_job_id`: FK –Ω–∞ `BatchJob`. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≤ –∫–∞–∫–æ–º –ø–∞–∫–µ—Ç–µ —É–µ—Ö–∞–ª–∞ –∑–∞–¥–∞—á–∞.
  * `error_message`: –¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —á–∞–Ω–∫ —É–ø–∞–ª.

-----

### ‚öôÔ∏è 2. –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ë–∞—Ç—á–∏–Ω–≥–∞ (`infrastructure/google/batching`)

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è "–≥—Ä—è–∑–Ω–æ–π" —Ä–∞–±–æ—Ç—ã —Å Google File API –∏ Batch API.

#### –ê. –ö–ª–∞—Å—Å `GeminiBatchClient`

* **–ú–µ—Ç–æ–¥ `create_embedding_job(chunks: List[Chunk]) -> str`:**
    1. –§–æ—Ä–º–∏—Ä—É–µ—Ç JSONL-—Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç–∏ (–∏–ª–∏ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ).
    2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ JSONL: `{"request": {"model": "text-embedding-004", "content": ..., "taskType": "RETRIEVAL_DOCUMENT"}}`.
    3. –ö–ª—é—á (`key`) –≤ JSONL = `chunk_id`.
    4. –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª —á–µ—Ä–µ–∑ `genai.files.upload`.
    5. –°–æ–∑–¥–∞–µ—Ç Batch Job.
    6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç `google_job_id`.
* **–ú–µ—Ç–æ–¥ `get_job_status(job_id) -> JobState`:**
  * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ (Polling).
* **–ú–µ—Ç–æ–¥ `download_results(job_id) -> Dict[id, vector]`:**
  * –ï—Å–ª–∏ –≥–æ—Ç–æ–≤–æ, —Å–∫–∞—á–∏–≤–∞–µ—Ç JSONL —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
  * –ü–∞—Ä—Å–∏—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–æ–≤–∞—Ä—å `{chunk_id: vector_bytes}`.
  * –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª –∏–∑ Google Cloud (Cleanup).

-----

### üë∑ 3. –ú–µ–Ω–µ–¥–∂–µ—Ä –û—á–µ—Ä–µ–¥–∏ (`core/batch_manager.py`)

–≠—Ç–æ –ø—É–±–ª–∏—á–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–∑—ã–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞.

#### –ö–ª–∞—Å—Å `BatchManager`

–ü—Ä–∏–Ω–∏–º–∞–µ—Ç `VectorStore` –∏ `BatchClient`.

* **–ú–µ—Ç–æ–¥ `flush_queue()` (–û—Ç–ø—Ä–∞–≤–∫–∞):**

    1. –í—ã–±–∏—Ä–∞–µ—Ç –∏–∑ –ë–î –≤—Å–µ —á–∞–Ω–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING`, —É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç `batch_job_id`.
    2. –ï—Å–ª–∏ –∏—Ö –º–∞–ª–æ (–º–µ–Ω—å—à–µ –ª–∏–º–∏—Ç–∞ `min_batch_size`), –º–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ).
    3. –ì—Ä—É–ø–ø–∏—Ä—É–µ—Ç –∏—Ö.
    4. –í—ã–∑—ã–≤–∞–µ—Ç `client.create_embedding_job`.
    5. –°–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å `BatchJob` –≤ –ë–î –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏.
    6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ID —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±–∞—Ç—á–∞.

* **–ú–µ—Ç–æ–¥ `check_and_sync()` (–ü–æ–ª—É—á–µ–Ω–∏–µ):**

    1. –ù–∞—Ö–æ–¥–∏—Ç –≤ –ë–î –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ `BatchJob` (`SUBMITTED`, `PROCESSING`).
    2. –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å —É Google.
    3. –ï—Å–ª–∏ `COMPLETED`:
          * –°–∫–∞—á–∏–≤–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä–∞.
          * –í—ã–∑—ã–≤–∞–µ—Ç `store.update_vectors_bulk(results)`.
          * –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å `BatchJob` –Ω–∞ `COMPLETED`.
          * –ú–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å —á–∞–Ω–∫–æ–≤ –Ω–∞ `READY`.

-----

### üéπ 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–∞–π–ø–ª–∞–π–Ω–∞ (`pipeline.py`)

–£—á–∏–º `IngestionPipeline` —Ä–∞–±–æ—Ç–∞—Ç—å –ª–µ–Ω–∏–≤–æ.

#### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–∞ `ingest(document, mode='auto')`

* **–ü–∞—Ä–∞–º–µ—Ç—Ä `mode`:** `SYNC` (—Å—Ä–∞–∑—É) –∏–ª–∏ `ASYNC` (–æ—á–µ—Ä–µ–¥—å).
* **–õ–æ–≥–∏–∫–∞ ASYNC:**
    1. –°–ø–ª–∏—Ç—Ç–µ—Ä —Ä–µ–∂–µ—Ç —Ç–µ–∫—Å—Ç.
    2. –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∞.
    3. –ú—ã **–ù–ï** –≤—ã–∑—ã–≤–∞–µ–º `embedder`.
    4. –ú—ã —Å–æ—Ö—Ä–∞–Ω—è–µ–º —á–∞–Ω–∫ –≤ –ë–î:
          * `embedding` = `NULL`.
          * `embedding_status` = `PENDING`.
          * `meta_json` = `{'vector_text': '...'}` (–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –≤ –±–∞—Ç—á).

-----

### ‚úÖ –ò—Ç–æ–≥ –§–∞–∑—ã 5

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–æ–ª—É—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ Enterprise-—É—Ä–æ–≤–Ω—è, –æ—Å—Ç–∞–≤–∞—è—Å—å –ø—Ä–æ—Å—Ç–æ–π –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏.

**–°—Ü–µ–Ω–∞—Ä–∏–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (User Story):**

```python
# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
core = SemanticCore(...)

# 2. –ë—ã—Å—Ç—Ä—ã–π –∏–º–ø–æ—Ä—Ç (–±–µ–∑ —Ç–æ—Ä–º–æ–∑–æ–≤ –Ω–∞ —Å–µ—Ç—å)
for file in massive_folder:
    doc = Document(file)
    core.ingest(doc, mode='async') 
    # –≠—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ, —Ç–æ–ª—å–∫–æ –Ω–∞—Ä–µ–∑–∫–∞ –∏ –∑–∞–ø–∏—Å—å –≤ SQLite

print("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –í –æ—á–µ—Ä–µ–¥–∏ 5000 —á–∞–Ω–∫–æ–≤.")

# 3. –ó–∞–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–∫–æ–≥–¥–∞ —É–¥–æ–±–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é)
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –ø–æ–≤–µ—Å–∏—Ç—å —ç—Ç–æ –Ω–∞ Cron –∏–ª–∏ –∫–Ω–æ–ø–∫—É –≤ UI
core.batch_manager.flush_queue() 

# ... —Å–ø—É—Å—Ç—è –≤—Ä–µ–º—è ...

# 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
core.batch_manager.check_and_sync()
```

–≠—Ç–æ **–∏–¥–µ–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å** –º–µ–∂–¥—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –¥–µ–ª–∞–µ—Ç –Ω–∏—á–µ–≥–æ "–≤–æ–ª—à–µ–±–Ω–æ–≥–æ" –≤ —Ñ–æ–Ω–µ, –Ω–æ –¥–∞–µ—Ç –º–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –¥–µ–Ω–µ–≥ –∏ –≤—Ä–µ–º–µ–Ω–∏.

–ü—Ä–∏—Å—Ç—É–ø–∞–µ–º –∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ö–µ–º—ã –ë–î –¥–ª—è `BatchJob`?
