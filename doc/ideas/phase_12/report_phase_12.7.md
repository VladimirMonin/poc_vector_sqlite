# Phase 12.7: Search Score Math Fix - Report

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û  
**–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:** 2025-12-06  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-12-06  
**–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å:** Phase 12.6  

---

## üìã –ó–∞–¥–∞—á–∞

–ò—Å–ø—Ä–∞–≤–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –≤ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –ø–æ–∏—Å–∫–∞:

1. **RRF Score Normalization:** –°–∫–æ—Ä—ã 49% vs 48% –Ω–µ –¥–∞–≤–∞–ª–∏ —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Ç–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
2. **Type Filter Bug:** –ü—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Ç–∏–ø–∞–º –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π score 50%

---

## üîç –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ 1: –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å RRF scores

**–°–∏–º–ø—Ç–æ–º—ã:**
- –ó–∞–ø—Ä–æ—Å "–°–∞–Ω—Ç–∞" vs "–î–æ–º–∞—à–∫–∞": 49% vs 45% (—Ä–∞–∑–Ω–∏—Ü–∞ 4%)
- –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –≤—Ç–æ—Ä–æ—Å–æ—Ä—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Ä–∞–∑–Ω–∏—Ü—É –≤ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

**–ü—Ä–∏—á–∏–Ω–∞:**
- RRF –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ `k=60` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç TREC –¥–ª—è –±–æ–ª—å—à–∏—Ö –∫–æ—Ä–ø—É—Å–æ–≤)
- –§–æ—Ä–º—É–ª–∞: `score = 1/(60+rank)` –¥–∞–≤–∞–ª–∞ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
- Rank 1: `1/61 ‚âà 0.016` (49%)
- Rank 2: `1/62 ‚âà 0.016` (48%)

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Type Filter —Ä–∞–∑—Ä—É—à–∞–ª RRF ranking

**–°–∏–º–ø—Ç–æ–º—ã:**
```
–ü–æ–∏—Å–∫ "–°–∞–Ω—Ç–∞" —Å types=[text, code, image, audio]:

1. 50% - text (sample_article)
2. 50% - code (SQL schema)
3. 50% - image (cat photo)
4. 50% - audio (New Year greeting)
5. 33% - text
6. 33% - code
```

**–ü—Ä–∏—á–∏–Ω–∞:**
- –°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ–ª–∞–ª–∞ **4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞** (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Ç–∏–ø)
- –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –≤–æ–∑–≤—Ä–∞—â–∞–ª —Ç–æ–ø-N **—Å–≤–æ–µ–≥–æ —Ç–∏–ø–∞**
- –í –∫–∞–∂–¥–æ–º —Å–ø–∏—Å–∫–µ –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–º–µ–ª `rank=1` ‚Üí `50%`
- –ü–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è –ø–æ–ª—É—á–∞–ª–æ—Å—å 4 –ø–æ–∑–∏—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º score

---

## üõ†Ô∏è –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ò–∑–º–µ–Ω–µ–Ω–∏–µ RRF –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã k

**–§–∞–π–ª—ã:**
- `semantic_core/infrastructure/storage/peewee/adapter.py`
- `semantic_core/pipeline.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
```python
# OLD
def _hybrid_search(..., k: int = 60):

# NEW  
def _hybrid_search(..., k: int = 1):
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
# k=1 —Ñ–æ—Ä–º—É–ª–∞: score = 1/(1+rank)
Rank 1 (both): 1/2 + 1/2 = 1.0  ‚Üí 100%
Rank 1 (one):  1/2 = 0.5         ‚Üí 50%
Rank 2:        1/3 ‚âà 0.33        ‚Üí 33%
Rank 3:        1/4 = 0.25        ‚Üí 25%
```

**–ú–µ—Ç—Ä–∏–∫–∏:**
- –†–∞–∑–±—Ä–æ—Å —Ç–æ–ø-2: **17%** (–±—ã–ª–æ 1%)
- –¢–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç: **50%** (–∏–ª–∏ 100% –µ—Å–ª–∏ –≤ –æ–±–æ–∏—Ö —Å–ø–∏—Å–∫–∞—Ö)
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ `min_score=40%` –æ—Ç—Å–µ–∫–∞–µ—Ç –≤—Å–µ –∫—Ä–æ–º–µ —Ç–æ–ø-1

### 2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Type Filter

**–§–∞–π–ª:** `examples/flask_app/app/services/search_service.py`

**–°—Ç–∞—Ä–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ù–ï–ü–†–ê–í–ò–õ–¨–ù–û):**
```python
if chunk_types:
    for chunk_type_ui in chunk_types:
        # 4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞!
        type_results = core.search_chunks(
            query=query,
            chunk_type_filter=chunk_type_filter
        )
        results.extend(type_results)
```

**–ù–æ–≤–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (–ü–†–ê–í–ò–õ–¨–ù–û):**
```python
# 1. –û–î–ò–ù –æ–±—â–∏–π –ø–æ–∏—Å–∫
chunk_results = core.search_chunks(
    query=query,
    limit=limit * 4 if chunk_types else limit,
)

# 2. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ
all_results = [_chunk_result_to_item(r) for r in chunk_results]

# 3. –§–∏–ª—å—Ç—Ä—É–µ–º –ü–û–°–õ–ï –ø–æ–ª—É—á–µ–Ω–∏—è
if chunk_types:
    allowed_types = set()
    for chunk_type_ui in chunk_types:
        allowed_types.update(CHUNK_TYPE_FILTER_MAP[chunk_type_ui])
    results = [r for r in all_results if r.chunk_type in allowed_types]
```

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ –º–∞–ø–ø–∏–Ω–≥–∞:**
```python
# OLD (—Å—Ç—Ä–æ–∫–∏)
CHUNK_TYPE_FILTER_MAP = {
    "text": "text",
    "code": "code",
}

# NEW (—Å–ø–∏—Å–∫–∏)
CHUNK_TYPE_FILTER_MAP = {
    "text": ["text"],
    "code": ["code"],
    "image": ["image_ref"],
    "audio": ["audio_ref"],
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```
–ü–æ–∏—Å–∫ "–°–∞–Ω—Ç–∞" —Å types=[text, code, image, audio]:

1. 33% - audio (New Year greeting)    ‚Üê rank 1 globally
2. 25% - text (sample_article)         ‚Üê rank 2 globally
3. 20% - text (homework)               ‚Üê rank 3 globally
4. 16% - text (flexbox task)           ‚Üê rank 4 globally
5. 14% - audio (module demo)           ‚Üê rank 5 globally
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª:** `examples/flask_app/tests/test_santa_search.py`

**–ü—Ä–æ–≤–µ—Ä–∫–∏:**
```python
def test_santa_search_chunks(app, client):
    results = service.search("–ù–æ–≤—ã–π –≥–æ–¥", mode="hybrid", limit=20)
    
    # 1. –†–∞–∑–±—Ä–æ—Å >= 10%
    scores = [r.score_percent for r in results[:5]]
    assert (max(scores) - min(scores)) >= 10
    
    # 2. –¢–æ–ø >= 30%
    assert max(scores) >= 30
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```bash
$ pytest tests/test_santa_search.py -v
test_santa_search_chunks PASSED
test_santa_search_documents PASSED
```

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –¥–æ/–ø–æ—Å–ª–µ

| –ú–µ—Ç—Ä–∏–∫–∞ | –î–æ (k=60) | –ü–æ—Å–ª–µ (k=1) | –£–ª—É—á—à–µ–Ω–∏–µ |
| :--- | :--- | :--- | :--- |
| –†–∞–∑–±—Ä–æ—Å —Ç–æ–ø-2 | 1% | 17% | **+16pp** |
| –¢–æ–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç | 49% | 50-100% | –ò–Ω—Ç—É–∏—Ç–∏–≤–Ω–µ–µ |
| –§–∏–ª—å—Ç—Ä `min_score=40%` | –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç | –û—Ç—Å–µ–∫–∞–µ—Ç —Ç–æ–ø-1 | ‚úÖ |
| Type filter bug | 4√ó50% | 33%‚Üí14% | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω |

---

## üîë –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ

1. **RRF k=1:** –ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π ranking –¥–ª—è –º–∞–ª—ã—Ö –∫–æ—Ä–ø—É—Å–æ–≤ (–ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π)
2. **Filter after ranking:** –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º **–ø–æ—Å–ª–µ** RRF –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
3. **Single query:** –û–¥–∏–Ω –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å –≤–º–µ—Å—Ç–æ N –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ —Ç–∏–ø–∞–º

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ

1. **Mode-aware normalization:** –ö–∞–∂–¥—ã–π —Ä–µ–∂–∏–º (vector/fts/hybrid) –∏–º–µ–µ—Ç —Å–≤–æ—é —Ñ–æ—Ä–º—É–ª—É
2. **Test coverage:** –†–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –±–∞–≥ –Ω–µ –≤–µ—Ä–Ω—ë—Ç—Å—è
3. **Documentation:** –û–±–Ω–æ–≤–ª—ë–Ω –≤—ã–ø—É—Å–∫ 70 —Å –¥–µ—Ç–∞–ª—å–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –ø—Ä–æ–±–ª–µ–º—ã

---

## üìÅ –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### Core
- `semantic_core/infrastructure/storage/peewee/adapter.py` ‚Äî k=1, _hybrid_search_chunks
- `semantic_core/pipeline.py` ‚Äî k=1 defaults

### Flask App
- `examples/flask_app/app/services/search_service.py` ‚Äî type filter fix, CHUNK_TYPE_FILTER_MAP
- `examples/flask_app/app/routes/search.py` ‚Äî —É–¥–∞–ª—ë–Ω –¥—É–±–ª–∏–∫–∞—Ç –∫–æ–¥–∞

### Tests
- `examples/flask_app/tests/test_santa_search.py` ‚Äî –Ω–æ–≤—ã–π —Ç–µ—Å—Ç

### Documentation
- `doc/architecture/70_search_score_normalization.md` ‚Äî –æ–±–Ω–æ–≤–ª—ë–Ω —Å Phase 12.7 –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

Phase 12.7 –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

1. **Adaptive multiplier:** `limit * len(chunk_types)` –≤–º–µ—Å—Ç–æ `limit * 4`
2. **FTS normalization:** –£–ª—É—á—à–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é BM25 rank –¥–ª—è —á–∏—Å—Ç–æ–≥–æ FTS —Ä–µ–∂–∏–º–∞
3. **Performance profiling:** –ò–∑–º–µ—Ä–∏—Ç—å overhead –æ—Ç `limit * 4` –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç

- [x] –ò–∑–º–µ–Ω—ë–Ω k —Å 60 –Ω–∞ 1
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω type filter bug
- [x] –£–¥–∞–ª—ë–Ω –¥—É–±–ª–∏–∫–∞—Ç –∫–æ–¥–∞
- [x] –°–æ–∑–¥–∞–Ω —Ä–µ–≥—Ä–µ—Å—Å–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–≤—ã–ø—É—Å–∫ 70)
- [x] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
- [x] –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –∫–æ–º–º–∏—Ç—ã —Å–¥–µ–ª–∞–Ω—ã

**Phase 12.7 ‚úÖ DONE**
