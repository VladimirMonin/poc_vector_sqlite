# üó∫Ô∏è Master Plan: Semantic Core Library

–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –ø—Ä–µ–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞ –≤ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ –º—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞.

### **–§–∞–∑–∞ 1: –§—É–Ω–¥–∞–º–µ–Ω—Ç –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã (Core & Contracts)**
*–¶–µ–ª—å: –†–∞–∑–≤—è–∑–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–π.*
1.  **Domain DTOs:** –°–æ–∑–¥–∞–Ω–∏–µ —á–∏—Å—Ç—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –¥–∞–Ω–Ω—ã—Ö `Document`, `Chunk`, `SearchResult`, –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ ORM.
2.  **Interfaces:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –±–∞–∑–æ–≤—ã—Ö –∫–ª–∞—Å—Å–æ–≤:
    * `VectorStore` (–ë–î-–∞–≥–Ω–æ—Å—Ç–∏–∫).
    * `Embedder` (AI-–∞–≥–Ω–æ—Å—Ç–∏–∫).
    * `TextSplitter` (–õ–æ–≥–∏–∫–∞ –Ω–∞—Ä–µ–∑–∫–∏).
    * `ContextStrategy` (–õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞).
3.  **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ `domain`, `interfaces`, `infrastructure`, `processing`.

### **–§–∞–∑–∞ 2: –°–ª–æ–π –•—Ä–∞–Ω–µ–Ω–∏—è (Storage Implementation)**
*–¶–µ–ª—å: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–∏–∑–∏—á–µ—Å–∫–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±–∞–∑–µ SQLite.*
1.  **Peewee Adapter:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `VectorStoreInterface` —á–µ—Ä–µ–∑ Peewee.
2.  **Schema Definition:** –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π `Parent` (–∏—Å—Ö–æ–¥–Ω–∏–∫–∏) –∏ `Child` (—á–∞–Ω–∫–∏).
3.  **Extensions:** –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è `sqlite-vec` –∏ `FTS5` —á–µ—Ä–µ–∑ —Å—ã—Ä–æ–π SQL –≤–Ω—É—Ç—Ä–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `Hybrid Search (RRF)` —á–µ—Ä–µ–∑ CTE –∑–∞–ø—Ä–æ—Å—ã.

### **–§–∞–∑–∞ 3: –¢–µ–∫—Å—Ç–æ–≤—ã–π –ü–∞–π–ø–ª–∞–π–Ω (Text MVP)**
*–¶–µ–ª—å: –°–æ–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–∏–π –∫–æ–Ω–≤–µ–π–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞.*
1.  **Gemini Embedder:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞ –¥–ª—è Google GenAI SDK (–º–æ–¥–µ–ª—å `text-embedding-004`). –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MRL (768 dim).
2.  **Simple Splitter:** –ü–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏ –Ω–∞—Ä–µ–∑–∫–∏ –ø–æ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫ –∏ —Ä–∞–∑–º–µ—Ä—É.
3.  **Orchestrator:** –ö–ª–∞—Å—Å `SemanticCore` (–§–∞—Å–∞–¥), —Å–≤—è–∑—ã–≤–∞—é—â–∏–π –°–ø–ª–∏—Ç—Ç–µ—Ä, –≠–º–±–µ–¥–¥–µ—Ä –∏ –ë–∞–∑—É –≤ –µ–¥–∏–Ω—ã–π –º–µ—Ç–æ–¥ `ingest()`.

### **–§–∞–∑–∞ 3.1: –°—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏—è –∏ –¢–µ—Å—Ç—ã (Safety Net)**
*–¶–µ–ª—å: –°–æ–∑–¥–∞—Ç—å –Ω–∞–¥–µ–∂–Ω—É—é —Å—Ä–µ–¥—É –¥–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞.*
1.  **Mocking:** –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–µ–π–∫–æ–≤—ã—Ö —ç–º–±–µ–¥–¥–µ—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –±–µ–∑ –∑–∞—Ç—Ä–∞—Ç –¥–µ–Ω–µ–≥.
2.  **Refactoring:** –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤ –Ω–∞ Unit (–±—ã—Å—Ç—Ä—ã–µ) –∏ Integration (–º–µ–¥–ª–µ–Ω–Ω—ã–µ).
3.  **Coverage:** –ü–æ–∫—Ä—ã—Ç–∏–µ –±–∞–∑–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø–æ–∏—Å–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.

### **–§–∞–∑–∞ 4: –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ü–∞—Ä—Å–∏–Ω–≥ (Smart Markdown)**
*–¶–µ–ª—å: –ù–∞—É—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –ø–æ–Ω–∏–º–∞—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.*
1.  **Markdown Parser:** –í–Ω–µ–¥—Ä–µ–Ω–∏–µ `markdown-it-py` (AST). –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –∏ —Å—Å—ã–ª–æ–∫ –Ω–∞ –º–µ–¥–∏–∞.
2.  **Breadcrumbs:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `HierarchicalContextStrategy` ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ ("–ì–ª–∞–≤–∞ 1 > –í–≤–µ–¥–µ–Ω–∏–µ") –≤ —Ç–µ–∫—Å—Ç –≤–µ–∫—Ç–æ—Ä–∞.
3.  **Metadata Storage:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ JSON-–ø–æ–ª–µ–π –≤ SQLite –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–æ–≤.

### **–§–∞–∑–∞ 4.1: –¢–µ—Å—Ç—ã –ü–∞—Ä—Å–∏–Ω–≥–∞**
*–¶–µ–ª—å: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å–ª–æ–∂–Ω–æ–π –ª–æ–≥–∏–∫–∏ AST.*
1.  –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–µ–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤.
2.  –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω–æ—Å—Ç–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞.
3.  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –∞—Å—Å–µ—Ç—ã (–∫–∞—Ä—Ç–∏–Ω–∫–∏/–≤–∏–¥–µ–æ).

### **–§–∞–∑–∞ 5: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –∏ Batch Processing (Economy)**
*–¶–µ–ª—å: –°–Ω–∏–∑–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ 50% –∏ —É–±—Ä–∞—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º –∏–º–ø–æ—Ä—Ç–µ.*
1.  **Queue Architecture:** –¢–∞–±–ª–∏—Ü–∞ `BatchJob` –∏ —Å—Ç–∞—Ç—É—Å—ã —á–∞–Ω–∫–æ–≤ (`PENDING`, `PROCESSING`).
2.  **Batch Client:** –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è JSONL –∏ —Ä–∞–±–æ—Ç—ã —Å Google Batch API.
3.  **Deferred Execution:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–∂–∏–º–∞ `mode='async'` –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ç—Ä–∏–≥–≥–µ—Ä–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é.

### **–§–∞–∑–∞ 5.1: E2E –¢–µ—Å—Ç—ã –ë–∞—Ç—á–∏–Ω–≥–∞**
*–¶–µ–ª—å: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º Google Cloud.*
1.  –†–µ–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –Ω–∞ –∫–æ—Ä–æ—Ç–∫–∏—Ö –æ—á–µ—Ä–µ–¥—è—Ö (2-3 —ç–ª–µ–º–µ–Ω—Ç–∞).
2.  –ü—Ä–æ–≤–µ—Ä–∫–∞ State Machine (–ø–µ—Ä–µ—Ö–æ–¥—ã —Å—Ç–∞—Ç—É—Å–æ–≤).
3.  –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ JSONL.

### **–§–∞–∑–∞ 6: –ú—É–ª—å—Ç–∏–º–æ–¥–∞–ª—å–Ω–æ—Å—Ç—å –∏ OCR (Vision)**
*–¶–µ–ª—å: –ù–∞—É—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É "–≤–∏–¥–µ—Ç—å" –∏ —á–∏—Ç–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã.*
1.  **Vision Strategy:** –ü–∞—Ç—Ç–µ—Ä–Ω –°—Ç—Ä–∞—Ç–µ–≥–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–≤–∏–∂–∫–∞ (`GeneralDescription` vs `DocumentStructure`).
2.  **Gemini Vision:** –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –¥–ª—è –æ–ø–∏—Å–∞–Ω–∏—è —Ñ–æ—Ç–æ –∏ —Å—Ö–µ–º.
3.  **OCR Integration:** –ó–∞–≥–ª—É—à–∫–∏ (–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è) –¥–ª—è Tesseract/DocTR –¥–ª—è —Å–∫–∞–Ω–æ–≤.
4.  **Content Router:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞ –∏ –≤—ã–±–æ—Ä –Ω—É–∂–Ω–æ–≥–æ –ø–∞–π–ø–ª–∞–π–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---
