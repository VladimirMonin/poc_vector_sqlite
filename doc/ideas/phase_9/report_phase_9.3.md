# Phase 9.3: Slash Commands — Детальный отчёт

## Обзор фазы

Фаза 9.3 посвящена созданию системы slash-команд для интерактивного RAG-чата. Это важный шаг в развитии CLI-интерфейса, превращающий простой вопрос-ответный режим в полноценную интерактивную среду с командами управления, настройками и инструментами анализа.

### Цели фазы

1. **Создать архитектуру slash-команд** — базовые классы и паттерны для расширяемой системы команд
2. **Реализовать ядро команд** — базовые (/help, /quit, /clear), поисковые (/search, /sources), настроечные (/model, /context)
3. **Интегрировать в REPL** — роутинг команд в существующий цикл чата
4. **Покрыть тестами** — unit-тесты для всех компонентов

### Результаты в цифрах

| Метрика | Значение |
|---------|----------|
| Новые файлы | 12 |
| Строк кода | ~1,200 |
| Новые тесты | 65 |
| Общее тестов | 765 |
| Атомарных коммитов | 5 |
| Slash-команд | 12 |

---

## Архитектурные решения

### Паттерн Command

Для slash-команд выбран классический паттерн Command с несколькими модификациями под специфику интерактивного чата.

**Базовый класс BaseSlashCommand** определяет контракт:

- `name` — имя команды без слеша
- `description` — краткое описание для /help
- `aliases` — альтернативные имена (например, /q для /quit)
- `usage` — примеры использования
- `execute(ctx, args)` — основная логика

**SlashResult** — результат выполнения команды:

- `action` — что делать после (CONTINUE, EXIT, CLEAR)
- `message` — сообщение для вывода (опционально)
- `add_to_context` — текст для добавления в контекст LLM (будущее расширение)

**SlashAction** — enum действий:

- `CONTINUE` — продолжить REPL (по умолчанию)
- `EXIT` — выйти из чата
- `CLEAR` — очистить экран

### ChatContext как связующее звено

Ключевое архитектурное решение — создание ChatContext как единой точки доступа ко всем компонентам чата. Это dataclass, содержащий:

- `console` — Rich Console для вывода
- `core` — SemanticCore для поиска
- `rag` — RAGEngine для вопрос-ответа
- `llm` — LLM провайдер
- `history_manager` — менеджер истории
- `last_result` — результат последнего RAG-запроса
- `search_mode`, `context_chunks`, `temperature` — настройки
- `extra_context` — расширяемый словарь для дополнительных данных

Такой подход позволяет командам иметь полный доступ к состоянию чата без передачи множества отдельных параметров.

### SlashCommandHandler как роутер

SlashCommandHandler реализует паттерн Registry:

- `register(command)` — регистрация команды по имени и алиасам
- `get_command(name)` — получение команды
- `list_commands()` — уникальный список без дублей
- `handle(input, ctx)` — парсинг и выполнение

Парсинг простой: первое слово после "/" — имя команды, остальное — аргументы.

---

## Реализованные команды

### Базовые команды (basic.py)

**HelpCommand** (/help, /h, /?)

- Особенность: принимает handler в конструкторе для доступа к списку команд
- Выводит таблицу всех зарегистрированных команд с описаниями

**ClearCommand** (/clear, /cls)

- Возвращает SlashAction.CLEAR
- Обработка очистки выполняется в REPL

**QuitCommand** (/quit, /q, /exit)

- Возвращает SlashAction.EXIT
- Также поддерживаются устаревшие команды без слеша (exit, quit)

**TokensCommand** (/tokens)

- Показывает статистику токенов из history_manager
- Количество сообщений, общий размер, информация о сжатии

**HistoryCommand** (/history)

- Показывает последние сообщения из истории
- Полезно для понимания контекста разговора

**CompressCommand** (/compress)

- Принудительное сжатие истории через LLM
- Интеграция с AdaptiveWithCompression из Phase 9.2

### Поисковые команды (search.py)

**SearchCommand** (/search, /s)

- Выполняет поиск по базе знаний
- Использует текущий search_mode из контекста
- Результаты выводятся в виде таблицы

**SearchModeCommand** (/search-mode, /mode)

- Без аргументов: показывает текущий режим
- С аргументом: меняет режим (vector, fts, hybrid)
- Валидация допустимых значений

**SourcesCommand** (/sources, /src)

- Показывает источники последнего ответа
- Работает с last_result из контекста
- Поддерживает full_docs и chunk режимы

**SourceCommand** (/source)

- Показывает полный текст конкретного источника по номеру
- Использует Rich Panel для красивого вывода
- Поддержка Markdown форматирования

### Команды настроек (settings.py)

**ModelCommand** (/model, /m)

- Без аргументов: показывает текущую модель
- С аргументом: меняет модель LLM "на лету"
- Создаёт новый GeminiLLMProvider и обновляет ctx.llm и ctx.rag._llm

**ContextCommand** (/context, /ctx)

- Управление количеством чанков контекста
- Валидация: 1-20
- Обновляет ctx.context_chunks и ctx.rag._context_chunks

**TemperatureCommand** (/temperature, /temp)

- Управление температурой генерации
- Валидация: 0.0-2.0
- Пока не зарегистрирована в chat.py (дополнительная)

---

## Интеграция в REPL

### Изменения в chat.py

Основной REPL цикл был расширен для поддержки slash-команд:

1. **Инициализация** — создание ChatContext и SlashCommandHandler
2. **Регистрация** — добавление всех 12 команд (HelpCommand требует handler)
3. **Роутинг** — проверка `query.startswith("/")` перед RAG
4. **Обработка результата** — действия в зависимости от SlashAction
5. **Сохранение last_result** — для работы /sources и /source

### Проблема сигнатуры ChatContext

При интеграции возникло несоответствие: изначально я создавал ChatContext с параметром `settings={}`, но реальный класс имеет отдельные поля (`search_mode`, `context_chunks`, `temperature`) и `extra_context` для расширений.

Решение: переписал создание ChatContext с правильными параметрами и использую `extra_context` для хранения дополнительных настроек (_show_sources, _full_docs, _max_tokens, _model).

---

## Столкнувшиеся проблемы

### 1. Конфликт с LogRecord в Python logging

**Проблема**: При логировании с параметрами `name=` и `args=` возникала ошибка:

```
KeyError: "Attempt to overwrite 'name' in LogRecord"
```

Python logging резервирует эти имена для внутреннего использования.

**Решение**: Переименовал параметры:

- `name` → `cmd_name`
- `args` → `cmd_args`

Также исправил аналогичные проблемы в Gemini анализаторах, где `trace_ai()` вызывался неправильно.

### 2. Неправильная сигнатура trace_ai

**Проблема**: Метод `trace_ai()` в SemanticLogger требует `prompt` как первый позиционный аргумент, но в нескольких местах использовались только keyword аргументы.

**Решение**: Исправил все вызовы в:

- embedder.py
- audio_analyzer.py
- image_analyzer.py
- video_analyzer.py

### 3. SlashAction.QUIT vs SlashAction.EXIT

**Проблема**: В тестах использовал `SlashAction.QUIT`, но в реальном enum определён `SlashAction.EXIT`.

**Решение**: Привёл в соответствие все тесты к реальному API.

### 4. MagicMock вместо реальных данных

**Проблема**: Тесты для SourcesCommand и SourceCommand падали, потому что MagicMock не имел нужных атрибутов (`content`, `full_docs`).

**Решение**: Расширил фикстуры моков:

- Добавил `content` с реальным текстом
- Добавил `full_docs = False`
- Добавил `chunk_id`, `parent_doc_id`

### 5. Тесты проверяли message вместо console.print

**Проблема**: Многие команды выводят результат через `ctx.console.print()`, а не возвращают в `result.message`.

**Решение**: Изменил assertions:

- Вместо `assert result.message is not None`
- Используем `mock_context.console.print.assert_called()`

---

## Тестирование

### Структура тестов

Создана новая директория `tests/unit/cli/chat/` с четырьмя модулями:

**test_slash_handler.py** (22 теста)

- TestSlashCommandHandlerRegistration — регистрация команд
- TestSlashCommandHandlerParsing — парсинг ввода
- TestSlashCommandHandlerRouting — роутинг и обработка
- TestSlashResult — базовый класс результата
- TestSlashAction — enum действий

**test_basic_commands.py** (17 тестов)

- TestHelpCommand — справка
- TestClearCommand — очистка экрана
- TestQuitCommand — выход
- TestTokensCommand — статистика токенов
- TestHistoryCommand — история
- TestCompressCommand — сжатие

**test_search_commands.py** (17 тестов)

- TestSearchCommand — поиск
- TestSearchModeCommand — смена режима
- TestSourcesCommand — список источников
- TestSourceCommand — детали источника

**test_settings_commands.py** (11 тестов)

- TestModelCommand — смена модели
- TestContextCommand — размер контекста

### Особенности тестирования

1. **Моки для ChatContext** — создаём полноценные моки с нужными атрибутами
2. **Проверка side effects** — команды часто выводят через console.print
3. **Изолированность** — каждый тест независим, использует свои фикстуры
4. **Покрытие edge cases** — пустые аргументы, невалидные значения, отсутствующие данные

---

## Атомарные коммиты

Фаза завершена пятью атомарными коммитами:

1. **a7e2e07** `feat: Добавлена система slash-команд для чата`
   - Базовые классы и все команды
   - 881 insertion, 7 files

2. **8b5673a** `bugfix: Исправлены вызовы trace_ai в Gemini анализаторах`
   - Исправление сигнатуры логгера
   - 4 files changed

3. **f3b4dbf** `feat: Расширены экспорты slash-команд и исправлен логгер`
   - Расширение **init**.py
   - Переименование конфликтующих переменных

4. **8c45c55** `feat: Интегрирован SlashCommandHandler в REPL чата`
   - Полная интеграция в chat.py
   - 118 insertions

5. **ea35ade** `test: Добавлены unit-тесты для slash-команд (65 тестов)`
   - Все тесты для slash-системы
   - 944 insertions

---

## Уроки и выводы

### Что работает хорошо

1. **Command Pattern** — отличный выбор для расширяемой системы команд
2. **ChatContext как единый контейнер** — упрощает доступ к состоянию
3. **Алиасы команд** — пользователи могут использовать привычные сокращения
4. **Rich для вывода** — красивые таблицы и панели

### Что можно улучшить

1. **Автодополнение команд** — пока не реализовано
2. **Валидация аргументов** — сейчас ручная в каждой команде
3. **Плагинная система** — возможность добавлять команды без изменения кода
4. **Персистентность настроек** — сохранение между сессиями

### Технический долг

1. Переименование переменных из-за конфликтов с logging — признак того, что наш логгер требует доработки списка зарезервированных имён
2. Дублирование логики получения настроек из extra_context — стоит добавить методы-хелперы

---

## Связь с другими фазами

### Зависимости от предыдущих фаз

- **Phase 9.0**: RAGEngine для /search и основного цикла
- **Phase 9.1**: ChatHistoryManager для /tokens, /history
- **Phase 9.2**: ContextCompressor для /compress

### Подготовка к следующим фазам

Система slash-команд создаёт основу для:

- Phase 9.4: Streaming — /stream для потокового вывода
- Phase 9.5: Multi-turn refinement — /refine, /clarify
- Будущее: /export, /save, /load для сохранения сессий

---

## Заключение

Phase 9.3 успешно добавила систему slash-команд в RAG-чат. Создана расширяемая архитектура на базе Command Pattern, реализовано 12 команд для управления чатом, поиска и настроек. Интеграция прошла с несколькими техническими сложностями (конфликты имён в logging, несоответствие сигнатур), которые были успешно разрешены.

Система покрыта 65 unit-тестами, общее количество тестов проекта достигло 765. Фаза завершена пятью атомарными коммитами с чёткой границей ответственности каждого.

Slash-команды значительно улучшают UX интерактивного чата, давая пользователю контроль над поиском, настройками и анализом результатов без выхода из сессии.
