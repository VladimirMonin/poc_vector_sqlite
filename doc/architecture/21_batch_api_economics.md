# üí∞ Google Batch API: 50% —ç–∫–æ–Ω–æ–º–∏–∏ –Ω–∞ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

> –ü–æ—á–µ–º—É –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–æ–∏—Ç –≤ 2 —Ä–∞–∑–∞ –¥–µ—à–µ–≤–ª–µ

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Google Batch API** ‚Äî —ç—Ç–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π endpoint Gemini API –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–æ–≤ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–º –ø–æ–ª—É—á–µ–Ω–∏–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –í–º–µ—Å—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å –∑–∞–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥—å –∏ –ø–æ–ª—É—á–∞–µ—à—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —á–µ—Ä–µ–∑ 10-30 –º–∏–Ω—É—Ç.

–ü—Ä–æ—Å—Ç–∞—è –∏–¥–µ—è: **–º–µ–Ω—å—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç = –º–µ–Ω—å—à–µ —Ü–µ–Ω–∞**.

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

**–ü—Ä–æ–±–ª–µ–º–∞: –í—ã—Å–æ–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏**

–û–±—ã—á–Ω—ã–π Gemini API (`embed_content`) —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∂–∏–º–µ "request-response":

```
–¢—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —Ç–µ–∫—Å—Ç ‚Üí Google —Å—Ä–∞–∑—É –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä
```

**–¶–µ–Ω–∞:** $0.025 –∑–∞ 1 –º–∏–ª–ª–∏–æ–Ω —Ç–æ–∫–µ–Ω–æ–≤.

–î–ª—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –∏–∑ 10,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (avg 500 —Ç–æ–∫–µ–Ω–æ–≤):

```
10,000 √ó 500 = 5M —Ç–æ–∫–µ–Ω–æ–≤
5M √ó $0.025 = $125
```

–ï—Å–ª–∏ –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—à—å –±–∞–∑—É —Ä–∞–∑ –≤ –º–µ—Å—è—Ü ‚Üí **$1,500 –≤ –≥–æ–¥ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–µ–∫—Ç–æ—Ä—ã**.

---

**–†–µ—à–µ–Ω–∏–µ: Batch API —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π**

Google –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç: "–ï—Å–ª–∏ —Ç—ã –≥–æ—Ç–æ–≤ –ø–æ–¥–æ–∂–¥–∞—Ç—å ‚Äî –ø–æ–ª—É—á–∏—à—å —Å–∫–∏–¥–∫—É 50%".

**–¶–µ–Ω–∞:** $0.0125 –∑–∞ 1 –º–∏–ª–ª–∏–æ–Ω —Ç–æ–∫–µ–Ω–æ–≤.

–¢–∞ –∂–µ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ Batch API:

```
5M √ó $0.0125 = $62.50
```

**–≠–∫–æ–Ω–æ–º–∏—è: $62.50 –≤ –º–µ—Å—è—Ü, $750 –≤ –≥–æ–¥!**

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –û–±—ã—á–Ω—ã–π API (Sync)

```mermaid
sequenceDiagram
    participant App
    participant Gemini
    
    App->>Gemini: embed_content("text 1")
    Gemini-->>App: vector 1 (200ms)
    
    App->>Gemini: embed_content("text 2")
    Gemini-->>App: vector 2 (200ms)
    
    App->>Gemini: embed_content("text 3")
    Gemini-->>App: vector 3 (200ms)
    
    Note over App,Gemini: 100 –∑–∞–ø—Ä–æ—Å–æ–≤ = 20 —Å–µ–∫—É–Ω–¥
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**

- ‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (~200ms –Ω–∞ –∑–∞–ø—Ä–æ—Å)
- ‚ùå –î–æ—Ä–æ–≥–æ ($0.025/1M tokens)
- ‚ùå Rate limits (1500 RPM)

---

### Batch API (Async)

```mermaid
sequenceDiagram
    participant App
    participant CloudStorage
    participant BatchAPI
    participant Worker
    
    App->>CloudStorage: –ó–∞–≥—Ä—É–∑–∏—Ç—å JSONL —Ñ–∞–π–ª
    Note over CloudStorage: {"requests": [...], "custom_id": "1"}<br/>{"requests": [...], "custom_id": "2"}<br/>...100 —Å—Ç—Ä–æ–∫
    
    App->>BatchAPI: –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ
    BatchAPI-->>App: job_id = "abc123"
    
    Note over Worker: –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞<br/>(10-30 –º–∏–Ω—É—Ç)
    
    App->>BatchAPI: get_status(job_id)
    BatchAPI-->>App: "COMPLETED"
    
    App->>CloudStorage: –°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    CloudStorage-->>App: 100 –≤–µ–∫—Ç–æ—Ä–æ–≤
```

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**

- ‚úÖ –î—ë—à–µ–≤–æ ($0.0125/1M tokens)
- ‚úÖ –ù–µ—Ç rate limits (–º–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø—Ä–æ—Å–æ–≤)
- ‚ùå –ó–∞–¥–µ—Ä–∂–∫–∞ 10-30 –º–∏–Ω—É—Ç

---

## üìä –≠–∫–æ–Ω–æ–º–∏–∫–∞: –ö–æ–≥–¥–∞ Batch API –≤—ã–≥–æ–¥–µ–Ω?

| –°—Ü–µ–Ω–∞—Ä–∏–π | –î–æ–∫—É–º–µ–Ω—Ç–æ–≤ | Sync —Å—Ç–æ–∏–º–æ—Å—Ç—å | Batch —Å—Ç–æ–∏–º–æ—Å—Ç—å | –≠–∫–æ–Ω–æ–º–∏—è |
|----------|-----------|----------------|-----------------|----------|
| –†—É—á–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ | 10 | $0.0125 | $0.00625 | **50%** ($0.00625) |
| –ò–º–ø–æ—Ä—Ç —Å—Ç–∞—Ç–µ–π | 1,000 | $1.25 | $0.625 | **50%** ($0.625) |
| –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π | 10,000 | $12.50 | $6.25 | **50%** ($6.25) |
| –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∞—Ä—Ö–∏–≤ | 100,000 | $125 | $62.50 | **50%** ($62.50) |

**–í–∞–∂–Ω–æ:** –≠–∫–æ–Ω–æ–º–∏—è **–≤—Å–µ–≥–¥–∞ 50%**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –æ–±—ä—ë–º–∞!

---

### Break-even –∞–Ω–∞–ª–∏–∑

**–í–æ–ø—Ä–æ—Å:** –ü—Ä–∏ –∫–∞–∫–æ–º –æ–±—ä—ë–º–µ Batch API –Ω–∞—á–∏–Ω–∞–µ—Ç –æ–∫—É–ø–∞—Ç—å—Å—è?

**–û—Ç–≤–µ—Ç:** –£–∂–µ —Å **–ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞**, –Ω–æ –µ—Å—Ç—å –Ω—é–∞–Ω—Å—ã:

**Trade-offs:**

| –§–∞–∫—Ç–æ—Ä | Sync | Batch |
|--------|------|-------|
| **–¶–µ–Ω–∞** | üí∞üí∞ –î–æ—Ä–æ–≥–æ | üí∞ –î—ë—à–µ–≤–æ |
| **–õ–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å** | üöÄ 200ms | üê¢ 10-30 –º–∏–Ω—É—Ç |
| **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞** | ‚úÖ –ü—Ä–æ—Å—Ç–∞—è | ‚ö†Ô∏è –ù—É–∂–µ–Ω worker + cloud storage |
| **Rate limits** | ‚ö†Ô∏è 1500 RPM | ‚úÖ –ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–æ |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**

- **< 100 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** –ò—Å–ø–æ–ª—å–∑—É–π sync (–ø—Ä–æ—Å—Ç–æ—Ç–∞ –≤–∞–∂–Ω–µ–µ —ç–∫–æ–Ω–æ–º–∏–∏)
- **100-10,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** –ò—Å–ø–æ–ª—å–∑—É–π batch (—ç–∫–æ–Ω–æ–º–∏—è –∑–∞–º–µ—Ç–Ω–∞)
- **> 10,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:** Batch –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (sync —É–ø—Ä—ë—Ç—Å—è –≤ rate limits)

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. JSONL —Ñ–æ—Ä–º–∞—Ç ‚Äî –ø–æ—á–µ–º—É –Ω–µ JSON?

**Google Batch API —Ç—Ä–µ–±—É–µ—Ç JSONL** (JSON Lines), –≥–¥–µ –∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å.

**–ü–æ—á–µ–º—É –Ω–µ –æ–±—ã—á–Ω—ã–π JSON –º–∞—Å—Å–∏–≤?**

```json
// ‚ùå –ü–õ–û–•–û: –û–±—ã—á–Ω—ã–π JSON –º–∞—Å—Å–∏–≤
[
  {"requests": [...], "custom_id": "1"},
  {"requests": [...], "custom_id": "2"}
]
```

**–ü—Ä–æ–±–ª–µ–º–∞:** Google –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∑–∏—Ç—å **–≤–µ—Å—å —Ñ–∞–π–ª –≤ –ø–∞–º—è—Ç—å** –ø–µ—Ä–µ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π. –î–ª—è 1M –∑–∞–ø—Ä–æ—Å–æ–≤ —ç—Ç–æ –≥–∏–≥–∞–±–∞–π—Ç—ã RAM.

```jsonl
// ‚úÖ –•–û–†–û–®–û: JSONL —Ñ–æ—Ä–º–∞—Ç
{"requests": [...], "custom_id": "1"}
{"requests": [...], "custom_id": "2"}
```

**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ:** Google —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª **–ø–æ—Å—Ç—Ä–æ—á–Ω–æ** (streaming), –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ.

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ö–∞–∫ assembly line –Ω–∞ –∑–∞–≤–æ–¥–µ ‚Äî –¥–µ—Ç–∞–ª–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –ø–æ –∫–æ–Ω–≤–µ–π–µ—Ä—É, –∞ –Ω–µ –≤—Å–µ —Å—Ä–∞–∑—É.

---

### 2. Custom ID ‚Äî –∫–∞–∫ —Å–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?

**–ü—Ä–æ–±–ª–µ–º–∞:** Batch API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ **–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ**.

–¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª:

```jsonl
{"custom_id": "chunk_123", ...}
{"custom_id": "chunk_456", ...}
```

Google –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å:

```jsonl
{"custom_id": "chunk_456", "embedding": [...]}
{"custom_id": "chunk_123", "embedding": [...]}
```

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π `custom_id = f"chunk_{chunk.id}"` –¥–ª—è –º–∞–ø–ø–∏–Ω–≥–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞—Ç–Ω–æ –≤ –ë–î.

---

### 3. Partial failures ‚Äî —á—Ç–æ –µ—Å–ª–∏ —á–∞—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–æ–≤–∞–ª–∏–ª–∞—Å—å?

**–°—Ü–µ–Ω–∞—Ä–∏–π:** –û—Ç–ø—Ä–∞–≤–∏–ª 1000 –∑–∞–ø—Ä–æ—Å–æ–≤, 5 –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å (—Ç–æ–∫–µ–Ω-–ª–∏–º–∏—Ç, invalid text).

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ Google:**

- ‚úÖ 995 –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã —É—Å–ø–µ—à–Ω–æ
- ‚ùå 5 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–µ—Ä–Ω—É–ª–∏ error –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

**–†–µ—à–µ–Ω–∏–µ:**

1. Batch API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **–æ—Ç–¥–µ–ª—å–Ω—ã–π status –¥–ª—è –∫–∞–∂–¥–æ–≥–æ custom_id**
2. BatchManager –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã
3. –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç `error_message` –≤ —á–∞–Ω–∫
4. Worker –º–æ–∂–µ—Ç **retry** –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ –ø–æ–∑–∂–µ

---

### 4. Quota limits ‚Äî –∫–æ–≥–¥–∞ Batch API —Ç–æ–∂–µ —É–ø–∏—Ä–∞–µ—Ç—Å—è?

**Google Batch API –Ω–µ –∏–º–µ–µ—Ç RPM –ª–∏–º–∏—Ç–æ–≤**, –Ω–æ –µ—Å—Ç—å –¥—Ä—É–≥–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

| –õ–∏–º–∏—Ç | –ó–Ω–∞—á–µ–Ω–∏–µ |
|-------|----------|
| Max requests per batch | 10,000 |
| Max file size | 100 MB |
| Max concurrent jobs | 50 |

**–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ 100,000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤?**

**–†–µ—à–µ–Ω–∏–µ:** –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –±–∞—Ç—á–∏ –ø–æ 10K:

```
Batch 1: chunks 1-10,000   ‚Üí job_id_1
Batch 2: chunks 10,001-20,000 ‚Üí job_id_2
...
Batch 10: chunks 90,001-100,000 ‚Üí job_id_10
```

BatchManager –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —á–µ—Ä–µ–∑ `flush_queue(min_size=100)`.

---

## üéì –ê–Ω–∞–ª–æ–≥–∏—è –∏–∑ –∂–∏–∑–Ω–∏

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –∞–≤–∏–∞–∫–æ–º–ø–∞–Ω–∏—é —Å –¥–≤—É–º—è —Ç–∞—Ä–∏—Ñ–∞–º–∏:

**Sync API** ‚Äî "–ë–∏–∑–Ω–µ—Å-–∫–ª–∞—Å—Å":

- ‚úÖ –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞ (–º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç)
- ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ—Å—Ç–æ
- ‚ùå –ë–∏–ª–µ—Ç —Å—Ç–æ–∏—Ç $500

**Batch API** ‚Äî "–≠–∫–æ–Ω–æ–º —Å standby":

- ‚úÖ –ë–∏–ª–µ—Ç —Å—Ç–æ–∏—Ç $250 (50% –¥–µ—à–µ–≤–ª–µ)
- ‚úÖ –¢—ã –ø–æ–ª–µ—Ç–∏—à—å, –Ω–æ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ –∫–æ–≥–¥–∞ (10-30 –º–∏–Ω—É—Ç –∑–∞–¥–µ—Ä–∂–∫–∏)
- ‚ö†Ô∏è –ù—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞

–ï—Å–ª–∏ —Ç—ã –Ω–µ —Ç–æ—Ä–æ–ø–∏—à—å—Å—è ‚Äî –∑–∞—á–µ–º –ø–µ—Ä–µ–ø–ª–∞—á–∏–≤–∞—Ç—å?

---

## üîó –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

–¢–µ–ø–µ—Ä—å —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å **—ç–∫–æ–Ω–æ–º–∏–∫—É** Batch API. –ù–æ **–∫–∞–∫ –∏–º–µ–Ω–Ω–æ** –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç—Å—è –æ—á–µ—Ä–µ–¥—å –ª–æ–∫–∞–ª—å–Ω–æ –≤ SQLite?

‚Üí [**22. BatchManager: –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è**](22_batch_manager.md)

---

**‚Üê [–ù–∞–∑–∞–¥ –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é](00_overview.md)**
