# ‚è±Ô∏è Rate Limiting

> –ö–∞–∫ –Ω–µ –ø–æ–ª—É—á–∏—Ç—å 429 –æ—Ç Gemini API –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Rate Limiter** ‚Äî –º–µ—Ö–∞–Ω–∏–∑–º –∫–æ–Ω—Ç—Ä–æ–ª—è —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ API. –ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª.

**Token Bucket** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º, –∫–æ—Ç–æ—Ä—ã–π "–≤—ã–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω—ã" —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é. –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Äî –∂–¥–∏.

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

**–ü—Ä–æ–±–ª–µ–º–∞**: Gemini API –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç—ã:

| Tier | RPM (–∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω) |
|------|-------------------|
| Free | 15 |
| Pay-as-you-go | 1000+ |

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ 100 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è ‚Äî –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π 429.

**–†–µ—à–µ–Ω–∏–µ**: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏.

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –ü—Ä–æ—Å—Ç–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞

```
RPM = 15 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É
min_delay = 60 —Å–µ–∫ / 15 = 4 —Å–µ–∫—É–Ω–¥—ã –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
```

```mermaid
sequenceDiagram
    participant App
    participant Limiter as RateLimiter
    participant API as Gemini API
    
    App->>Limiter: wait()
    Note over Limiter: –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å ‚Äî —Å—Ä–∞–∑—É
    Limiter-->>App: 0 —Å–µ–∫
    App->>API: –ó–∞–ø—Ä–æ—Å 1
    
    App->>Limiter: wait()
    Note over Limiter: –ü—Ä–æ—à–ª–æ 0.5 —Å–µ–∫, –Ω—É–∂–Ω–æ 4
    Limiter->>Limiter: sleep(3.5 —Å–µ–∫)
    Limiter-->>App: 3.5 —Å–µ–∫
    App->>API: –ó–∞–ø—Ä–æ—Å 2
```

---

### –õ–æ–≥–∏–∫–∞ wait()

```mermaid
graph TD
    A[wait –≤—ã–∑–≤–∞–Ω] --> B{–ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å?}
    B -->|–î–∞| C[–ù–µ –∂–¥—ë–º]
    B -->|–ù–µ—Ç| D{–ü—Ä–æ—à–ª–æ ‚â• min_delay?}
    D -->|–î–∞| C
    D -->|–ù–µ—Ç| E[sleep —Ä–∞–∑–Ω–∏—Ü—É]
    E --> C
    C --> F[–û–±–Ω–æ–≤–∏—Ç—å last_request]
    F --> G[–í–µ—Ä–Ω—É—Ç—å –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è]
```

---

## üìä –†–∞—Å—á—ë—Ç –∑–∞–¥–µ—Ä–∂–∫–∏

| RPM | min_delay |
|-----|-----------|
| 15 | 4.0 —Å–µ–∫ |
| 30 | 2.0 —Å–µ–∫ |
| 60 | 1.0 —Å–µ–∫ |
| 120 | 0.5 —Å–µ–∫ |

**–§–æ—Ä–º—É–ª–∞**: `min_delay = 60.0 / rpm_limit`

---

## üîí –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–±–ª–µ–º–∞

–ï—Å–ª–∏ –¥–≤–∞ –ø–æ—Ç–æ–∫–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∑–æ–≤—É—Ç `wait()`:

```
–ü–æ—Ç–æ–∫ A: elapsed = 0.5 —Å–µ–∫
–ü–æ—Ç–æ–∫ B: elapsed = 0.5 —Å–µ–∫  ‚Üê —Ç–æ—Ç –∂–µ –º–æ–º–µ–Ω—Ç!
–ü–æ—Ç–æ–∫ A: –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å? –ù–µ—Ç, –Ω—É–∂–Ω–æ 3.5 —Å–µ–∫
–ü–æ—Ç–æ–∫ B: –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å? –ù–µ—Ç, –Ω—É–∂–Ω–æ 3.5 —Å–µ–∫
‚Üí –û–±–∞ –∂–¥—É—Ç, –ø–æ—Ç–æ–º –æ–±–∞ –¥–µ–ª–∞—é—Ç –∑–∞–ø—Ä–æ—Å –û–î–ù–û–í–†–ï–ú–ï–ù–ù–û
```

---

### –†–µ—à–µ–Ω–∏–µ: Lock

```mermaid
sequenceDiagram
    participant A as –ü–æ—Ç–æ–∫ A
    participant L as Lock
    participant B as –ü–æ—Ç–æ–∫ B
    
    A->>L: acquire()
    Note over L: A –≤–ª–∞–¥–µ–µ—Ç lock
    B->>L: acquire()
    Note over B: B –∂–¥—ë—Ç...
    A->>A: sleep + update
    A->>L: release()
    L-->>B: acquired
    B->>B: sleep + update
    B->>L: release()
```

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `threading.Lock()` ‚Äî —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–æ—Ç–æ–∫ –≤–Ω—É—Ç—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π —Å–µ–∫—Ü–∏–∏.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã RateLimiter

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| `rpm_limit` | 15 | –ó–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é**: 15 RPM ‚Äî –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ –¥–ª—è Free Tier.

---

### –í—ã–±–æ—Ä RPM

| –°—Ü–µ–Ω–∞—Ä–∏–π | RPM | min_delay |
|----------|-----|-----------|
| Free Tier, –±–µ–∑–æ–ø–∞—Å–Ω–æ | 15 | 4 —Å–µ–∫ |
| Free Tier, –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ | 12 | 5 —Å–µ–∫ |
| Pay-as-you-go | 60+ | ‚â§1 —Å–µ–∫ |

**–ü–æ—á–µ–º—É 15, –∞ –Ω–µ –±–æ–ª—å—à–µ?** Free Tier –ª–∏–º–∏—Ç ‚Äî 15 RPM. –ù–æ –ª—É—á—à–µ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞–ø–∞—Å –Ω–∞ —Å–ª—É—á–∞–π –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∏–∑ –¥—Ä—É–≥–∏—Ö —á–∞—Å—Ç–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

---

## üìà Rate Limiting vs Retry

### –î–≤–∞ —É—Ä–æ–≤–Ω—è –∑–∞—â–∏—Ç—ã

```mermaid
graph LR
    subgraph "–ü—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–æ"
        RL[RateLimiter] --> |4 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏| API
    end
    
    subgraph "–†–µ–∞–∫—Ç–∏–≤–Ω–æ"
        API --> |429| Retry[Retry with Backoff]
        Retry --> |–∂–¥—ë–º| API
    end
```

| –ú–µ—Ö–∞–Ω–∏–∑–º | –ö–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç | –¶–µ–ª—å |
|----------|---------------|------|
| Rate Limiter | **–î–æ** –∑–∞–ø—Ä–æ—Å–∞ | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å 429 |
| Retry | **–ü–æ—Å–ª–µ** 429 | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è |

**–ò–¥–µ–∞–ª**: Rate Limiter –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Ç–∞–∫, —á—Ç–æ Retry –Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–µ–Ω.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ–¥—Ö–æ–¥–æ–≤

| –ü–æ–¥—Ö–æ–¥ | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|--------|-------|--------|
| –ë–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—è | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å | 429, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ |
| –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π sleep | –ü—Ä–æ—Å—Ç–æ—Ç–∞ | –ù–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –ø—Ä–∏ –ø–∞—É–∑–∞—Ö |
| Token Bucket | ‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å | –ß—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ |
| Sliding Window | –¢–æ—á–Ω–µ–µ | –°–ª–æ–∂–Ω–µ–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è |

**–í—ã–±–æ—Ä**: Token Bucket ‚Äî –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. Reset –¥–ª—è —Ç–µ—Å—Ç–æ–≤

–ú–µ—Ç–æ–¥ `reset()` —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä:

```python
limiter = RateLimiter(rpm_limit=15)
limiter.wait()  # 0 —Å–µ–∫ (–ø–µ—Ä–≤—ã–π)
limiter.reset()
limiter.wait()  # 0 —Å–µ–∫ (—Å–Ω–æ–≤–∞ –ø–µ—Ä–≤—ã–π!)
```

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å**: –í —Ç–µ—Å—Ç–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –∂–¥–∞—Ç—å –º–µ–∂–¥—É test cases.

---

### 2. Burst-–∑–∞–ø—Ä–æ—Å—ã

Token Bucket **–Ω–µ –Ω–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç** —Ç–æ–∫–µ–Ω—ã. –ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞–ª–æ 10 –º–∏–Ω—É—Ç ‚Äî –Ω–µ–ª—å–∑—è —Å–¥–µ–ª–∞—Ç—å 150 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥.

**–ü–æ—á–µ–º—É**: Gemini API —Å—á–∏—Ç–∞–µ—Ç RPM –≤ —Å–∫–æ–ª—å–∑—è—â–µ–º –æ–∫–Ω–µ. Burst –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–∑–æ–≤–µ—Ç 429.

---

### 3. –ù–µ—Å–∫–æ–ª—å–∫–æ Rate Limiter'–æ–≤

–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ —Ä–∞–∑–Ω—ã–º —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º Gemini:
- Embeddings
- Vision
- Generation

–ö–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –∏–º–µ—Ç—å **—Å–≤–æ–π –ª–∏–º–∏—Ç**. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–µ RateLimiter'—ã –∏–ª–∏ –æ–±—â–∏–π —Å —Å—É–º–º–∞—Ä–Ω—ã–º RPM.

---

### 4. Distributed Rate Limiting

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è ‚Äî **in-process**. –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤/—Å–µ—Ä–≤–µ—Ä–æ–≤ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω API –∫–ª—é—á ‚Äî –Ω—É–∂–µ–Ω Redis –∏–ª–∏ –ø–æ–¥–æ–±–Ω–æ–µ.

–î–ª—è single-process –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π (–Ω–∞—à —Å–ª—É—á–∞–π) ‚Äî –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **–ü—Ä–µ–¥—ã–¥—É—â–∏–π**: [Resilience Patterns](27_resilience_patterns.md) ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ 429 –≤—Å—ë-—Ç–∞–∫–∏ —Å–ª—É—á–∏–ª—Å—è
- **–°–ª–µ–¥—É—é—â–∏–π**: [Media Queue Processor](29_media_queue_processor.md) ‚Äî –≥–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Rate Limiter
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞**: [Media Processing Architecture](25_media_processing_architecture.md)

---

**‚Üê [Resilience Patterns](27_resilience_patterns.md)** | **[Media Queue Processor](29_media_queue_processor.md) ‚Üí**
