# ‚ö° –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –∏ RRF (Reciprocal Rank Fusion)

## üìå –ü—Ä–æ–±–ª–µ–º–∞: –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –Ω–µ –∏–¥–µ–∞–ª–µ–Ω

**–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫**:

- ‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã
- ‚ùå –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ä–µ–¥–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã

**–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π FTS**:

- ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç —Ç–æ—á–Ω—ã–µ —Å–ª–æ–≤–∞
- ‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã

**–†–µ—à–µ–Ω–∏–µ**: –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –æ–±–∞ –º–µ—Ç–æ–¥–∞! üéØ

---

## üéØ –ß—Ç–æ —Ç–∞–∫–æ–µ RRF?

**Reciprocal Rank Fusion** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.

### –§–æ—Ä–º—É–ª–∞

```
RRF_score(doc) = Œ£ 1 / (k + rank_i)
```

–ì–¥–µ:

- `k` = –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ (–æ–±—ã—á–Ω–æ 60)
- `rank_i` = –ø–æ–∑–∏—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ i-–º –º–µ—Ç–æ–¥–µ –ø–æ–∏—Å–∫–∞

---

## üìä –ü—Ä–∏–º–µ—Ä —Ä–∞–±–æ—Ç—ã RRF

**–ó–∞–ø—Ä–æ—Å**: "—Å—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç"

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

| –ü–æ–∑–∏—Ü–∏—è | –î–æ–∫—É–º–µ–Ω—Ç | Score |
|---------|----------|-------|
| 1 | –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ | 1/(60+1) = 0.0164 |
| 2 | –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 1/(60+2) = 0.0161 |
| 3 | –¶–∏–∫–ª—ã –≤ Python | 1/(60+3) = 0.0159 |

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã FTS5

| –ü–æ–∑–∏—Ü–∏—è | –î–æ–∫—É–º–µ–Ω—Ç | Score |
|---------|----------|-------|
| 1 | –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 1/(60+1) = 0.0164 |
| 2 | –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ | 1/(60+2) = 0.0161 |

### –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ (RRF)

```
–°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏:
  0.0161 (–≤–µ–∫—Ç–æ—Ä, —Ä–∞–Ω–≥=2) + 0.0164 (FTS, —Ä–∞–Ω–≥=1) = 0.0325

–£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞:
  0.0164 (–≤–µ–∫—Ç–æ—Ä, —Ä–∞–Ω–≥=1) + 0.0161 (FTS, —Ä–∞–Ω–≥=2) = 0.0325

–¶–∏–∫–ª—ã –≤ Python:
  0.0159 (–≤–µ–∫—Ç–æ—Ä, —Ä–∞–Ω–≥=3) + 0 (–Ω–µ—Ç –≤ FTS) = 0.0159
```

**–ò—Ç–æ–≥–æ–≤—ã–π –ø–æ—Ä—è–¥–æ–∫**:

1. **–°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏** (0.0325) ‚Äî —Ç–æ–ø –≤ –æ–±–æ–∏—Ö!
2. –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ (0.0325)
3. –¶–∏–∫–ª—ã –≤ Python (0.0159)

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ SQL

### –ó–∞–ø—Ä–æ—Å —Å CTE (Common Table Expressions)

```sql
WITH vector_results AS (
    -- –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
    SELECT 
        main.id,
        ROW_NUMBER() OVER (ORDER BY vec_distance_cosine(vec.embedding, ?)) as rank
    FROM notes main
    INNER JOIN notes_vec vec ON main.id = vec.id
    LIMIT 100
),
fts_results AS (
    -- –ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫
    SELECT 
        main.id,
        ROW_NUMBER() OVER (ORDER BY fts.rank) as rank
    FROM notes main
    INNER JOIN notes_fts fts ON main.id = fts.rowid
    WHERE notes_fts MATCH ?
    LIMIT 100
),
rrf_scores AS (
    -- RRF –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ
    SELECT 
        COALESCE(v.id, f.id) as id,
        (COALESCE(1.0 / (60 + v.rank), 0) + COALESCE(1.0 / (60 + f.rank), 0)) as rrf_score
    FROM vector_results v
    FULL OUTER JOIN fts_results f ON v.id = f.id
)
SELECT id, rrf_score
FROM rrf_scores
ORDER BY rrf_score DESC
LIMIT 10;
```

---

## üêç –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ Python

### –ö–æ–¥ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞

```python
# semantic_core/search_mixin.py

@classmethod
def hybrid_search(cls, query: str, limit: int = 10, k: int = 60, **filters):
    """–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å RRF."""
    
    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–æ–≤
    generator = EmbeddingGenerator()
    query_embedding = generator.embed_query(query)
    query_blob = generator.vector_to_blob(query_embedding)
    
    # –§–∏–ª—å—Ç—Ä—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, category_id=5)
    where_conditions = []
    where_params = []
    for field, value in filters.items():
        where_conditions.append(f"main.{field} = ?")
        where_params.append(value)
    
    where_clause = f"WHERE {' AND '.join(where_conditions)}" if where_conditions else ""
    
    # SQL —Å CTE –∏ RRF
    sql = f"""
        WITH vector_results AS (
            SELECT main.id, ROW_NUMBER() OVER (...) as rank
            FROM {table_name} main
            INNER JOIN {vector_table} vec ON main.id = vec.id
            {where_clause}
            LIMIT 100
        ),
        fts_results AS (
            SELECT main.id, ROW_NUMBER() OVER (...) as rank
            FROM {table_name} main
            INNER JOIN {fts_table} fts ON main.id = fts.rowid
            WHERE {fts_table} MATCH ?
            {f"AND {' AND '.join(where_conditions)}" if where_conditions else ""}
            LIMIT 100
        ),
        rrf_scores AS (
            SELECT 
                COALESCE(v.id, f.id) as id,
                (COALESCE(1.0 / (? + v.rank), 0) + COALESCE(1.0 / (? + f.rank), 0)) as rrf_score
            FROM vector_results v
            FULL OUTER JOIN fts_results f ON v.id = f.id
        )
        SELECT id, rrf_score
        FROM rrf_scores
        ORDER BY rrf_score DESC
        LIMIT ?
    """
    
    params = [query_blob] + where_params + [query] + where_params + [k, k, limit]
    cursor = db.obj.execute_sql(sql, params)
    
    return results
```

---

## üéØ –§–∞—Å–µ—Ç–Ω—ã–π –ø–æ–∏—Å–∫ (—Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏)

### –ü—Ä–∏–º–µ—Ä: –ø–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–†–µ—Ü–µ–ø—Ç—ã"

```python
cat_recipes = Category.get(Category.name == "–†–µ—Ü–µ–ø—Ç—ã")

results = Note.hybrid_search(
    "–≤–∫—É—Å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç",
    limit=5,
    category_id=cat_recipes.id  # ‚Üê –§–∏–ª—å—Ç—Ä!
)
```

**SQL —Å WHERE**:

```sql
WITH vector_results AS (
    SELECT ...
    FROM notes main
    WHERE main.category_id = ?  -- ‚Üê –§–∏–ª—å—Ç—Ä
    ...
)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –Ω–∞–π–¥—ë—Ç —Ç–æ–ª—å–∫–æ "–ë–æ—Ä—â" –∏ "–ü–∞—Å—Ç–∞ –ö–∞—Ä–±–æ–Ω–∞—Ä–∞" (–æ–±–µ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "–†–µ—Ü–µ–ø—Ç—ã").

---

## üìä –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```mermaid
graph TD
    A[–ó–∞–ø—Ä–æ—Å: '—Å—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç'] --> B[–í–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è<br/>Gemini API]
    A --> C[–¢–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è<br/>FTS5]
    
    B --> D[–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫<br/>TOP 100]
    C --> E[FTS –ø–æ–∏—Å–∫<br/>TOP 100]
    
    D --> F[RRF –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ]
    E --> F
    
    F --> G[–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤<br/>category_id=5]
    G --> H[–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ RRF<br/>TOP 10]
    
    style F fill:#ea4335,color:#fff
```

---

## üéì –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

### 1. **–†–æ–±–∞—Å—Ç–Ω–æ—Å—Ç—å**

–ï—Å–ª–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥ –ø—Ä–æ–º–∞—Ö–Ω—É–ª—Å—è, –≤—Ç–æ—Ä–æ–π –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ—Ç:

```python
# –ó–∞–ø—Ä–æ—Å: "–Ω–µ–π—Ä–æ–Ω–∫–∞ –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–æ–∫"
# –í–µ–∫—Ç–æ—Ä: –Ω–∞–π–¥—ë—Ç "CNN", "–∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–µ –∑—Ä–µ–Ω–∏–µ", "deep learning"
# FTS: –Ω–∞–π–¥—ë—Ç —Ç–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ "–Ω–µ–π—Ä–æ–Ω–∫–∞" (–µ—Å–ª–∏ –µ—Å—Ç—å)
# RRF: –æ–±—ä–µ–¥–∏–Ω–∏—Ç ‚Üí –ª—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç!
```

### 2. **–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å**

–î–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ **–æ–±–æ–∏–º–∏** –º–µ—Ç–æ–¥–∞–º–∏, –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö:

```python
# –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö (#–∫–æ–¥, #—Å—Ä–æ—á–Ω–æ)
# - –í–µ–∫—Ç–æ—Ä: –±–ª–∏–∑–∫–æ –ø–æ —Å–º—ã—Å–ª—É –∫ "—Å—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç"
# - FTS: —Ç–æ—á–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±–∞ —Å–ª–æ–≤–∞
# ‚Üí RRF score —Å–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π!
```

### 3. **–ì–∏–±–∫–æ—Å—Ç—å**

–ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ–∏—Å–∫ –ø–æ –≥—Ä–∞—Ñ—É):

```python
rrf_score = 1/(k+vec_rank) + 1/(k+fts_rank) + 1/(k+graph_rank)
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### –ü–∞—Ä–∞–º–µ—Ç—Ä `k` (–∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ RRF)

```python
# k = 60 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
results = Note.hybrid_search("–∑–∞–ø—Ä–æ—Å", k=60)

# k = 10 (—Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è–µ—Ç —Ä–∞–Ω–≥)
results = Note.hybrid_search("–∑–∞–ø—Ä–æ—Å", k=10)

# k = 100 (–º–µ–Ω—å—à–µ –≤–ª–∏—è–µ—Ç —Ä–∞–Ω–≥)
results = Note.hybrid_search("–∑–∞–ø—Ä–æ—Å", k=100)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –æ—Å—Ç–∞–≤–∏—Ç—å `k=60` (–ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫–µ).

### –õ–∏–º–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

```python
# TOP 100 –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞ (–ø–æ—Ç–æ–º RRF)
LIMIT 100 –≤ CTE

# –ò—Ç–æ–≥–æ–≤—ã–π –ª–∏–º–∏—Ç (–ø–æ—Å–ª–µ RRF)
LIMIT ? –≤ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º SELECT
```

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –¢–µ—Å—Ç—ã –Ω–∞ 10,000 –∑–∞–º–µ—Ç–æ–∫

| –ú–µ—Ç–æ–¥ | –í—Ä–µ–º—è |
|-------|-------|
| –¢–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä | ~50 ms |
| –¢–æ–ª—å–∫–æ FTS | ~5 ms |
| **–ì–∏–±—Ä–∏–¥–Ω—ã–π (RRF)** | **~60 ms** |

**–í—ã–≤–æ–¥**: RRF –¥–æ–±–∞–≤–ª—è–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –Ω–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã!

---

## üîó –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

–¢–µ–ø–µ—Ä—å –∏–∑—É—á–∏ [**–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞**](06_project_architecture.md) –∏ –∫–∞–∫ –≤—Å—ë –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω–æ ‚Üí
