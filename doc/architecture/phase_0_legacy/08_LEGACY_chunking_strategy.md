# ‚úÇÔ∏è –°—Ç—Ä–∞—Ç–µ–≥–∏—è –Ω–∞—Ä–µ–∑–∫–∏ —Ç–µ–∫—Å—Ç–∞ (Chunking)

> –ü–æ—á–µ–º—É –Ω—É–∂–Ω–æ —Ä–µ–∑–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ –∫—É—Å–∫–∏ –∏ –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ

---

## üéØ –ü—Ä–æ–±–ª–µ–º–∞: –ª–∏–º–∏—Ç 2000 —Ç–æ–∫–µ–Ω–æ–≤

**Gemini embedding model** (models/text-embedding-004) –∏–º–µ–µ—Ç –∂–µ—Å—Ç–∫–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ:

```
–ú–∞–∫—Å–∏–º—É–º: 2000 —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å
```

**–ß—Ç–æ —Ç–∞–∫–æ–µ —Ç–æ–∫–µ–Ω?**

- –ü—Ä–∏–º–µ—Ä–Ω–æ 1 —Ç–æ–∫–µ–Ω ‚âà 0.75 —Å–ª–æ–≤–∞ (–¥–ª—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ)
- –ü—Ä–∏–º–µ—Ä–Ω–æ 1 —Ç–æ–∫–µ–Ω ‚âà 0.5 —Å–ª–æ–≤–∞ (–¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ, –∏–∑-–∑–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)

**–°–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å–∏–º–≤–æ–ª–æ–≤?**

| –Ø–∑—ã–∫ | –¢–æ–∫–µ–Ω–æ–≤ | –°–∏–º–≤–æ–ª–æ–≤ (–ø—Ä–∏–º–µ—Ä–Ω–æ) |
|------|---------|---------------------|
| –ê–Ω–≥–ª–∏–π—Å–∫–∏–π | 2000 | ~6000-8000 |
| –†—É—Å—Å–∫–∏–π | 2000 | ~4000-5000 |
| –ö–æ–¥ Python | 2000 | ~5000-7000 |

**–†–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã:**

- –≠—Ç–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏: ~1500 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí **–≤–º–µ—â–∞–µ—Ç—Å—è**
- –î–æ–∫—É–º–µ–Ω—Ç `07_data_flow.md`: ~9000 —Å–∏–º–≤–æ–ª–æ–≤ ‚Üí **–ù–ï –≤–º–µ—â–∞–µ—Ç—Å—è!**

---

## üí° –†–µ—à–µ–Ω–∏–µ: chunking (–Ω–∞—Ä–µ–∑–∫–∞)

–†–∞–∑–±–∏–≤–∞–µ–º –±–æ–ª—å—à–æ–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–µ –∫—É—Å–æ—á–∫–∏ (chunks), –∫–∞–∂–¥—ã–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –≤–µ–∫—Ç–æ—Ä–∏–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω–æ.

```mermaid
graph LR
    A[–ë–æ–ª—å—à–æ–π –¥–æ–∫—É–º–µ–Ω—Ç<br/>9000 —Å–∏–º–≤–æ–ª–æ–≤] --> B[Chunk 1<br/>1000 —Å–∏–º–≤–æ–ª–æ–≤]
    A --> C[Chunk 2<br/>1000 —Å–∏–º–≤–æ–ª–æ–≤]
    A --> D[Chunk 3<br/>1000 —Å–∏–º–≤–æ–ª–æ–≤]
    A --> E[... –µ—â—ë 6 —á–∞–Ω–∫–æ–≤]
    
    B --> F[–í–µ–∫—Ç–æ—Ä 1]
    C --> G[–í–µ–∫—Ç–æ—Ä 2]
    D --> H[–í–µ–∫—Ç–æ—Ä 3]
    E --> I[–í–µ–∫—Ç–æ—Ä—ã 4-9]
```

---

## üîß SimpleTextSplitter: "—Ç—É–ø–æ–π –∫–∞–∫ –ø—Ä–æ–±–∫–∞"

–ù–∞—à–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ª–µ–¥—É–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø—É **KISS** (Keep It Simple, Stupid):

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

```python
SimpleTextSplitter(
    chunk_size=1000,    # –¶–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä –∫—É—Å–∫–∞ (—Å–∏–º–≤–æ–ª—ã)
    overlap=200,        # –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –º–µ–∂–¥—É –∫—É—Å–∫–∞–º–∏
    threshold=100       # –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å—Ç—Ä–æ–∫–∏
)
```

### –ê–ª–≥–æ—Ä–∏—Ç–º

```mermaid
graph TD
    A[–ù–∞—á–∞–ª–æ —Ç–µ–∫—Å—Ç–∞] --> B{–†–∞–∑–º–µ—Ä < chunk_size?}
    B -->|–î–∞| C[–í–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å —Ç–µ–∫—Å—Ç]
    B -->|–ù–µ—Ç| D[target_end = start + chunk_size]
    D --> E[–ò—â–µ–º –±–ª–∏–∂–∞–π—à–∏–π \\n –≤ –æ–∫–Ω–µ ¬±threshold]
    E --> F{–ù–∞—à–ª–∏ \\n?}
    F -->|–î–∞| G[–†–µ–∂–µ–º –ø–æ –ø–µ—Ä–µ–Ω–æ—Å—É<br/>smart cut]
    F -->|–ù–µ—Ç| H[–†–µ–∂–µ–º –∂–µ—Å—Ç–∫–æ –ø–æ target_end<br/>hard cut]
    G --> I[–°–ª–µ–¥—É—é—â–∏–π —á–∞–Ω–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è<br/>—Å –æ—Ç—Å—Ç—É–ø–æ–º overlap]
    H --> I
    I --> B
```

### –£–º–Ω–∞—è –Ω–∞—Ä–µ–∑–∫–∞ (smart cut)

```python
text = """
–ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.

–í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ —Å –≤–∞–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π.

–¢—Ä–µ—Ç–∏–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.
"""

# –¶–µ–ª—å: —Ä–∞–∑—Ä–µ–∑ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 50
# –û–∫–Ω–æ –ø–æ–∏—Å–∫–∞: [40, 60] (¬±10 –æ—Ç —Ü–µ–ª–∏)
# –ù–∞–π–¥–µ–Ω –ø–µ—Ä–µ–Ω–æ—Å –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏ 54 ‚Üí —Ä–µ–∂–µ–º —Ç–∞–º!
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```
Chunk 1: "–ü–µ—Ä–≤—ã–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ.\n\n–í—Ç–æ—Ä–æ–π –ø–∞—Ä–∞–≥—Ä–∞—Ñ —Å –≤–∞–∂–Ω–æ–π..."
                                                        ‚Üë
                                             smart cut –∑–¥–µ—Å—å
```

### –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ (overlap)

–ó–∞—á–µ–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ? –ß—Ç–æ–±—ã **–Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç** –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö!

```
–¢–µ–∫—Å—Ç: "Python ‚Äî —ç—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è..."
                                          ‚Üë
                           –≥—Ä–∞–Ω–∏—Ü–∞ —á–∞–Ω–∫–∞ –±–µ–∑ overlap

Chunk 1: "Python ‚Äî —ç—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä"
Chunk 2: "–∞–Ω–∏—è. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è..."
         ‚ùå –ü–æ—Ç–µ—Ä—è–ª–∏ —Å–≤—è–∑—å –º–µ–∂–¥—É –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏!
```

**–° overlap=20:**

```
Chunk 1: "Python ‚Äî —ç—Ç–æ —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –û–Ω"
Chunk 2:                  "–∏—Ä–æ–≤–∞–Ω–∏—è. –û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è..."
                          ‚Üë
                   –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ 20 —Å–∏–º–≤–æ–ª–æ–≤
         ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!
```

---

## üìä –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–æ–≤

–ö–∞–∂–¥—ã–π —á–∞–Ω–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏:

```python
@dataclass
class Chunk:
    text: str                    # –¢–µ–∫—Å—Ç —á–∞–Ω–∫–∞
    index: int                   # –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä (0, 1, 2...)
    metadata: Dict[str, Any]     # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
```

**–ü—Ä–∏–º–µ—Ä metadata:**

```json
{
  "start": 0,
  "end": 1024,
  "cut_type": "newline",  // –∏–ª–∏ "hard"
  "is_last": false
}
```

---

## üé® –ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Ä–µ–∑–∫–∏

### –ü—Ä–∏–º–µ—Ä 1: –ö–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç

```python
splitter = SimpleTextSplitter(chunk_size=1000)
text = "–ö–æ—Ä–æ—Ç–∫–∞—è –∑–∞–º–µ—Ç–∫–∞"

chunks = splitter.split_text(text)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 1 —á–∞–Ω–∫ (–≤–µ—Å—å —Ç–µ–∫—Å—Ç)
```

### –ü—Ä–∏–º–µ—Ä 2: –î–ª–∏–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç

```python
text = """
# –î–æ–∫—É–º–µ–Ω—Ç –Ω–∞ 5000 —Å–∏–º–≤–æ–ª–æ–≤
... –º–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ ...
"""

chunks = splitter.split_text(text)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 5-6 —á–∞–Ω–∫–æ–≤ –ø–æ ~1000 —Å–∏–º–≤–æ–ª–æ–≤
```

### –ü—Ä–∏–º–µ—Ä 3: –ö–æ–¥ Python

```python
text = open("main.py").read()  # 3500 —Å–∏–º–≤–æ–ª–æ–≤

chunks = splitter.split_text(text)
# –†–µ–∑—É–ª—å—Ç–∞—Ç: 
# Chunk 0: imports + –ø–µ—Ä–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è
# Chunk 1: –≤—Ç–æ—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ —Å –ø–µ—Ä–≤–æ–π)
# Chunk 2: —Ç—Ä–µ—Ç—å—è —Ñ—É–Ω–∫—Ü–∏—è
# Chunk 3: –æ—Å—Ç–∞—Ç–æ–∫ –∫–æ–¥–∞
```

---

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ß—Ç–æ –ù–ï —É–º–µ–µ—Ç SimpleTextSplitter

1. **–ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É Markdown**

   ```markdown
   # –ó–∞–≥–æ–ª–æ–≤–æ–∫
   –¢–µ–∫—Å—Ç –ø–∞—Ä–∞–≥—Ä–∞—Ñ–∞
   ```

   –ú–æ–∂–µ—Ç —Ä–∞–∑—Ä–µ–∑–∞—Ç—å –ø—Ä—è–º–æ –ø–æ—Å—Ä–µ–¥–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞!

2. **–ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–¥**

   ```python
   def function():
       # –ú–æ–∂–µ—Ç —Ä–∞–∑—Ä–µ–∑–∞—Ç—å –∑–¥–µ—Å—å ‚Üí
       return value
   ```

3. **–ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É**
   - –ù–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ —ç—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–≤—è–∑–∞–Ω–æ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º
   - –†–µ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –ø–µ—Ä–µ–Ω–æ—Å–∞–º —Å—Ç—Ä–æ–∫

### –ö–æ–≥–¥–∞ —ç—Ç–æ–≥–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ?

‚úÖ **–ì–æ–¥–∏—Ç—Å—è –¥–ª—è:**

- –û–±—ã—á–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (—Å—Ç–∞—Ç—å–∏, –∑–∞–º–µ—Ç–∫–∏)
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏
- README —Ñ–∞–π–ª–æ–≤
- –õ–æ–≥–æ–≤

‚ùå **–ü–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å:**

- –ö–æ–¥–æ–º (–ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å AST-–ø–∞—Ä—Å–µ—Ä)
- Markdown (–ª—É—á—à–µ —Ä–µ–∑–∞—Ç—å –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º)
- JSON/XML (–ª—É—á—à–µ –ø–æ —ç–ª–µ–º–µ–Ω—Ç–∞–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã)

---

## üîÆ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã (–¥–ª—è –±—É–¥—É—â–µ–≥–æ)

–ë–ª–∞–≥–æ–¥–∞—Ä—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏ `TextSplitter`, –º–æ–∂–Ω–æ –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é:

### MarkdownSplitter (–≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π)

```python
class MarkdownSplitter(TextSplitter):
    """–†–µ–∂–µ—Ç –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º Markdown."""
    
    def split_text(self, text: str) -> List[Chunk]:
        # –ü–∞—Ä—Å–∏–º Markdown
        # –†–µ–∂–µ–º –ø–æ # –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–µ—Ä–∞—Ä—Ö–∏—é
        pass
```

### CodeAwareSplitter (–≥–∏–ø–æ—Ç–µ—Ç–∏—á–µ—Å–∫–∏–π)

```python
class CodeAwareSplitter(TextSplitter):
    """–†–µ–∂–µ—Ç Python –∫–æ–¥ –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º/–∫–ª–∞—Å—Å–∞–º."""
    
    def split_text(self, text: str) -> List[Chunk]:
        # –ü–∞—Ä—Å–∏–º —Å –ø–æ–º–æ—â—å—é ast.parse()
        # –†–µ–∂–µ–º –ø–æ —Ñ—É–Ω–∫—Ü–∏—è–º –∏ –∫–ª–∞—Å—Å–∞–º
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ –∫–∞–∂–¥–æ–º —á–∞–Ω–∫–µ
        pass
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑ –Ω–∞—à–µ–≥–æ POC

–†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `doc/architecture/`:

| –î–æ–∫—É–º–µ–Ω—Ç | –°–∏–º–≤–æ–ª—ã | –ß–∞–Ω–∫–æ–≤ | Avg —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞ |
|----------|---------|--------|------------------|
| 00_overview.md | 2009 | 3 | 670 |
| 01_embeddings_basics.md | 3477 | 4 | 869 |
| 02_gemini_api.md | 5397 | 6 | 899 |
| 07_data_flow.md | 9022 | 11 | 820 |

**–í—ã–≤–æ–¥—ã:**

- –°—Ä–µ–¥–Ω–µ–µ: 6.8 —á–∞–Ω–∫–æ–≤ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
- –°—Ä–µ–¥–Ω–∏–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–∞: ~820 —Å–∏–º–≤–æ–ª–æ–≤ (< 1000 ‚úÖ)
- –°–∞–º—ã–π –±–æ–ª—å—à–æ–π –¥–æ–∫—É–º–µ–Ω—Ç: 9022 —Å–∏–º–≤–æ–ª–∞ ‚Üí 11 —á–∞–Ω–∫–æ–≤

---

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ chunk_size

```python
# –î–ª—è –∫–æ—Ä–æ—Ç–∫–∏—Ö –∑–∞–º–µ—Ç–æ–∫
SimpleTextSplitter(chunk_size=500, overlap=100)

# –î–ª—è —Å—Ç–∞—Ç–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
SimpleTextSplitter(chunk_size=1000, overlap=200)

# –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
SimpleTextSplitter(chunk_size=1500, overlap=300)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ overlap

```
–ü—Ä–∞–≤–∏–ª–æ –±–æ–ª—å—à–æ–≥–æ –ø–∞–ª—å—Ü–∞: overlap = 20% –æ—Ç chunk_size
```

- –°–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π ‚Üí —Ç–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π ‚Üí –¥—É–±–ª–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ threshold

```
–û–±—ã—á–Ω–æ: threshold = 10% –æ—Ç chunk_size
```

- –ë–æ–ª—å—à–µ ‚Üí –±–æ–ª—å—à–µ —à–∞–Ω—Å–æ–≤ –Ω–∞–π—Ç–∏ –ø–µ—Ä–µ–Ω–æ—Å (–º–µ–Ω—å—à–µ hard cuts)
- –ú–µ–Ω—å—à–µ ‚Üí –±–æ–ª–µ–µ –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä —á–∞–Ω–∫–æ–≤

---

**‚Üê [–ù–∞–∑–∞–¥ –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é](00_overview.md)**

**‚Üí [–î–∞–ª—å—à–µ: Parent-Child Retrieval](09_parent_child_retrieval.md)**
