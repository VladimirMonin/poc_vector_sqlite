# üß† Episode 45: LLM Provider Abstraction

> –ö–∞–∫ –∞–±—Å—Ç—Ä–∞–≥–∏—Ä–æ–≤–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–∞ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏

---

## üéØ –ó–∞—á–µ–º –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è?

–°–µ–≥–æ–¥–Ω—è –∏—Å–ø–æ–ª—å–∑—É–µ–º Gemini, –∑–∞–≤—Ç—Ä–∞ ‚Äî OpenAI, –ø–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ ‚Äî –ª–æ–∫–∞–ª—å–Ω—É—é Llama. –ö–æ–¥ RAG –Ω–µ –¥–æ–ª–∂–µ–Ω –º–µ–Ω—è—Ç—å—Å—è –ø—Ä–∏ —Å–º–µ–Ω–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

**–ë–µ–∑ –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–∏:**
```
RAGEngine ‚Üí –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞–µ—Ç Gemini API
            ‚Üì
            –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ OpenAI = –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–µ—Å—å RAG
```

**–° –∞–±—Å—Ç—Ä–∞–∫—Ü–∏–µ–π:**
```
RAGEngine ‚Üí BaseLLMProvider (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
                 ‚Üì
            GeminiLLMProvider | OpenAIProvider | LocalLlamaProvider
```

---

## üèó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
classDiagram
    class BaseLLMProvider {
        <<abstract>>
        +generate(prompt, system_prompt, ...) GenerationResult
        +model_name: str
    }
    
    class GeminiLLMProvider {
        -_client: genai.Client
        -_model: str
        +generate() GenerationResult
        +model_name: str
    }
    
    class GenerationResult {
        +text: str
        +model: str
        +input_tokens: int?
        +output_tokens: int?
        +finish_reason: str?
        +total_tokens: int?
    }
    
    BaseLLMProvider <|-- GeminiLLMProvider
    BaseLLMProvider ..> GenerationResult
```

---

## üì¶ –ö–æ–Ω—Ç—Ä–∞–∫—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

### –ú–µ—Ç–æ–¥ generate()

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢–∏–ø | Default | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|-----|---------|----------|
| `prompt` | str | Required | –¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ |
| `system_prompt` | str? | None | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–µ–ª–∏ |
| `temperature` | float | 0.7 | –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å (0.0-2.0) |
| `max_tokens` | int? | None | –õ–∏–º–∏—Ç –æ—Ç–≤–µ—Ç–∞ |

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:** `GenerationResult`

### Property model_name

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è:
- `gemini-2.0-flash`
- `gpt-4-turbo`
- `llama-3-70b`

---

## üìä GenerationResult

–£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `text` | str | –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç |
| `model` | str | –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–∞—è –º–æ–¥–µ–ª—å |
| `input_tokens` | int? | –¢–æ–∫–µ–Ω—ã –ø—Ä–æ–º–ø—Ç–∞ |
| `output_tokens` | int? | –¢–æ–∫–µ–Ω—ã –æ—Ç–≤–µ—Ç–∞ |
| `finish_reason` | str? | –ü–æ—á–µ–º—É –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è |

**–ü—Ä–∏—á–∏–Ω—ã –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (finish_reason):**

| –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `STOP` | –ú–æ–¥–µ–ª—å –∑–∞–∫–æ–Ω—á–∏–ª–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ |
| `MAX_TOKENS` | –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç —Ç–æ–∫–µ–Ω–æ–≤ |
| `SAFETY` | –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ safety —Ñ–∏–ª—å—Ç—Ä–æ–º |
| `RECITATION` | –°–ª–∏—à–∫–æ–º –ø–æ—Ö–æ–∂–µ –Ω–∞ training data |

### –í—ã—á–∏—Å–ª—è–µ–º–æ–µ —Å–≤–æ–π—Å—Ç–≤–æ

**total_tokens** –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É input + output:
- –ï—Å–ª–∏ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è –µ—Å—Ç—å ‚Üí —Å—É–º–º–∞
- –ï—Å–ª–∏ –ª—é–±–æ–≥–æ –Ω–µ—Ç ‚Üí None

---

## üîå –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è Gemini

### –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

–ü—Ä–æ–≤–∞–π–¥–µ—Ä —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å API –∫–ª—é—á–æ–º –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ–º –º–æ–¥–µ–ª–∏:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | Default | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|---------|----------|
| `api_key` | Required | –ö–ª—é—á Gemini |
| `model` | gemini-2.0-flash | –ú–æ–¥–µ–ª—å |

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. –§–æ—Ä–º–∏—Ä—É–µ–º GenerateContentConfig                             ‚îÇ
‚îÇ     - temperature                                               ‚îÇ
‚îÇ     - max_output_tokens                                         ‚îÇ
‚îÇ     - system_instruction                                        ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  2. –í—ã–∑—ã–≤–∞–µ–º models.generate_content()                          ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  3. –ò–∑–≤–ª–µ–∫–∞–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ                                        ‚îÇ
‚îÇ     - usage_metadata.prompt_token_count                         ‚îÇ
‚îÇ     - usage_metadata.candidates_token_count                     ‚îÇ
‚îÇ     - candidates[0].finish_reason                               ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  4. –í–æ–∑–≤—Ä–∞—â–∞–µ–º GenerationResult                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ –æ—à–∏–±–∫–∏ API –æ–±–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –≤ `RuntimeError`:
- –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è —Ç–∏–ø –æ—à–∏–±–∫–∏
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞

---

## üìà –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ AI-–≤—ã–∑–æ–≤–æ–≤

–ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ `trace_ai()`:

| –ü–æ–ª–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `prompt` | –ü—Ä–µ–≤—å—é –ø—Ä–æ–º–ø—Ç–∞ (100 —Å–∏–º–≤–æ–ª–æ–≤) |
| `response` | –ü—Ä–µ–≤—å—é –æ—Ç–≤–µ—Ç–∞ (100 —Å–∏–º–≤–æ–ª–æ–≤) |
| `model` | –ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ |
| `tokens_in` | –í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã |
| `tokens_out` | –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã |
| `duration_ms` | –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |

**–ó–∞—á–µ–º trace_ai()?**
- –ê–Ω–∞–ª–∏–∑ –∑–∞—Ç—Ä–∞—Ç –Ω–∞ API
- –û—Ç–ª–∞–¥–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤
- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

---

## üîÑ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

### –®–∞–≥–∏

1. –°–æ–∑–¥–∞—Ç—å –∫–ª–∞—Å—Å, –Ω–∞—Å–ª–µ–¥—É—é—â–∏–π `BaseLLMProvider`
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `generate()` –∏ `model_name`
3. –î–æ–±–∞–≤–∏—Ç—å –≤ `infrastructure/llm/`
4. –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `__init__.py`

### –ü—Ä–∏–º–µ—Ä: OpenAI Provider

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  class OpenAIProvider(BaseLLMProvider):                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ      def __init__(self, api_key, model="gpt-4"):               ‚îÇ
‚îÇ          self._client = OpenAI(api_key=api_key)                ‚îÇ
‚îÇ          self._model = model                                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ      def generate(self, prompt, system_prompt=None, ...):       ‚îÇ
‚îÇ          messages = []                                          ‚îÇ
‚îÇ          if system_prompt:                                      ‚îÇ
‚îÇ              messages.append({"role": "system", ...})           ‚îÇ
‚îÇ          messages.append({"role": "user", ...})                 ‚îÇ
‚îÇ          response = self._client.chat.completions.create(...)   ‚îÇ
‚îÇ          return GenerationResult(...)                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ      @property                                                  ‚îÇ
‚îÇ      def model_name(self) -> str:                               ‚îÇ
‚îÇ          return self._model                                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤

| –ê—Å–ø–µ–∫—Ç | Gemini | OpenAI | Local LLM |
|--------|--------|--------|-----------|
| –°—Ç–æ–∏–º–æ—Å—Ç—å | –°—Ä–µ–¥–Ω—è—è | –í—ã—Å–æ–∫–∞—è | –ë–µ—Å–ø–ª–∞—Ç–Ω–æ |
| –°–∫–æ—Ä–æ—Å—Ç—å | –ë—ã—Å—Ç—Ä–æ | –ë—ã—Å—Ç—Ä–æ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç GPU |
| –ö–∞—á–µ—Å—Ç–≤–æ | –•–æ—Ä–æ—à–µ–µ | –û—Ç–ª–∏—á–Ω–æ–µ | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç –º–æ–¥–µ–ª–∏ |
| Privacy | –û–±–ª–∞–∫–æ | –û–±–ª–∞–∫–æ | –õ–æ–∫–∞–ª—å–Ω–æ |
| –õ–∏–º–∏—Ç—ã | 15 RPM (free) | Rate limits | –ù–µ—Ç |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å system_prompt

–ù–µ –≤—Å–µ –º–æ–¥–µ–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç system_prompt –æ–¥–∏–Ω–∞–∫–æ–≤–æ:
- Gemini: `system_instruction` –≤ –∫–æ–Ω—Ñ–∏–≥–µ
- OpenAI: –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–æ–ª—å—é "system"
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–µ–ª–∏: –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç

### –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ –º–æ–¥–µ–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç None –≤–º–µ—Å—Ç–æ —Ç–µ–∫—Å—Ç–∞:
- Gemini: `response.text` –º–æ–∂–µ—Ç –±—ã—Ç—å None
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∫ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É

### –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö

–ù–µ –≤—Å–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç —Ç–æ–∫–µ–Ω—ã:
- Gemini: –æ–±—ã—á–Ω–æ –µ—Å—Ç—å `usage_metadata`
- –ù–µ–∫–æ—Ç–æ—Ä—ã–µ API: –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ç–æ–∫–µ–Ω–∞—Ö
- GenerationResult –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç None

---

## üîó –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

**Episode 46** —Ä–∞—Å—Å–∫–∞–∂–µ—Ç –ø—Ä–æ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π CLI —á–∞—Ç ‚Äî –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å RAG –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞.

---

**‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π**: [Episode 44: RAG Engine Architecture](44_rag_engine_architecture.md)  
**‚Üí –°–ª–µ–¥—É—é—â–∏–π**: [Episode 46: RAG Chat CLI](46_rag_chat_cli.md)
