# ๐ง 67. Context Window: ะะตะฝะธะน ะธะปะธ ะะตะด ั ะดะตะผะตะฝัะธะตะน

> **ยซะคัะฝะบัะธะธ ะฟะพะทะฒะพะปััั ะพัะณะฐะฝะธะทะพะฒะฐัั ะบะพะด...ยป** โ ะธ ััะพ ะฒัั? ะ ะณะดะต ะฟัะธะผะตัั? ะะดะต ะฟัะพะดะพะปะถะตะฝะธะต?!

---

## ๐ ะกะพะดะตัะถะฐะฝะธะต

1. [ะกะธะผะฟัะพะผ ะฟัะพะฑะปะตะผั](#ัะธะผะฟัะพะผ-ะฟัะพะฑะปะตะผั)
2. [ะะธะฐะณะฝะพะท: ะฟะพัะตะผั ยซะดะตะด ั ะดะตะผะตะฝัะธะตะนยป](#ะดะธะฐะณะฝะพะท)
3. [ะขัะธ ัะตะถะธะผะฐ ะบะพะฝัะตะบััะฐ](#ััะธ-ัะตะถะธะผะฐ-ะบะพะฝัะตะบััะฐ)
4. [ะะตัะตะฝะธะต: context_window](#ัะตัะตะฝะธะต-context_window)
5. [ะััะธัะตะบัััะฐ](#ะฐััะธัะตะบัััะฐ)
6. [ะัะฟะพะปัะทะพะฒะฐะฝะธะต](#ะธัะฟะพะปัะทะพะฒะฐะฝะธะต)

---

## ๐ต ะกะธะผะฟัะพะผ ะฟัะพะฑะปะตะผั {#ัะธะผะฟัะพะผ-ะฟัะพะฑะปะตะผั}

RAG-ัะฐั ะฝะฐัะพะดะธั ะธะดะตะฐะปัะฝัะน ัะฐะฝะบ... ะธ ะพััะฐะฝะฐะฒะปะธะฒะฐะตััั:

```
User: ะะฐััะบะฐะถะธ ะฟัะพ ััะฝะบัะธะธ ะฒ Python

๐ ะะฐะนะดะตะฝ ัะฐะฝะบ [score: 0.92]:
   "ะคัะฝะบัะธะธ ะฟะพะทะฒะพะปััั ะพัะณะฐะฝะธะทะพะฒะฐัั ะบะพะด ะฒ ะฟะตัะตะธัะฟะพะปัะทัะตะผัะต ะฑะปะพะบะธ."

๐ค ะัะฒะตั LLM:
   "ะคัะฝะบัะธะธ ะฟะพะทะฒะพะปััั ะพัะณะฐะฝะธะทะพะฒะฐัั ะบะพะด. ะ ัะพะถะฐะปะตะฝะธั, ั ะผะตะฝั ะฝะตั
    ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะธะฝัะพัะผะฐัะธะธ ะฒ ะฟัะตะดะพััะฐะฒะปะตะฝะฝะพะผ ะบะพะฝัะตะบััะต."
```

**ะะพ ัะปะตะดัััะธะน ัะฐะฝะบ ัะพะดะตัะถะธั:**

```python
def greet(name):
    return f"Hello, {name}!"
```

LLM ะตะณะพ **ะฝะต ะฒะธะดะธั** โ ะผั ะฟะตัะตะดะฐะปะธ ัะพะปัะบะพ ะพะดะธะฝ ัะฐะฝะบ!

---

## ๐ฉบ ะะธะฐะณะฝะพะท: ะฟะพัะตะผั ยซะดะตะด ั ะดะตะผะตะฝัะธะตะนยป {#ะดะธะฐะณะฝะพะท}

ะัะตะดััะฐะฒััะต ะดะตะดะฐ, ะบะพัะพััะน ะฟะพะผะฝะธั ะขะะะฌะะ ะบะพะฝะบัะตัะฝัะน ะผะพะผะตะฝั:

```
ะะฝัะบ: "ะะฐััะบะฐะถะธ ะฟัะพ ะฒะพะนะฝั, ะดะตะด!"

ะะตะด: "ะ 1943 ะณะพะดั ะผั ะฟะตัะตะฟัะฐะฒะปัะปะธัั ัะตัะตะท ัะตะบั..."

ะะฝัะบ: "ะ ะดะฐะปััะต ััะพ ะฑัะปะพ?"

ะะตะด: "ะ ัะพะถะฐะปะตะฝะธั, ั ะผะตะฝั ะฝะตั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะธะฝัะพัะผะฐัะธะธ."
```

**ะะฐั RAG ัะฐะฑะพัะฐะตั ัะฐะบ ะถะต:**

| ะญัะฐะฟ | ะงัะพ ะฟัะพะธััะพะดะธั | ะัะพะฑะปะตะผะฐ |
|------|----------------|----------|
| ะะพะธัะบ | ะะฐัะพะดะธะผ ัะตะปะตะฒะฐะฝัะฝัะน ัะฐะฝะบ | โ |
| ะะพะฝัะตะบัั | ะะตัะตะดะฐัะผ ะขะะะฌะะ ััะพั ัะฐะฝะบ | ๐ด ะะตั ัะพัะตะดะตะน! |
| ะัะฒะตั | LLM ะฒะธะดะธั ััะฐะณะผะตะฝั | ๐ด ะะตั ะบะฐััะธะฝั! |

---

## ๐๏ธ ะขัะธ ัะตะถะธะผะฐ ะบะพะฝัะตะบััะฐ {#ััะธ-ัะตะถะธะผะฐ-ะบะพะฝัะตะบััะฐ}

ะะพ Phase 13.5 ะฑัะปะพ ัะพะปัะบะพ ะะะ ัะตะถะธะผะฐ:

### ะะตะถะธะผ 1: `full_docs=False` (ะฟะพ ัะผะพะปัะฐะฝะธั)

```
ะะพะบัะผะตะฝั: [chunk_0] [chunk_1] [chunk_2] [chunk_3] [chunk_4]
                              โ
                        ะฝะฐะนะดะตะฝ (score=0.95)

ะะตัะตะดะฐัะผ ะฒ LLM: [chunk_2]  โ ะขะะะฌะะ ะะะ!
```

**ะัะพะฑะปะตะผะฐ:** ะะฐะปะพ ะบะพะฝัะตะบััะฐ. ะะตะด ั ะดะตะผะตะฝัะธะตะน.

---

### ะะตะถะธะผ 2: `full_docs=True`

```
ะะพะบัะผะตะฝั: [chunk_0] [chunk_1] [chunk_2] [chunk_3] [chunk_4]
                              โ
                        ะฝะฐะนะดะตะฝ

ะะตัะตะดะฐัะผ ะฒ LLM: [chunk_0, chunk_1, chunk_2, chunk_3, chunk_4]  โ ะะกะ!
```

**ะัะพะฑะปะตะผะฐ:** ะกะปะธัะบะพะผ ะผะฝะพะณะพ ัะพะบะตะฝะพะฒ. ะะพัะพะณะพ ะธ ััะผะฝะพ.

---

### ะะตะถะธะผ 3: `context_window=N` (NEW!)

```
ะะพะบัะผะตะฝั: [chunk_0] [chunk_1] [chunk_2] [chunk_3] [chunk_4]
                              โ
                        ะฝะฐะนะดะตะฝ

context_window=1 โ [chunk_1, chunk_2, chunk_3]  โ ยฑ1 ัะพัะตะด!
```

**ะะพะปะพัะฐั ัะตัะตะดะธะฝะฐ:** ะะพััะฐัะพัะฝะพ ะบะพะฝัะตะบััะฐ, ะฝะต ัะปะธัะบะพะผ ะดะพัะพะณะพ.

---

## ๐ฏ ะะตัะตะฝะธะต: context_window {#ัะตัะตะฝะธะต-context_window}

### ะะดะตั

```
context_window=0  โ  ัะพะปัะบะพ ะฝะฐะนะดะตะฝะฝัะน ัะฐะฝะบ
context_window=1  โ  ยฑ1 ัะพัะตะด (3 ัะฐะฝะบะฐ)
context_window=2  โ  ยฑ2 ัะพัะตะดะฐ (5 ัะฐะฝะบะพะฒ)
context_window=N  โ  ะตัะปะธ N >= ัะฐะทะผะตัะฐ ะดะพะบัะผะตะฝัะฐ โ ะฒะตัั ะดะพะบัะผะตะฝั
```

### ะกัะฐะฒะฝะตะฝะธะต ัะตะถะธะผะพะฒ

| ะะตะถะธะผ | ะขะพะบะตะฝะพะฒ | ะะตะปะตะฒะฐะฝัะฝะพััั | ะฆะตะฝะฐ |
|-------|---------|---------------|------|
| `context_window=0` | ~500 | โญโญโญโญโญ | ๐ฐ |
| `context_window=1` | ~1500 | โญโญโญโญ | ๐ฐ๐ฐ |
| `context_window=2` | ~2500 | โญโญโญ | ๐ฐ๐ฐ๐ฐ |
| `full_docs=True` | ~10000+ | โญโญ | ๐ฐ๐ฐ๐ฐ๐ฐ๐ฐ |

---

## ๐๏ธ ะััะธัะตะบัััะฐ {#ะฐััะธัะตะบัััะฐ}

### ะะพะฒัะต ะบะพะผะฟะพะฝะตะฝัั

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     BaseVectorStore                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  + get_sibling_chunks(chunk_id, window) โ list[Chunk]           โ
โ  + get_document_chunks_count(doc_id) โ int                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     MatchType (Enum)                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  VECTOR = "vector"      โ ะฝะฐะนะดะตะฝ ะฒะตะบัะพัะฝัะผ ะฟะพะธัะบะพะผ              โ
โ  FTS = "fts"            โ ะฝะฐะนะดะตะฝ ะฟะพะปะฝะพัะตะบััะพะฒัะผ                 โ
โ  HYBRID = "hybrid"      โ ะฝะฐะนะดะตะฝ ะณะธะฑัะธะดะฝัะผ (RRF)                โ
โ  CONTEXT = "context"    โ NEW! ะกะพัะตะดะฝะธะน ัะฐะฝะบ (ะฝะต ัะตะทัะปััะฐั)     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพัะพะบ ะดะฐะฝะฝัั

```
search_chunks("query", context_window=1)
        โ
        โผ
โโโโโโโโโโโโโโโโโโโโโ
โ  ะะตะบัะพัะฝัะน ะฟะพะธัะบ  โ  โ ะะฐัะพะดะธะผ [chunk_5] (score=0.92)
โโโโโโโโโโโฌโโโโโโโโโโ
          โ
          โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ       _expand_with_context()          โ
โ                                       โ
โ  1. store.get_sibling_chunks(5, 1)    โ
โ     โ [chunk_4, chunk_5, chunk_6]     โ
โ                                       โ
โ  2. chunk_5 โ match_type=VECTOR       โ
โ     chunk_4 โ match_type=CONTEXT      โ
โ     chunk_6 โ match_type=CONTEXT      โ
โ                                       โ
โ  3. CONTEXT ัะฐะฝะบะธ โ score=0.0         โ
โโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
                    โ
                    โผ
           ะะตะทัะปััะฐั: 3 ัะฐะฝะบะฐ
           [chunk_4 (ctx), chunk_5 (0.92), chunk_6 (ctx)]
```

### SQL ะดะปั ะฟะพะปััะตะฝะธั ัะพัะตะดะตะน

```sql
SELECT *
FROM chunks
WHERE document_id = :doc_id
  AND chunk_index BETWEEN :position - :window 
                      AND :position + :window
ORDER BY chunk_index
```

---

## ๐ก ะฃะผะฝะพะต ะฟะพะฒะตะดะตะฝะธะต: ะฒะตัั ะดะพะบัะผะตะฝั

ะัะปะธ `window` ะฑะพะปััะต ัะตะผ ัะฐะฝะบะพะฒ ะฒ ะดะพะบัะผะตะฝัะต โ ะฒะพะทะฒัะฐัะฐะตััั **ะฒะตัั ะดะพะบัะผะตะฝั**:

```python
# ะะพะบัะผะตะฝั ะธะท 5 ัะฐะฝะบะพะฒ
total_chunks = 5

# ะะฐะฟัะฐัะธะฒะฐะตะผ window=100 (ะฑะพะปััะต ัะตะผ ะตััั)
siblings = store.get_sibling_chunks(chunk_id=2, window=100)

# ะะพะปััะฐะตะผ ะะกะ 5 ัะฐะฝะบะพะฒ
assert len(siblings) == 5
```

**ะญัะพ ะฟะพ ะดะธะทะฐะนะฝั!** ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ัะบะฐะทะฐัั: ยซะะฐะน ะผะฝะต ะบะพะฝัะตะบัั 100ยป โ ะธ ะฟะพะปััะธัั ะฒะตัั ะดะพะบัะผะตะฝั ะตัะปะธ ะพะฝ ะผะฐะปะตะฝัะบะธะน.

---

## ๐ฎ ะัะฟะพะปัะทะพะฒะฐะฝะธะต {#ะธัะฟะพะปัะทะพะฒะฐะฝะธะต}

### CLI: ะะพะธัะบ

```bash
# ะขะพะปัะบะพ ะฝะฐะนะดะตะฝะฝัะต ัะฐะฝะบะธ (ะฟะพ ัะผะพะปัะฐะฝะธั)
semantic search "ััะฝะบัะธะธ python"

# ะก ะบะพะฝัะตะบััะพะผ ยฑ1 ัะฐะฝะบ
semantic search "ััะฝะบัะธะธ python" --context-window 1

# ะก ะบะพะฝัะตะบััะพะผ ยฑ2 ัะฐะฝะบะฐ
semantic search "ััะฝะบัะธะธ python" -cw 2

# ะะตัั ะดะพะบัะผะตะฝั (ะตัะปะธ ะพะฝ ะผะตะฝััะต 100 ัะฐะฝะบะพะฒ)
semantic search "ััะฝะบัะธะธ python" -cw 100
```

### CLI: ะงะฐั

```bash
# ะงะฐั ั ัะฐััะธัะตะฝะฝัะผ ะบะพะฝัะตะบััะพะผ
semantic chat --context-window 2

# ะกัะฐะฒะฝะธัะต ะฟะพะฒะตะดะตะฝะธะต
semantic chat --full-docs        # ะัะตะณะดะฐ ะฒะตัั ะดะพะบัะผะตะฝั
semantic chat --context-window 5 # ยฑ5 ัะพัะตะดะตะน (ะธะปะธ ะฒะตัั, ะตัะปะธ ะผะตะฝััะต)
```

### Python API

```python
from semantic_core import SemanticCore
from semantic_core.core import RAGEngine

core = SemanticCore(...)
rag = RAGEngine(core=core, llm=llm)

# ะะพะธัะบ ั ัะพัะตะดัะผะธ
results = core.search_chunks(
    "ััะฝะบัะธะธ python",
    context_window=2,  # ยฑ2 ัะพัะตะดะฐ
    limit=3,
)

# RAG ั ะบะพะฝัะตะบััะพะผ
response = rag.ask(
    "ะงัะพ ัะฐะบะพะต ััะฝะบัะธะธ ะฒ Python?",
    context_window=1,  # ยฑ1 ัะพัะตะด ะดะปั ะบะฐะถะดะพะณะพ ัะตะทัะปััะฐัะฐ
)
```

---

## ๐ ะัะพะฑัะฐะถะตะฝะธะต ัะตะทัะปััะฐัะพะฒ

### ะ CLI

```
๐ ะะธะฑัะธะดะฝัะน ะฟะพะธัะบ: ััะฝะบัะธะธ python
ะะฐะนะดะตะฝะพ: 2 ัะฐะฝะบะพะฒ + 4 ะบะพะฝัะตะบััะฝัั (window=ยฑ2)

 #  | Score | ะขะธะฟ      | ะััะพัะฝะธะบ          | ะะพะฝัะตะฝั
----+-------+----------+-------------------+------------------
 1  | ctx   | text     | Python Tutorial   | Variables store...
 2  | 0.92  | text     | Python Tutorial   | Functions are...
 3  | ctx   | code     | Python Tutorial   | def greet(name)...
 4  | 0.87  | text     | Python Tutorial   | Classes define...
 5  | ctx   | code     | Python Tutorial   | class Person:...
 6  | ctx   | text     | Python Tutorial   | Modules help...
```

### ะ RAG ะบะพะฝัะตะบััะต

```
[1] Python Tutorial [text] (context)
Variables store data in Python...

---

[2] Python Tutorial [text] (score: 0.920)
Functions are reusable blocks of code...

---

[3] Python Tutorial [code] [python] (context)
def greet(name):
    return f"Hello, {name}!"
```

---

## ๐ ะะตะทัะปััะฐั: ะะตะฝะธะน ะฒะผะตััะพ ะดะตะดะฐ

### ะะพ (context_window=0)

```
User: ะะฐััะบะฐะถะธ ะฟัะพ ััะฝะบัะธะธ ะฒ Python

LLM: ะคัะฝะบัะธะธ ะฟะพะทะฒะพะปััั ะพัะณะฐะฝะธะทะพะฒะฐัั ะบะพะด. ะ ัะพะถะฐะปะตะฝะธั,
     ั ะผะตะฝั ะฝะตั ะดะพะฟะพะปะฝะธัะตะปัะฝะพะน ะธะฝัะพัะผะฐัะธะธ.
```

### ะะพัะปะต (context_window=1)

```
User: ะะฐััะบะฐะถะธ ะฟัะพ ััะฝะบัะธะธ ะฒ Python

LLM: ะคัะฝะบัะธะธ ะฟะพะทะฒะพะปััั ะพัะณะฐะฝะธะทะพะฒะฐัั ะบะพะด ะฒ ะฟะตัะตะธัะฟะพะปัะทัะตะผัะต ะฑะปะพะบะธ.
     ะะฟัะตะดะตะปััััั ั ะฟะพะผะพััั ะบะปััะตะฒะพะณะพ ัะปะพะฒะฐ `def`:

     def greet(name):
         return f"Hello, {name}!"

     ะ ะพัะปะธัะธะต ะพั ะบะปะฐััะพะฒ, ััะฝะบัะธะธ ะฝะต ััะตะฑััั ัะพะทะดะฐะฝะธั ะพะฑัะตะบัะฐ...
```

**LLM ะฒะธะดะธั ะฟัะธะผะตัั ะบะพะดะฐ ะธ ัะพัะตะดะฝะธะต ัะตะผั โ ะธ ะดะฐัั ะฟะพะปะฝะพัะตะฝะฝัะน ะพัะฒะตั!**

---

## โ ะัะธัะตัะธะธ ะฟัะธัะผะบะธ (ะฒัะฟะพะปะฝะตะฝะพ)

- [x] `get_sibling_chunks(chunk_id, window)` ะฒ BaseVectorStore
- [x] `get_document_chunks_count(doc_id)` ะดะปั ะฟัะพะฒะตัะบะธ ัะฐะทะผะตัะฐ
- [x] `MatchType.CONTEXT` ะดะปั ัะพัะตะดะฝะธั ัะฐะฝะบะพะฒ
- [x] `context_window` ะฟะฐัะฐะผะตัั ะฒ `search_chunks()`
- [x] `context_window` ะฟะฐัะฐะผะตัั ะฒ `RAGEngine.ask()`
- [x] `--context-window / -cw` ะฒ CLI search
- [x] `--context-window / -cw` ะฒ CLI chat
- [x] 22 E2E ัะตััะฐ ะฟะพะบััะฒะฐัั ะฒัะต ััะตะฝะฐัะธะธ

---

## ๐ ะกะฒัะทะฐะฝะฝัะต ัะฟะธะทะพะดั

- [44. RAG Engine Architecture](44_rag_engine_architecture.md) โ ะบะฐะบ ัะฐะฑะพัะฐะตั RAG
- [18. Granular Search](18_granular_search.md) โ ะฟะพะธัะบ ะฟะพ ัะฐะฝะบะฐะผ
- [47. Chat History Management](47_chat_history_management.md) โ ัะฟัะฐะฒะปะตะฝะธะต ะบะพะฝัะตะบััะพะผ ะธััะพัะธะธ

---

**โ [ะ ะพะณะปะฐะฒะปะตะฝะธั](00_overview.md)**
