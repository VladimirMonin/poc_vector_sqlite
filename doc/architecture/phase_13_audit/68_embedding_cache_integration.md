# 68. Embedding Cache Integration: –ó–∞–º—ã–∫–∞—è —Ü–µ–ø—å

> **–≠–ø–∏–∑–æ–¥ –æ —Ç–æ–º, –∫–∞–∫ –∫–µ—à –Ω–∞–∫–æ–Ω–µ—Ü –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –∏ –ø–æ—á–µ–º—É –ø–µ—Ä–µ–¥–∞—á–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚Äî —ç—Ç–æ –∏—Å–∫—É—Å—Å—Ç–≤–æ**

---

## üé¨ –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è

–í [—ç–ø–∏–∑–æ–¥–µ 56](56_query_cache.md) –º—ã —Å–æ–∑–¥–∞–ª–∏ `QueryCacheService` ‚Äî —É–º–Ω—ã–π –∫–µ—à –¥–ª—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤. –û–Ω –∑–∞–ø–æ–º–∏–Ω–∞–ª —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–ª –∞–≤—Ç–æ–∫–æ–º–ø–ª–∏—Ç.

**–í—Å—ë —Ä–∞–±–æ—Ç–∞–ª–æ... –Ω–∞ –±—É–º–∞–≥–µ.**

```
–ó–∞–ø—Ä–æ—Å "python async" ‚Üí –ö–µ—à: MISS ‚Üí Gemini API ‚Üí –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!
–ó–∞–ø—Ä–æ—Å "python async" ‚Üí –ö–µ—à: HIT! ‚Üí ... ‚Üí Gemini API (–û–ü–Ø–¢–¨?!)
```

–ö–µ—à **–∑–∞–ø–æ–ª–Ω—è–ª—Å—è**, –Ω–æ **–Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è**. –≠–º–±–µ–¥–¥–∏–Ω–≥–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å –∫–∞–∂–¥—ã–π —Ä–∞–∑.

---

## üîç –†–∞—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

–ü–æ—Å–º–æ—Ç—Ä–∏–º –Ω–∞ —Ü–µ–ø–æ—á–∫—É –≤—ã–∑–æ–≤–æ–≤:

```
SearchService.search()
    ‚Üì
cache.get_or_embed(query)  ‚Üê –ü–æ–ª—É—á–∏–ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥!
    ‚Üì  
core.search_chunks(query)  ‚Üê –ü–µ—Ä–µ–¥–∞–ª–∏ —Ç–æ–ª—å–∫–æ query...
    ‚Üì
embedder.embed_query(query)  ‚Üê –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–Ω–æ–≤–æ üò±
```

`search_chunks()` –Ω–µ –∑–Ω–∞–ª –ø—Ä–æ –∫–µ—à. –£ –Ω–µ–≥–æ –Ω–µ –±—ã–ª–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ –¥–ª—è –≥–æ—Ç–æ–≤–æ–≥–æ –≤–µ–∫—Ç–æ—Ä–∞.

**–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞:** —Å–ª–æ–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã, –Ω–æ –Ω–µ –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –Ω—É–∂–Ω—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã.

---

## üí° –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ü—Ä–æ—Ç—è–Ω—É—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä

```python
# semantic_core/pipeline.py

def search_chunks(
    self,
    query: str,
    limit: int = 10,
    mode: Literal["fts", "vector", "hybrid"] = "hybrid",
    chunk_types: list[str] | None = None,
    query_vector: list[float] | None = None,  # NEW!
) -> list[ChunkResult]:
    """
    Args:
        query_vector: –ì–æ—Ç–æ–≤—ã–π –≤–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞. –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω ‚Äî
                      –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤—ã–∑–æ–≤ embed_query().
    """
```

### –®–∞–≥ 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å

```python
# –í–Ω—É—Ç—Ä–∏ search_chunks()

if mode in ("vector", "hybrid"):
    if query_vector is None:
        # –ö–µ—à–∞ –Ω–µ—Ç ‚Äî –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º
        query_vector = self.embedder.embed_query(query)
    # else: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π!
```

### –®–∞–≥ 3: –ü–µ—Ä–µ–¥–∞—Ç—å –∏–∑ —Å–µ—Ä–≤–∏—Å–∞

```python
# app/services/search_service.py

def search(self, query: str, ...) -> list[SearchResultItem]:
    query_vector = None
    
    if self.cache and mode in ("vector", "hybrid"):
        cache_result = self.cache.get_or_embed(query)
        query_vector = cache_result.embedding
        logger.info(f"üíæ Cache {'HIT' if cache_result.from_cache else 'MISS'}")
    
    chunks = self.core.search_chunks(
        query=query,
        query_vector=query_vector,  # –ü–µ—Ä–µ–¥–∞—ë–º!
        ...
    )
```

---

## üìä –î–∏–∞–≥—Ä–∞–º–º–∞: –î–æ –∏ –ü–æ—Å–ª–µ

### ‚ùå –ë—ã–ª–æ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SearchService‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ QueryCache    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Gemini API   ‚îÇ
‚îÇ              ‚îÇ     ‚îÇ get_or_embed()‚îÇ     ‚îÇ (embed)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                                          ‚ñ≤
       ‚îÇ                                          ‚îÇ
       ‚ñº                                          ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê            ‚îÇ
‚îÇ SemanticCore ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ GeminiEmbedder‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îÇ search_chunks‚îÇ     ‚îÇ embed_query() ‚îÇ  ‚Üê –î—É–±–ª—å!
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### ‚úÖ –°—Ç–∞–ª–æ

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ SearchService‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ QueryCache    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Gemini API   ‚îÇ
‚îÇ              ‚îÇ     ‚îÇ get_or_embed()‚îÇ     ‚îÇ (1 —Ä–∞–∑)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ query_vector                             
       ‚ñº                                          
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                                  
‚îÇ SemanticCore ‚îÇ  ‚Üê –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –≥–æ—Ç–æ–≤—ã–π –≤–µ–∫—Ç–æ—Ä    
‚îÇ search_chunks‚îÇ                                  
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                                  
```

---

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞

```python
def test_search_passes_cached_vector_to_core(mock_core, mock_cache):
    """–ó–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–µ–∫—Ç–æ—Ä –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ core."""
    mock_cache.get_or_embed.return_value = CacheResult(
        embedding=[0.1, 0.2, 0.3],
        from_cache=True,
        frequency=5
    )
    
    service = SearchService(mock_core, mock_cache)
    service.search("python", mode="vector")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ core –ø–æ–ª—É—á–∏–ª –≤–µ–∫—Ç–æ—Ä
    mock_core.search_chunks.assert_called_once()
    call_kwargs = mock_core.search_chunks.call_args.kwargs
    assert call_kwargs["query_vector"] == [0.1, 0.2, 0.3]
```

---

## üìà –≠–∫–æ–Ω–æ–º–∏—è

| –°—Ü–µ–Ω–∞—Ä–∏–π | –ë–µ–∑ –∫–µ—à–∞ | –° –∫–µ—à–µ–º |
|----------|----------|---------|
| 10 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ | 10 API calls | 1 API call |
| RPM –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ | 100% | 10% |
| Latency (–ø–æ–≤—Ç–æ—Ä–Ω—ã–π) | ~200ms | ~5ms |

---

## üéì –£—Ä–æ–∫

> **–ö–µ—à –±–µ–∑ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è.**

–°–æ–∑–¥–∞—Ç—å –∫–µ—à ‚Äî –ø–æ–ª–¥–µ–ª–∞. –ù—É–∂–Ω–æ:
1. **–ü—Ä–æ—Ç—è–Ω—É—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä** —á–µ—Ä–µ–∑ –≤—Å–µ —Å–ª–æ–∏
2. **–°–¥–µ–ª–∞—Ç—å –µ–≥–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º** (–Ω–µ –ª–æ–º–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥)
3. **–ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å —è–≤–Ω–æ** (–±–µ–∑ –º–∞–≥–∏–∏)

–ü—Ä–∏–Ω—Ü–∏–ø **Explicit is better than implicit** —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∑–¥–µ—Å—å.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —ç–ø–∏–∑–æ–¥—ã

- [56. Query Cache](56_query_cache.md) ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∫–µ—à–∞
- [02. Gemini API](02_gemini_api.md) ‚Äî embed_query()
- [28. Rate Limiting](28_rate_limiting.md) ‚Äî —ç–∫–æ–Ω–æ–º–∏—è RPM
