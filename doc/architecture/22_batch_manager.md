# üéõÔ∏è BatchManager: –õ–æ–∫–∞–ª—å–Ω–∞—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è –æ—á–µ—Ä–µ–¥–∏

> –ö–∞–∫ SQLite —É–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –±–∞—Ç—á-–∑–∞–¥–∞–Ω–∏–π

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**BatchManager** ‚Äî —ç—Ç–æ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä—É–µ—Ç –æ—á–µ—Ä–µ–¥—å —á–∞–Ω–∫–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –ø–∞—á–∫–∞–º–∏ –≤ Google Batch API. –û–Ω —Å–ª–µ–¥–∏—Ç –∑–∞ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∑–∞–¥–∞–Ω–∏–π, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã.

–ü—Ä–æ—Å—Ç–∞—è –∏–¥–µ—è: **SQLite –∫–∞–∫ –æ—á–µ—Ä–µ–¥—å –∑–∞–¥–∞—á** –≤–º–µ—Å—Ç–æ Redis/RabbitMQ.

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

**–ü—Ä–æ–±–ª–µ–º–∞: –ö–∞–∫ –∫–æ–æ—Ä–¥–∏–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç—ã—Å—è—á–∏ —á–∞–Ω–∫–æ–≤?**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å: —É —Ç–µ–±—è 1000 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ async —Ä–µ–∂–∏–º–µ, –∫–∞–∂–¥—ã–π —Ä–∞–∑–±–∏—Ç –Ω–∞ 5 —á–∞–Ω–∫–æ–≤ = **5000 —á–∞–Ω–∫–æ–≤** –∂–¥—É—Ç –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.

–í–æ–ø—Ä–æ—Å—ã:

1. –ö–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ Google? (–ñ–¥–∞—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏–ª–∏ —Å—Ä–∞–∑—É?)
2. –ö–∞–∫ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å? (–ü–æ 10? –ü–æ 100? –ü–æ 1000?)
3. –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏? (–ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å –≤–µ–∫—Ç–æ—Ä—ã –≤ –ë–î?)
4. –ö–∞–∫ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—à–∏–±–∫–∏? (Retry? –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ?)

**–†–µ—à–µ–Ω–∏–µ: BatchManager –∫–∞–∫ –¥–∏—Å–ø–µ—Ç—á–µ—Ä**

BatchManager –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –≤—Å–µ —ç—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ **–¥–≤–∞ –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç–æ–¥–∞**:

- `flush_queue()` ‚Äî "–°–æ–±—Ä–∞—Ç—å PENDING —á–∞–Ω–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Google"
- `sync_status()` ‚Äî "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –∏ –æ–±–Ω–æ–≤–∏—Ç—å –≤–µ–∫—Ç–æ—Ä—ã"

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞

```mermaid
graph TB
    subgraph "–õ–æ–∫–∞–ª—å–Ω–∞—è –ë–î (SQLite)"
        A[Chunks —Ç–∞–±–ª–∏—Ü–∞]
        B[BatchJobs —Ç–∞–±–ª–∏—Ü–∞]
        
        A -->|batch_job_id FK| B
    end
    
    subgraph "BatchManager"
        C[flush_queue]
        D[sync_status]
        E[get_queue_stats]
    end
    
    subgraph "Google Cloud"
        F[Batch API]
        G[Cloud Storage]
    end
    
    C --> A
    C --> B
    C --> F
    D --> F
    D --> G
    D --> A
    
    style C fill:#99ccff
    style D fill:#99ff99
    style E fill:#ffcc99
```

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –±–∞—Ç—á-–∑–∞–¥–∞–Ω–∏—è

```mermaid
stateDiagram-v2
    [*] --> PENDING: flush_queue()
    PENDING --> RUNNING: Google –ø—Ä–∏–Ω—è–ª –∑–∞–¥–∞–Ω–∏–µ
    RUNNING --> COMPLETED: –í—Å–µ —á–∞–Ω–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
    RUNNING --> FAILED: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    
    COMPLETED --> [*]: sync_status() –æ–±–Ω–æ–≤–∏–ª –≤–µ–∫—Ç–æ—Ä—ã
    FAILED --> [*]: –ó–∞–ø–∏—Å–∞–Ω error_message
    
    note right of PENDING: –õ–æ–∫–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å<br/>(—Å–æ–∑–¥–∞–Ω BatchJobModel)
    note right of RUNNING: Google –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç<br/>(–∂–¥—ë–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    note right of COMPLETED: –í–µ–∫—Ç–æ—Ä—ã –≥–æ—Ç–æ–≤—ã<br/>(bulk_update_vectors)
```

---

## üéõÔ∏è –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç–æ–¥—ã

### 1. flush_queue() ‚Äî –û—Ç–ø—Ä–∞–≤–∫–∞ –±–∞—Ç—á–∞

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

1. –í—ã–±–∏—Ä–∞–µ—Ç –≤—Å–µ —á–∞–Ω–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `PENDING` –±–µ–∑ `batch_job_id`
2. –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ < `min_size` –∏ `force=False` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç
3. –°–æ–∑–¥–∞—ë—Ç `BatchJobModel` —Å `status=PENDING`
4. –°–≤—è–∑—ã–≤–∞–µ—Ç —á–∞–Ω–∫–∏ —Å –±–∞—Ç—á–µ–º (–æ–±–Ω–æ–≤–ª—è–µ—Ç `batch_job_id`)
5. –í—ã–∑—ã–≤–∞–µ—Ç `batch_client.create_embedding_job()`
6. –û–±–Ω–æ–≤–ª—è–µ—Ç `google_job_id` –∏ `status=RUNNING`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

- `min_size` (default: 100) ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –±–∞—Ç—á–∞
- `force` (bool) ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ä–∞–∑–º–µ—Ä–∞

**–ü—Ä–∏–º–µ—Ä:**

```
–û—á–µ—Ä–µ–¥—å: 50 PENDING —á–∞–Ω–∫–æ–≤

flush_queue(min_size=100) ‚Üí None (–Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ)
flush_queue(min_size=100, force=True) ‚Üí "batch_abc123" (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!)
```

**–ó–∞—á–µ–º min_size?**

Batch API —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–µ–Ω —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –æ–±—ä—ë–º–∞—Ö. –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ 5 —á–∞–Ω–∫–æ–≤, overhead (—Å–æ–∑–¥–∞–Ω–∏–µ job, –∑–∞–≥—Ä—É–∑–∫–∞ JSONL) —Å—ä–µ–¥–∞–µ—Ç —ç–∫–æ–Ω–æ–º–∏—é.

**–ê–Ω–∞–ª–æ–≥–∏—è:** –ö–∞–∫ –¥–æ—Å—Ç–∞–≤–∫–∞ ‚Äî –≤—ã–≥–æ–¥–Ω–µ–µ –≤–µ–∑—Ç–∏ –ø–æ–ª–Ω—ã–π –≥—Ä—É–∑–æ–≤–∏–∫, —á–µ–º 10 —Ä–∞–∑ –ø–æ 1 –∫–æ—Ä–æ–±–∫–µ.

---

### 2. sync_status() ‚Äî –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**

1. –í—ã–±–∏—Ä–∞–µ—Ç –≤—Å–µ `BatchJobModel` —Å `status IN (PENDING, RUNNING)`
2. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤—ã–∑—ã–≤–∞–µ—Ç `batch_client.get_job_status(google_job_id)`
3. **–ï—Å–ª–∏ COMPLETED:**
   - –í—ã–∑—ã–≤–∞–µ—Ç `retrieve_results()` ‚Üí –ø–æ–ª—É—á–∞–µ—Ç `dict[chunk_id ‚Üí vector_blob]`
   - –í—ã–∑—ã–≤–∞–µ—Ç `bulk_update_vectors()` ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤–µ–∫—Ç–æ—Ä—ã –≤ `chunks_vec`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏: `embedding_status=READY`, `batch_job_id=NULL`
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞—Ç—á: `status=COMPLETED`, `completed_chunks=total_chunks`
4. **–ï—Å–ª–∏ FAILED:**
   - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç `error_message` –≤ BatchJobModel
   - –û–±–Ω–æ–≤–ª—è–µ—Ç —á–∞–Ω–∫–∏: `error_message` –∏–∑ Google response
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –±–∞—Ç—á: `status=FAILED`

**–ö–æ–≥–¥–∞ –≤—ã–∑—ã–≤–∞—Ç—å:**

- ‚úÖ **Worker —Å–∫—Ä–∏–ø—Ç:** –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç (cron)
- ‚úÖ **Manually:** –î–ª—è –¥–µ–±–∞–≥–∞ (`python worker.py --sync`)
- ‚ùå **–ù–µ –Ω–∞–¥–æ:** –í—ã–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ `ingest()` (—Å–ª–∏—à–∫–æ–º —á–∞—Å—Ç–æ)

---

### 3. get_queue_stats() ‚Äî –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

**–ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:**

```python
{
    "pending": 150,    # –ß–∞–Ω–∫–∏ –∂–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏
    "running": 500,    # –ß–∞–Ω–∫–∏ –≤ –æ–±—Ä–∞–±–æ—Ç–∫–µ
    "failed": 5        # –ß–∞–Ω–∫–∏ —Å –æ—à–∏–±–∫–∞–º–∏
}
```

**Use case:**

–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ UI:

```
‚è≥ –í –æ—á–µ—Ä–µ–¥–∏: 150 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è: 500 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚ùå –û—à–∏–±–∫–∏: 5 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
```

---

## üìä –¢–∞–±–ª–∏—Ü—ã –ë–î

### BatchJobModel

| –ü–æ–ª–µ | –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----|------------|
| `id` | INT | –õ–æ–∫–∞–ª—å–Ω—ã–π ID |
| `google_job_id` | VARCHAR | ID –∑–∞–¥–∞–Ω–∏—è –≤ Google Cloud |
| `status` | ENUM | PENDING/RUNNING/COMPLETED/FAILED |
| `total_chunks` | INT | –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ –≤ –±–∞—Ç—á–µ |
| `completed_chunks` | INT | –°–∫–æ–ª—å–∫–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ |
| `created_at` | DATETIME | –ö–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω |
| `updated_at` | DATETIME | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ |

**–ò–Ω–¥–µ–∫—Å—ã:**

- PRIMARY KEY –Ω–∞ `id`
- INDEX –Ω–∞ `google_job_id` (–¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ sync)
- INDEX –Ω–∞ `status` (–¥–ª—è –≤—ã–±–æ—Ä–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π)

---

### ChunkModel (–Ω–æ–≤—ã–µ –ø–æ–ª—è)

| –ü–æ–ª–µ | –¢–∏–ø | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|-----|------------|
| `embedding_status` | ENUM | PENDING/READY/FAILED |
| `batch_job_id` | FK | –°–≤—è–∑—å —Å BatchJobModel |
| `error_message` | TEXT | –û–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ (nullable) |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å sync_status()

**–ü—Ä–æ–±–ª–µ–º–∞:** –ß—Ç–æ –µ—Å–ª–∏ `sync_status()` –≤—ã–∑–≤–∞–Ω –¥–≤–∞–∂–¥—ã –¥–ª—è –æ–¥–Ω–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è?

**–†–µ—à–µ–Ω–∏–µ:** –ú–µ—Ç–æ–¥ **–∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω**:

1. –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—ã–∑–æ–≤–µ: —Å—Ç–∞—Ç—É—Å `RUNNING` ‚Üí `COMPLETED`, –≤–µ–∫—Ç–æ—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã
2. –ü—Ä–∏ –≤—Ç–æ—Ä–æ–º –≤—ã–∑–æ–≤–µ: —Å—Ç–∞—Ç—É—Å —É–∂–µ `COMPLETED` ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

**SQL:**

```sql
SELECT * FROM batch_jobs
WHERE status IN ('PENDING', 'RUNNING')  -- –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
```

–ó–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –≤—ã–±–æ—Ä–∫—É ‚Üí **–±–µ–∑–æ–ø–∞—Å–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ**.

---

### 2. –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç–∏

**–ö—Ä–∏—Ç–∏—á–Ω–æ:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ `flush_queue()` –∏ `sync_status()` –æ–±—ë—Ä–Ω—É—Ç—ã –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

**–ü–æ—á–µ–º—É –≤–∞–∂–Ω–æ:**

–ï—Å–ª–∏ –ø–æ—Å–ª–µ `create_embedding_job()` –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É–ø–∞–ª–æ, –∞ `google_job_id` –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω:

- ‚ùå –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Google, –Ω–æ –ë–î –Ω–µ –∑–Ω–∞–µ—Ç –æ–± —ç—Ç–æ–º
- ‚ùå –ß–∞–Ω–∫–∏ –Ω–∞–≤—Å–µ–≥–¥–∞ –æ—Å—Ç–∞–Ω—É—Ç—Å—è `PENDING`
- ‚ùå –î–µ–Ω—å–≥–∏ –ø–æ—Ç—Ä–∞—á–µ–Ω—ã, –≤–µ–∫—Ç–æ—Ä–æ–≤ –Ω–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**

```python
with db.atomic():
    # 1. –°–æ–∑–¥–∞—Ç—å BatchJobModel
    # 2. –°–≤—è–∑–∞—Ç—å —á–∞–Ω–∫–∏
    # 3. –í—ã–∑–≤–∞—Ç—å batch_client
    # 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å google_job_id
    # –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ —É–ø–∞–ª–æ ‚Üí rollback –≤—Å–µ–≥–æ
```

---

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ partial failures

**–°—Ü–µ–Ω–∞—Ä–∏–π:** 100 —á–∞–Ω–∫–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, 95 —É—Å–ø–µ—à–Ω—ã, 5 –ø—Ä–æ–≤–∞–ª–µ–Ω—ã.

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (Phase 5.0):**

- –í–µ—Å—å –±–∞—Ç—á –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ `FAILED`
- `error_message` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤–æ –≤—Å–µ —á–∞–Ω–∫–∏

**–£–ª—É—á—à–µ–Ω–∏–µ (Phase 6):**

- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —É—Å–ø–µ—à–Ω—ã–µ —á–∞–Ω–∫–∏ ‚Üí `embedding_status=READY`
- –ü—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã–µ —á–∞–Ω–∫–∏ ‚Üí `embedding_status=FAILED` —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –æ—à–∏–±–∫–∞–º–∏
- Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –ø—Ä–æ–≤–∞–ª–µ–Ω–Ω—ã—Ö

---

### 4. Worker deployment patterns

**–ö–∞–∫ –∑–∞–ø—É—Å–∫–∞—Ç—å sync_status()?**

**–í–∞—Ä–∏–∞–Ω—Ç A: Cron job**

```bash
# crontab
*/5 * * * * cd /app && python worker.py
```

‚úÖ –ü—Ä–æ—Å—Ç–æ  
‚ö†Ô∏è –ù–µ—Ç monitoring

---

**–í–∞—Ä–∏–∞–Ω—Ç B: Systemd service**

```ini
# /etc/systemd/system/batch-worker.service
[Service]
ExecStart=/app/worker.py
Restart=always
```

‚úÖ –ê–≤—Ç–æ–ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ–µ  
‚úÖ –õ–æ–≥–∏ —á–µ—Ä–µ–∑ journalctl

---

**–í–∞—Ä–∏–∞–Ω—Ç C: Kubernetes CronJob**

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: batch-worker
spec:
  schedule: "*/5 * * * *"
```

‚úÖ Cloud-native  
‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å

---

## üéì –ê–Ω–∞–ª–æ–≥–∏—è –∏–∑ –∂–∏–∑–Ω–∏

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å–∫–ª–∞–¥ —Å –∫–æ–Ω–≤–µ–π–µ—Ä–æ–º:

**flush_queue()** ‚Äî —ç—Ç–æ **–ø–æ–≥—Ä—É–∑—á–∏–∫**:

- –°–æ–±–∏—Ä–∞–µ—Ç –∫–æ—Ä–æ–±–∫–∏ (—á–∞–Ω–∫–∏) —Å –ø–æ–ª–∫–∏ (–ë–î)
- –ñ–¥—ë—Ç, –ø–æ–∫–∞ –Ω–∞–∫–æ–ø–∏—Ç—Å—è –ø–æ–ª–Ω—ã–π –ø–æ–¥–¥–æ–Ω (min_size=100)
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≥—Ä—É–∑–æ–≤–∏–∫ –≤ –¥–æ—Å—Ç–∞–≤–∫—É (Google)
- –ü—Ä–∏–∫—Ä–µ–ø–ª—è–µ—Ç —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä (google_job_id)

**sync_status()** ‚Äî —ç—Ç–æ **–¥–∏—Å–ø–µ—Ç—á–µ—Ä –¥–æ—Å—Ç–∞–≤–∫–∏**:

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤ –ø–æ —Ç—Ä–µ–∫-–Ω–æ–º–µ—Ä–∞–º
- –ï—Å–ª–∏ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ ‚Üí –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (–≤–µ–∫—Ç–æ—Ä—ã –≤ –ë–î)
- –ï—Å–ª–∏ –ø–æ—Ç–µ—Ä—è–Ω–æ ‚Üí –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≤ –∂—É—Ä–Ω–∞–ª –æ—à–∏–±–æ–∫

**get_queue_stats()** ‚Äî —ç—Ç–æ **–¥–∞—à–±–æ—Ä–¥ —Å–∫–ª–∞–¥–∞**:

- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: —Å–∫–æ–ª—å–∫–æ –∫–æ—Ä–æ–±–æ–∫ –Ω–∞ –ø–æ–ª–∫–µ, –≤ –ø—É—Ç–∏, –ø–æ—Ç–µ—Ä—è–Ω–æ

---

## üîó –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥

–¢–µ–ø–µ—Ä—å —Ç—ã –ø–æ–Ω–∏–º–∞–µ—à—å **–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é** –æ—á–µ—Ä–µ–¥–∏. –ù–æ **–∫–∞–∫ –∏–º–µ–Ω–Ω–æ** –ë–î —ç–≤–æ–ª—é—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç –±–µ–∑ breaking changes?

‚Üí [**23. Schema Evolution: –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**](23_schema_evolution.md)

---

**‚Üê [–ù–∞–∑–∞–¥ –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é](00_overview.md)**
