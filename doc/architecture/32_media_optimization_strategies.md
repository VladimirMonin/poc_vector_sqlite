# ‚ö° Media Optimization Strategies

> –ö–∞–∫ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å Gemini API

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Media Optimization** ‚Äî –Ω–∞–±–æ—Ä —É—Ç–∏–ª–∏—Ç –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –¥–ª—è:

1. –°–∂–∞—Ç–∏—è –∞—É–¥–∏–æ –¥–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
2. –£–º–µ–Ω—å—à–µ–Ω–∏—è –∫–∞–¥—Ä–æ–≤ –≤–∏–¥–µ–æ –¥–æ –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤
3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º–Ω—ã–º–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ (ffmpeg)

–¶–µ–ª—å: **–º–∞–∫—Å–∏–º—É–º –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –ª–∏–º–∏—Ç–∞—Ö API –ø—Ä–∏ –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –∑–∞—Ç—Ä–∞—Ç–∞—Ö**.

---

## üéØ –ó–∞—á–µ–º –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å?

### –õ–∏–º–∏—Ç—ã Gemini

| –õ–∏–º–∏—Ç | –ó–Ω–∞—á–µ–Ω–∏–µ | –í–ª–∏—è–Ω–∏–µ |
|-------|----------|---------|
| Inline upload | 20 MB | –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –¥–ª–∏–Ω—É –∞—É–¥–∏–æ |
| –¢–æ–∫–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | –ü–æ —Ç–∞–π–ª–∞–º | –í–ª–∏—è–µ—Ç –Ω–∞ —Å—Ç–æ–∏–º–æ—Å—Ç—å |
| RPM (Free Tier) | 15 req/min | Throttling |

### –ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

```mermaid
graph LR
    A[–ü–æ–¥–∫–∞—Å—Ç 2 —á–∞—Å–∞<br/>MP3 192kbps<br/>~180 MB] --> B{20 MB –ª–∏–º–∏—Ç}
    B -->|‚ùå| C[–ù–µ –≤–ª–µ–∑–∞–µ—Ç]
```

### –° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π

```mermaid
graph LR
    A[–ü–æ–¥–∫–∞—Å—Ç 2 —á–∞—Å–∞] --> B[32kbps OGG<br/>~30 MB]
    B --> C{–ù–∞—Ä–µ–∑–∫–∞}
    C --> D[–ß–∞—Å—Ç—å 1: 83 –º–∏–Ω]
    C --> E[–ß–∞—Å—Ç—å 2: 37 –º–∏–Ω]
```

---

## üéµ Audio Optimization

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ —Å–∂–∞—Ç–∏–µ

–î–µ—Ñ–æ–ª—Ç–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ `audio.py`:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ó–∞—á–µ–º |
|----------|----------|-------|
| `DEFAULT_BITRATE` | 32 kbps | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
| `DEFAULT_CODEC` | libvorbis | –õ—É—á—à–µ MP3 –Ω–∞ –Ω–∏–∑–∫–∏—Ö –±–∏—Ç—Ä–µ–π—Ç–∞—Ö |
| `DEFAULT_SAMPLE_RATE` | 16000 Hz | –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Ä–µ—á–∏ |
| `DEFAULT_MONO` | True | Gemini –Ω–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç —Å—Ç–µ—Ä–µ–æ |

---

### –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è?

```mermaid
graph TD
    A[CD Quality<br/>44.1kHz stereo<br/>1411 kbps] --> B[–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è]
    B --> C[16kHz mono<br/>32 kbps OGG]
    C --> D[–°–∂–∞—Ç–∏–µ: 44√ó]
    D --> E[20 MB = 83 –º–∏–Ω—É—Ç—ã]
```

| –®–∞–≥ | –ß—Ç–æ –¥–µ–ª–∞–µ–º | –ü–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞ |
|-----|------------|-----------------|
| Stereo ‚Üí Mono | -50% –¥–∞–Ω–Ω—ã—Ö | ‚ùå –ù–µ—Ç (Gemini –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç) |
| 44.1kHz ‚Üí 16kHz | -64% –¥–∞–Ω–Ω—ã—Ö | ‚ö†Ô∏è –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ (—Ä–µ—á—å 4-8kHz) |
| 192kbps ‚Üí 32kbps | -83% –¥–∞–Ω–Ω—ã—Ö | ‚ö†Ô∏è –ó–∞–º–µ—Ç–Ω—ã–µ (–Ω–æ —Ä–µ—á—å –û–ö) |

---

### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∫–æ–¥–µ–∫–æ–≤

| –ö–æ–¥–µ–∫ | 32 kbps –∫–∞—á–µ—Å—Ç–≤–æ | –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å |
|-------|------------------|---------------|
| OGG/Vorbis | ‚úÖ –•–æ—Ä–æ—à–æ | ‚úÖ pydub, ffmpeg |
| Opus | ‚úÖ‚úÖ –û—Ç–ª–∏—á–Ω–æ | ‚ö†Ô∏è –ù–µ –≤–µ–∑–¥–µ |
| MP3 | ‚ö†Ô∏è –ü–ª–æ—Ö–æ | ‚úÖ –í–µ–∑–¥–µ |
| AAC | ‚úÖ –•–æ—Ä–æ—à–æ | ‚ö†Ô∏è –õ–∏—Ü–µ–Ω–∑–∏—è |

**–í—ã–±–æ—Ä**: OGG/Vorbis ‚Äî –±–∞–ª–∞–Ω—Å –∫–∞—á–µ—Å—Ç–≤–∞ –∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

---

### API —É—Ç–∏–ª–∏—Ç

```python
# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∞—É–¥–∏–æ –∏–∑ –≤–∏–¥–µ–æ
from semantic_core.infrastructure.media.utils.audio import (
    extract_audio_from_video,
    optimize_audio_to_bytes,
    get_audio_duration,
)

# –í–∏–¥–µ–æ ‚Üí –ê—É–¥–∏–æ —Ñ–∞–π–ª
audio_path = extract_audio_from_video(
    video_path="lecture.mp4",
    output_format="ogg",
    bitrate=32,
    mono=True
)

# –ê—É–¥–∏–æ ‚Üí Bytes –¥–ª—è inline upload
audio_bytes, mime_type = optimize_audio_to_bytes("podcast.mp3")
# ‚Üí (bytes, "audio/ogg")

# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
duration = get_audio_duration("speech.wav")  # ‚Üí 125.5 (—Å–µ–∫—É–Ω–¥—ã)
```

---

## üé¨ Video Frame Optimization

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤

–ü—Ä–µ—Å–µ—Ç—ã –∫–∞—á–µ—Å—Ç–≤–∞ –≤ `video.py`:

| Preset | Max Dimension | –¢–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∫–∞–¥—Ä | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|--------|---------------|-----------------|------------|
| `fhd` | 1024 px | ~774 | UI, –∫–æ–¥, –º–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç |
| `hd` | 768 px | ~516 | **–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é** |
| `balanced` | 512 px | ~258 | –î–ª–∏–Ω–Ω—ã–µ –≤–∏–¥–µ–æ |

---

### –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤

```mermaid
graph LR
    subgraph "–ë–µ–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏"
        A[1920√ó1080] --> B[6 —Ç–∞–π–ª–æ–≤ √ó 258 = 1548]
    end
    
    subgraph "–° –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π"
        C[768√ó432] --> D[2 —Ç–∞–π–ª–∞ √ó 258 = 516]
    end
    
    B --> E[–≠–∫–æ–Ω–æ–º–∏—è: 67%]
    D --> E
```

### –†–µ–∞–ª—å–Ω—ã–µ —á–∏—Å–ª–∞

| –°—Ü–µ–Ω–∞—Ä–∏–π | 10 –∫–∞–¥—Ä–æ–≤ raw | 10 –∫–∞–¥—Ä–æ–≤ hd | –≠–∫–æ–Ω–æ–º–∏—è |
|----------|---------------|--------------|----------|
| 1080p –≤–∏–¥–µ–æ | 15480 —Ç–æ–∫–µ–Ω–æ–≤ | 5160 —Ç–æ–∫–µ–Ω–æ–≤ | **67%** |
| 4K –≤–∏–¥–µ–æ | 30960 —Ç–æ–∫–µ–Ω–æ–≤ | 5160 —Ç–æ–∫–µ–Ω–æ–≤ | **83%** |

---

### API —É—Ç–∏–ª–∏—Ç

```python
from semantic_core.infrastructure.media.utils.video import (
    extract_frames,
    frames_to_bytes,
    get_video_duration,
    QUALITY_PRESETS,
)

# –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∫–∞–¥—Ä–æ–≤
frames = extract_frames(
    video_path="tutorial.mp4",
    mode="total",           # total | fps | interval
    frame_count=10,         # –¥–ª—è mode="total"
    quality="hd",           # fhd | hd | balanced
    max_frames=50,          # –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è
)
# ‚Üí List[PIL.Image]

# –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –¥–ª—è API
frame_bytes = frames_to_bytes(frames, format="JPEG", quality=85)
# ‚Üí List[Tuple[bytes, str]]  # (data, mime_type)

# –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
duration = get_video_duration("movie.mp4")  # ‚Üí 3600.0 (—Å–µ–∫—É–Ω–¥—ã)
```

---

## üîß FFmpeg Dependency

### –ü—Ä–æ–±–ª–µ–º–∞

–û–±–µ —É—Ç–∏–ª–∏—Ç—ã (`audio.py`, `video.py`) –∑–∞–≤–∏—Å—è—Ç –æ—Ç **ffmpeg**:

- `pydub` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ffmpeg –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –∞—É–¥–∏–æ
- `imageio[pyav]` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç ffmpeg –¥–ª—è –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ

---

### –†–µ—à–µ–Ω–∏–µ: DependencyError

```python
class DependencyError(Exception):
    """–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å."""
    pass

def ensure_ffmpeg() -> None:
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ ffmpeg –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ–±—Ä–∞—â–µ–Ω–∏–∏."""
    if shutil.which("ffmpeg") is None:
        raise DependencyError(
            "ffmpeg not found in PATH.\n"
            "Install: brew install ffmpeg (macOS) or apt install ffmpeg (Linux)"
        )
```

---

### User Experience

```mermaid
sequenceDiagram
    participant User
    participant Utils as audio.py
    participant System as shutil.which
    
    User->>Utils: optimize_audio_to_bytes()
    Utils->>System: which("ffmpeg")
    alt FFmpeg –Ω–∞–π–¥–µ–Ω
        System-->>Utils: /usr/bin/ffmpeg
        Utils-->>User: bytes
    else FFmpeg –Ω–µ –Ω–∞–π–¥–µ–Ω
        System-->>Utils: None
        Utils->>User: DependencyError —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π
    end
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∞ –Ω–µ –∫—Ä–∏–ø—Ç–∏—á–Ω—É—é –æ—à–∏–±–∫—É pydub.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

### –ê—É–¥–∏–æ: –ë–∏—Ç—Ä–µ–π—Ç vs –ö–∞—á–µ—Å—Ç–≤–æ

| –ë–∏—Ç—Ä–µ–π—Ç | 1 —á–∞—Å –∞—É–¥–∏–æ | –ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ—á–∏ | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è |
|---------|-------------|---------------|--------------|
| 128 kbps | 57 MB ‚ùå | ‚úÖ‚úÖ‚úÖ –û—Ç–ª–∏—á–Ω–æ | –ù–µ –≤–ª–µ–∑–µ—Ç |
| 64 kbps | 28.5 MB ‚ö†Ô∏è | ‚úÖ‚úÖ –•–æ—Ä–æ—à–æ | 2 —á–∞—Å—Ç–∏ |
| 32 kbps | 14 MB ‚úÖ | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ | **–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è** |
| 16 kbps | 7 MB ‚úÖ | ‚ö†Ô∏è –£—Ö—É–¥—à–µ–Ω–∏–µ | –ù–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |

---

### –í–∏–¥–µ–æ: –ö–∞—á–µ—Å—Ç–≤–æ vs –¢–æ–∫–µ–Ω—ã

| Preset | 1080p ‚Üí | –¢–æ–∫–µ–Ω–æ–≤ | –ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞ |
|--------|---------|---------|------------------|
| `fhd` | 1024 px | 774 | ‚úÖ‚úÖ –•–æ—Ä–æ—à–æ –¥–ª—è OCR |
| `hd` | 768 px | 516 | ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ |
| `balanced` | 512 px | 258 | ‚ö†Ô∏è –ú–µ–ª–∫–∏–π —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞–¥–∞–µ—Ç |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. –ö–æ–≥–¥–∞ –ù–ï –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å

| –°—Ü–µ–Ω–∞—Ä–∏–π | –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|-------------|---------|
| OCR –º–µ–ª–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ | `fhd` | –ù—É–∂–Ω–æ –∫–∞—á–µ—Å—Ç–≤–æ |
| –ê—É–¥–∏–æ–∫–Ω–∏–≥–∏ (–∫–∞—á–µ—Å—Ç–≤–æ –≤–∞–∂–Ω–æ) | 64 kbps | –°–ª—É—à–∞—Ç–µ–ª–∏ –ø—Ä–∏–≤—ã–∫–ª–∏ |
| –ö–æ—Ä–æ—Ç–∫–∏–µ –∫–ª–∏–ø—ã (<1 –º–∏–Ω) | –ù–µ –Ω—É–∂–Ω–∞ | –ò —Ç–∞–∫ –≤–ª–µ–∑–∞—é—Ç |

---

### 2. Pillow –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–£—Ç–∏–ª–∏—Ç—ã –≤–∏–¥–µ–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç Pillow –¥–ª—è —Ä–µ—Å–∞–π–∑–∞:

```python
from PIL import Image

def _resize_frame(img: Image.Image, max_dim: int) -> Image.Image:
    if max(img.size) <= max_dim:
        return img  # –ù–µ —Ä–µ—Å–∞–π–∑–∏—Ç—å –º–∞–ª–µ–Ω—å–∫–∏–µ
    
    ratio = max_dim / max(img.size)
    new_size = (int(img.width * ratio), int(img.height * ratio))
    return img.resize(new_size, Image.Resampling.LANCZOS)
```

---

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø–æ—Ä—Ü–∏–π

–†–µ—Å–∞–π–∑ **–≤—Å–µ–≥–¥–∞** —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏:

| –ò—Å—Ö–æ–¥–Ω—ã–π | max_dim=768 | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|----------|-------------|-----------|
| 1920√ó1080 | 768√ó432 | –ü—Ä–æ–ø–æ—Ä—Ü–∏–∏ OK |
| 1080√ó1920 | 432√ó768 | –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ OK |
| 1000√ó1000 | 768√ó768 | –ö–≤–∞–¥—Ä–∞—Ç OK |

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **–ü—Ä–µ–¥—ã–¥—É—â–∏–π**: [Video Multimodal Analysis](31_video_multimodal_analysis.md)
- **–ê—É–¥–∏–æ –∞–Ω–∞–ª–∏–∑**: [Audio Analysis Architecture](30_audio_analysis_architecture.md)
- **–¢–æ–∫–µ–Ω—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**: [Gemini Vision Integration](26_gemini_vision_integration.md)

---

**‚Üê [Video Multimodal Analysis](31_video_multimodal_analysis.md)** | **[00_overview.md](00_overview.md) ‚Üí**
