# ğŸ‘· Episode 43: Queue & Worker Commands

> *"In the land of async, one worker to process them all."*

## ğŸ¬ Previously...

Ğ’ [Episode 42](42_cli_commands.md) Ğ¼Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ Ñ‚Ñ€Ğ¸ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: `ingest`, `search`, `docs`. ĞĞ¾ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° ÑƒĞ¼ĞµĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾ â€” Batch API, Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ°-Ğ·Ğ°Ğ´Ğ°Ñ‡. ĞšĞ°Ğº ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ÑÑ‚ÑŒ ÑÑ‚Ğ¸Ğ¼ Ğ¸Ğ· Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ°Ğ»Ğ°?

---

## ğŸ¯ ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°: ĞĞµĞ²Ğ¸Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸

ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑˆÑŒ `mode='async'`, Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ:

```
semantic ingest ./docs/ --mode async
âœ… Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ: 45 Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
```

ĞĞ¾ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼... Ñ‚Ğ¸ÑˆĞ¸Ğ½Ğ°. Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚?

- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸?
- Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ failed?
- ĞšĞ°Ğº Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ?

---

## ğŸ’¡ Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: Ğ”Ğ²Ğµ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´

```
semantic queue status   # ğŸ“Š Ğ§Ñ‚Ğ¾ Ğ² Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸?
semantic queue flush    # ğŸ—‘ï¸ ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑŒ
semantic queue retry    # ğŸ”„ ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚ÑŒ failed

semantic worker run-once  # ğŸ‘· ĞĞ´Ğ¸Ğ½ Ñ†Ğ¸ĞºĞ» Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸
semantic worker start     # ğŸ‘· Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ¾Ñ€ĞºĞµÑ€
```

---

## ğŸ“Š ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: queue status

### Ğ”Ğ²Ğµ Ğ¾Ñ‡ĞµÑ€ĞµĞ´Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Semantic Core Queues                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚       Text Queue            â”‚       Media Queue          â”‚
â”‚   (Embedding Batches)       â”‚   (Vision/Audio/Video)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ChunkModel                  â”‚ MediaTaskModel             â”‚
â”‚ + embedding_status          â”‚ + status                   â”‚
â”‚                             â”‚                            â”‚
â”‚ â³ pending                  â”‚ â³ pending                 â”‚
â”‚ ğŸ“¤ submitted                â”‚ ğŸ”„ processing              â”‚
â”‚ âœ… completed                â”‚ âœ… completed               â”‚
â”‚ âŒ failed                   â”‚ âŒ failed                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´

```bash
$ semantic queue status

â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ“¦ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚                                                          â”‚
â”‚ ğŸ“ Text Queue (Embeddings)                               â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”“                               â”‚
â”‚ â”ƒ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ       â”ƒ ĞšĞ¾Ğ»-Ğ²Ğ¾  â”ƒ                               â”‚
â”‚ â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”©                               â”‚
â”‚ â”‚ â³ pending   â”‚ 45      â”‚                               â”‚
â”‚ â”‚ ğŸ“¤ submitted â”‚ 12      â”‚                               â”‚
â”‚ â”‚ âœ… completed â”‚ 1,234   â”‚                               â”‚
â”‚ â”‚ âŒ failed    â”‚ 3       â”‚                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                          â”‚
â”‚ ğŸ¬ Media Queue                                           â”‚
â”‚ â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”³â”â”â”â”â”â”â”â”â”â”“                               â”‚
â”‚ â”ƒ Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ       â”ƒ ĞšĞ¾Ğ»-Ğ²Ğ¾  â”ƒ                               â”‚
â”‚ â”¡â”â”â”â”â”â”â”â”â”â”â”â”â”â”â•‡â”â”â”â”â”â”â”â”â”â”©                               â”‚
â”‚ â”‚ â³ pending   â”‚ 8       â”‚                               â”‚
â”‚ â”‚ âœ… completed â”‚ 156     â”‚                               â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                                          â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

### JSON Ğ´Ğ»Ñ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²

```bash
$ semantic queue status --json | jq '.text.pending'
45
```

ĞĞ¿Ñ†Ğ¸Ñ `--json` â€” Ğ¼Ğ°ÑˆĞ¸Ğ½Ğ½Ñ‹Ğ¹ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ´Ğ»Ñ CI/CD.

---

## ğŸ—‘ï¸ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: queue flush

### Ğ—Ğ°Ñ‡ĞµĞ¼ Ğ¾Ñ‡Ğ¸Ñ‰Ğ°Ñ‚ÑŒ?

ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ‚Ñ‹ÑÑÑ‡ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹ Ñ€Ğ°ÑĞ¿ÑƒÑ…Ğ°ÑÑ‚. `completed` Ğ¸ `failed` Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹.

### Ğ“Ñ€Ğ°Ğ½ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ

```bash
# ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘ (Ñ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸ĞµĞ¼)
semantic queue flush
âš ï¸ Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ 1,390 Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹? [y/N]

# Ğ‘ĞµĞ· Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ñ
semantic queue flush --confirm

# Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½Ğ½Ñ‹Ğµ
semantic queue flush --status completed

# Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ text queue
semantic queue flush --type text
```

### ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼

```
flush(type, status, confirm)
    â”‚
    â”œâ”€ Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ (ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚ --confirm)
    â”‚
    â”œâ”€ text queue? â†’ DELETE FROM chunks WHERE status IN (...)
    â”‚
    â””â”€ media queue? â†’ DELETE FROM media_tasks WHERE status IN (...)
```

---

## ğŸ”„ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: queue retry

### ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° failed Ğ·Ğ°Ğ´Ğ°Ñ‡

Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ°Ğ´Ğ°ÑÑ‚ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğ¼ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°Ğ¼:
- Rate limit (429)
- Ğ¡ĞµÑ‚ĞµĞ²Ğ¾Ğ¹ timeout
- Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ API

### Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ: ÑĞ±Ñ€Ğ¾Ñ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°

```bash
$ semantic queue retry --type text
ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ¾: 3 Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸
```

**Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚:** `status = 'failed'` â†’ `status = 'pending'`

Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ¿Ğ°Ğ´ÑƒÑ‚ Ğ² ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ Ñ†Ğ¸ĞºĞ» Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸.

---

## ğŸ‘· ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: worker run-once

### Use Case: Cron / CI

Ğ˜Ğ½Ğ¾Ğ³Ğ´Ğ° Ğ½ÑƒĞ¶ĞµĞ½ **Ğ¾Ğ´Ğ¸Ğ½ Ñ†Ğ¸ĞºĞ»** Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸:

```bash
# Ğ’ crontab: ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚
*/5 * * * * semantic worker run-once --max-tasks 100
```

### Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°ĞµÑ‚

```
run-once
    â”‚
    â”œâ”€ _sync_batch_statuses()
    â”‚   â””â”€ ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑÑ‹ Batch API Ğ·Ğ°Ğ´Ğ°Ğ½Ğ¸Ğ¹
    â”‚
    â””â”€ _process_media_queue(batch_size)
        â””â”€ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ N Ğ·Ğ°Ğ´Ğ°Ñ‡ Ğ¸Ğ· media queue
```

### Ğ’Ñ‹Ğ²Ğ¾Ğ´

```bash
$ semantic worker run-once
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ‘· Worker Run-Once â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ batch ÑÑ‚Ğ°Ñ‚ÑƒÑĞ¾Ğ²: 5             â”‚
â”‚ ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ·Ğ°Ğ´Ğ°Ñ‡: 8                â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯
```

---

## ğŸ‘· ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: worker start

### Use Case: ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ

Ğ”Ğ»Ñ production Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ÑÑ‰Ğ¸Ğ¹ Ğ²Ğ¾Ñ€ĞºĞµÑ€:

```bash
$ semantic worker start --batch-size 20 --poll-interval 10
ğŸ‘· Worker Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½ (batch=20, interval=10s)
ğŸ”„ Ğ¦Ğ¸ĞºĞ» 1: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ 15 Ğ·Ğ°Ğ´Ğ°Ñ‡
ğŸ”„ Ğ¦Ğ¸ĞºĞ» 2: Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ 8 Ğ·Ğ°Ğ´Ğ°Ñ‡
...
```

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    worker start lifecycle                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Register SIGINT â”‚                                           â”‚
â”‚  â”‚ handler         â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚           â”‚                                                    â”‚
â”‚           â–¼                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚ while not       â”‚â”€â”€â”€â”€â–ºâ”‚ sync_batches()  â”‚                   â”‚
â”‚  â”‚ shutdown        â”‚     â”‚ process_media() â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                       â”‚                            â”‚
â”‚           â”‚                       â–¼                            â”‚
â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚           â”‚              â”‚ sleep(interval) â”‚                   â”‚
â”‚           â”‚              â”‚ (interruptible) â”‚                   â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚           â”‚                       â”‚                            â”‚
â”‚           â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚           â”‚                                                    â”‚
â”‚           â–¼ (Ctrl+C)                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚ Graceful        â”‚                                           â”‚
â”‚  â”‚ shutdown        â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Graceful Shutdown

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** `Ctrl+C` Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ¼Ğ³Ğ½Ğ¾Ğ²ĞµĞ½Ğ½Ğ¾.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** Signal handler:

```python
_shutdown_requested = False

def _signal_handler(signum, frame):
    global _shutdown_requested
    _shutdown_requested = True
    print("âš ï¸ ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½ ÑĞ¸Ğ³Ğ½Ğ°Ğ» Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸...")

# Ğ’ worker start:
signal.signal(signal.SIGINT, _signal_handler)

while not _shutdown_requested:
    process_queue()
    interruptible_sleep(poll_interval)
```

### Interruptible Sleep

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°:** `time.sleep(60)` Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ½Ğ° 60 ÑĞµĞºÑƒĞ½Ğ´ â€” Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ¶Ğ´Ğ°Ñ‚ÑŒ shutdown.

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:** ĞŸĞ¾ÑĞµĞºÑƒĞ½Ğ´Ğ½Ñ‹Ğ¹ sleep Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¾Ğ¹:

```python
for _ in range(int(poll_interval)):
    if _shutdown_requested:
        break
    time.sleep(1)
```

ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ° shutdown: **1 ÑĞµĞºÑƒĞ½Ğ´Ğ°**.

---

## ğŸ¨ EMOJI_MAP Extensions

Ğ”Ğ»Ñ CLI Ğ»Ğ¾Ğ³Ğ¾Ğ² Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ñ‹ Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:

| ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ | Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸ | ĞšĞ¾Ğ³Ğ´Ğ° |
|---------|--------|-------|
| `cli` | ğŸ–¥ï¸ | CLI Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ² Ñ†ĞµĞ»Ğ¾Ğ¼ |
| `commands` | ğŸ–¥ï¸ | ĞŸĞ¾Ğ´Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ commands |
| `worker` | ğŸ‘· | Worker-ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³Ğ¸ |

### ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²

```python
get_module_emoji("semantic_core.cli.commands.queue")
# â†’ "ğŸ“¦" (queue Ğ±Ğ¾Ğ»ĞµĞµ ÑĞ¿ĞµÑ†Ğ¸Ñ„Ğ¸Ñ‡ĞµĞ½ Ñ‡ĞµĞ¼ commands)

get_module_emoji("semantic_core.cli.commands.worker")
# â†’ "ğŸ‘·" (worker Ğ² EMOJI_MAP)
```

---

## ğŸ§ª Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### 30 unit-Ñ‚ĞµÑÑ‚Ğ¾Ğ²

```
TestQueueStatusCommand    (7 tests)  - help, filters, json output
TestQueueFlushCommand     (5 tests)  - confirm, status filters
TestQueueRetryCommand     (4 tests)  - type filters, max-tasks
TestWorkerRunOnceCommand  (5 tests)  - flags, json output
TestWorkerStartCommand    (4 tests)  - options, signal handler
TestEmojiMapUpdates       (3 tests)  - new entries
TestHelpersAndUtilities   (2 tests)  - internal functions
```

### Ğ§Ñ‚Ğ¾ Ğ¼Ğ¾ĞºĞ°ĞµÑ‚ÑÑ

```python
@patch("semantic_core.cli.commands.worker.get_cli_context")
@patch("semantic_core.cli.commands.worker._process_media_queue")
def test_worker_run_once(...):
    # ĞĞµ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ core
```

---

## ğŸ“‹ Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¸

### ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ² CI/CD

```bash
#!/bin/bash
status=$(semantic queue status --json)
pending=$(echo $status | jq '.text.pending + .media.pending')

if [ $pending -gt 100 ]; then
    echo "âš ï¸ Queue backlog: $pending tasks"
    semantic worker run-once --max-tasks 50
fi
```

### Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ğ°Ñ Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°

```bash
# Cron: Ñ€Ğ°Ğ· Ğ² Ğ´ĞµĞ½ÑŒ
0 3 * * * semantic queue flush --status completed --confirm
```

### Background worker

```bash
# systemd Ğ¸Ğ»Ğ¸ supervisor
semantic worker start --batch-size 50 --poll-interval 30
```

---

## ğŸ”— Ğ¡Ğ²ÑĞ·Ğ¸ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ğ°Ğ¼Ğ¸

```
Episode 43 (Queue & Worker)
    â”‚
    â”œâ”€â”€ Uses: Episode 22 (BatchManager)
    â”‚         - sync_completed(), get_pending_batches()
    â”‚
    â”œâ”€â”€ Uses: Episode 29 (MediaQueueProcessor)
    â”‚         - process_batch(), get_queue_stats()
    â”‚
    â”œâ”€â”€ Uses: Episode 41 (CLIContext)
    â”‚         - get_core() lazy initialization
    â”‚
    â””â”€â”€ Uses: Episode 36 (EMOJI_MAP)
              - Visual semantics in logs
```

---

## ğŸ“Š Summary

| ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° | ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ | ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğ¹ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ |
|---------|------------|------------------|
| `queue status` | Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹ | JSON output Ğ´Ğ»Ñ CI |
| `queue flush` | ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹ | Ğ“Ñ€Ğ°Ğ½ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ñ‹ |
| `queue retry` | ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº failed | Status reset |
| `worker run-once` | ĞĞ´Ğ¸Ğ½ Ñ†Ğ¸ĞºĞ» | Cron-friendly |
| `worker start` | Continuous | Graceful shutdown |

---

## ğŸ¯ Ğ˜Ñ‚Ğ¾Ğ³

Phase 8 Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°. CLI Semantic Core Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ĞµĞ½:

```bash
semantic init           # 8.3 â€” Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
semantic config show    # 8.3 â€” ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ
semantic doctor         # 8.3 â€” Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°
semantic ingest         # 8.0 â€” Ğ˜Ğ½Ğ´ĞµĞºÑĞ°Ñ†Ğ¸Ñ
semantic search         # 8.0 â€” ĞŸĞ¾Ğ¸ÑĞº
semantic docs           # 8.0 â€” Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ñ
semantic queue status   # 8.1 â€” ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ĞµĞ¹
semantic worker start   # 8.1 â€” Background Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ°
```

ĞÑ‚ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Ğ´Ğ¾ production-ready CLI â€” Ğ² 8 ÑĞ¿Ğ¸Ğ·Ğ¾Ğ´Ğ°Ñ….

---

**â† [ĞĞ°Ğ·Ğ°Ğ´ Ğº Episode 42](42_cli_commands.md)** | **[ĞĞ³Ğ»Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ](00_overview.md)**
