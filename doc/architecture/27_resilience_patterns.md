# üõ°Ô∏è Resilience Patterns

> –ö–∞–∫ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –ø–µ—Ä–µ–∂–∏–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–±–æ–∏ API –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Resilience Patterns** ‚Äî –Ω–∞–±–æ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è —É—Å—Ç–æ–π—á–∏–≤–æ–π —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º–∏ API:
- **Retry with Backoff** ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ —Å —É–≤–µ–ª–∏—á–∏–≤–∞—é—â–µ–π—Å—è –∑–∞–¥–µ—Ä–∂–∫–æ–π
- **Error Classification** ‚Äî —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –Ω–∞ "–º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å" –∏ "–Ω–µ–ª—å–∑—è"
- **Graceful Degradation** ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

**–ü—Ä–æ–±–ª–µ–º–∞**: Gemini API –º–æ–∂–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å:
- 429 ‚Äî –ø—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
- 503 ‚Äî —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- Timeout ‚Äî —Å–µ—Ç—å –º–µ–¥–ª–µ–Ω–Ω–∞—è

–ë–µ–∑ –æ–±—Ä–∞–±–æ—Ç–∫–∏: –ø–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö, —Å–±–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–†–µ—à–µ–Ω–∏–µ**: –ö–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏ retry —Ç–æ–ª—å–∫–æ —Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –ø—Ä–æ–π—Ç–∏ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–µ.

---

## üîç –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –æ—à–∏–±–æ–∫

### Retryable vs Non-Retryable

```mermaid
graph TD
    E[–û—à–∏–±–∫–∞] --> C{–¢–∏–ø –æ—à–∏–±–∫–∏?}
    C -->|429, 503, 500| R[Retryable ‚úÖ]
    C -->|Timeout| R
    C -->|Connection Error| R
    C -->|ValueError| N[Non-Retryable ‚ùå]
    C -->|KeyError| N
    C -->|Invalid Input| N
    
    R --> W[–ü–æ–¥–æ–∂–¥–∞—Ç—å + –ü–æ–≤—Ç–æ—Ä–∏—Ç—å]
    N --> F[–°—Ä–∞–∑—É –≤—ã–±—Ä–æ—Å–∏—Ç—å]
```

---

### –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏

| –û—à–∏–±–∫–∞ | –ö–æ–¥ | Retryable? | –ü—Ä–∏—á–∏–Ω–∞ |
|--------|-----|------------|---------|
| Rate Limit | 429 | ‚úÖ | –ß–µ—Ä–µ–∑ –≤—Ä–µ–º—è –ª–∏–º–∏—Ç —Å–±—Ä–æ—Å–∏—Ç—Å—è |
| Service Unavailable | 503 | ‚úÖ | –°–µ—Ä–≤–∏—Å —Å–∫–æ—Ä–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è |
| Internal Error | 500 | ‚úÖ | –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |
| Timeout | ‚Äî | ‚úÖ | –°–µ—Ç—å –º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è |
| Connection Reset | ‚Äî | ‚úÖ | –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å–µ—Ç–∏ |
| Invalid API Key | 401 | ‚ùå | –ù–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–æ–º |
| Bad Request | 400 | ‚ùå | –û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö |
| ValueError | ‚Äî | ‚ùå | –ë–∞–≥ –≤ –∫–æ–¥–µ |

---

### –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è retryable

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è **—Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏** –Ω–∞ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã:

| –ü–∞—Ç—Ç–µ—Ä–Ω | –ß—Ç–æ –∏—â–µ–º |
|---------|----------|
| HTTP –∫–æ–¥—ã | "429", "503", "500" |
| –¢–∞–π–º–∞—É—Ç—ã | "timeout", "timed out" |
| –°–µ—Ç—å | "connection", "reset", "refused" |

**–í–∞–∂–Ω–æ**: –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ ‚Äî –æ–Ω–∞ **non-retryable**.

---

## üîÑ Exponential Backoff

### –ò–¥–µ—è

–ö–∞–∂–¥–∞—è —Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∂–¥—ë—Ç **–¥–æ–ª—å—à–µ** –ø—Ä–µ–¥—ã–¥—É—â–µ–π:

```
–ü–æ–ø—ã—Ç–∫–∞ 1: —Å—Ä–∞–∑—É
–ü–æ–ø—ã—Ç–∫–∞ 2: –ø–æ–¥–æ–∂–¥–∞—Ç—å 1 —Å–µ–∫
–ü–æ–ø—ã—Ç–∫–∞ 3: –ø–æ–¥–æ–∂–¥–∞—Ç—å 2 —Å–µ–∫
–ü–æ–ø—ã—Ç–∫–∞ 4: –ø–æ–¥–æ–∂–¥–∞—Ç—å 4 —Å–µ–∫
...
```

**–ó–∞—á–µ–º**: –î–∞—ë—Ç —Å–µ—Ä–≤–µ—Ä—É –≤—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è, –Ω–µ "–¥–æ–ª–±–∏–º" –µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞–º–∏.

---

### –§–æ—Ä–º—É–ª–∞ –∑–∞–¥–µ—Ä–∂–∫–∏

```
delay = min(base_delay √ó 2^attempt + jitter, max_delay)
```

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|----------|------------|
| `base_delay` | 1.0 —Å–µ–∫ | –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ |
| `2^attempt` | 1, 2, 4, 8... | –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Ç |
| `jitter` | 0-1 —Å–µ–∫ | –°–ª—É—á–∞–π–Ω—ã–π —Ä–∞–∑–±—Ä–æ—Å |
| `max_delay` | 30 —Å–µ–∫ | –ü–æ—Ç–æ–ª–æ–∫ –∑–∞–¥–µ—Ä–∂–∫–∏ |

---

### –ü—Ä–∏–º–µ—Ä –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

| –ü–æ–ø—ã—Ç–∫–∞ | –†–∞—Å—á—ë—Ç | –ó–∞–¥–µ—Ä–∂–∫–∞ |
|---------|--------|----------|
| 1 | ‚Äî | 0 (—Å—Ä–∞–∑—É) |
| 2 | 1√ó2¬π + 0.3 | ~2.3 —Å–µ–∫ |
| 3 | 1√ó2¬≤ + 0.7 | ~4.7 —Å–µ–∫ |
| 4 | 1√ó2¬≥ + 0.5 | ~8.5 —Å–µ–∫ |
| 5 | 1√ó2‚Å¥ + 0.2 | ~16.2 —Å–µ–∫ |

---

### –ó–∞—á–µ–º jitter?

**–ü—Ä–æ–±–ª–µ–º–∞**: –ï—Å–ª–∏ 100 –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ–ª—É—á–∏–ª–∏ 429 –∏ –≤—Å–µ –∂–¥—É—Ç —Ä–æ–≤–Ω–æ 2 —Å–µ–∫—É–Ω–¥—ã ‚Äî —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –≤—Å–µ 100 —Å–Ω–æ–≤–∞ —É–¥–∞—Ä—è—Ç –ø–æ API –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ.

**–†–µ—à–µ–Ω–∏–µ**: –°–ª—É—á–∞–π–Ω—ã–π jitter (0-1 —Å–µ–∫) —Ä–∞–∑–Ω–æ—Å–∏—Ç –∑–∞–ø—Ä–æ—Å—ã –≤–æ –≤—Ä–µ–º–µ–Ω–∏.

```mermaid
graph LR
    subgraph "–ë–µ–∑ jitter"
        A1[–ö–ª–∏–µ–Ω—Ç 1] --> T1[2.0 —Å–µ–∫]
        A2[–ö–ª–∏–µ–Ω—Ç 2] --> T1
        A3[–ö–ª–∏–µ–Ω—Ç 3] --> T1
    end
    
    subgraph "–° jitter"
        B1[–ö–ª–∏–µ–Ω—Ç 1] --> T2[2.3 —Å–µ–∫]
        B2[–ö–ª–∏–µ–Ω—Ç 2] --> T3[1.8 —Å–µ–∫]
        B3[–ö–ª–∏–µ–Ω—Ç 3] --> T4[2.7 —Å–µ–∫]
    end
```

---

## üì¶ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä @retry_with_backoff

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

```python
@retry_with_backoff(max_retries=5, base_delay=1.0, max_delay=30.0)
def call_gemini_api(image_path: str) -> dict:
    # –ú–æ–∂–µ—Ç –≤—ã–±—Ä–æ—Å–∏—Ç—å 429, 503, timeout...
    return gemini.generate_content(...)
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç**:
1. –§—É–Ω–∫—Ü–∏—è –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
2. –ï—Å–ª–∏ retryable –æ—à–∏–±–∫–∞ ‚Üí –∂–¥—ë–º ‚Üí –ø–æ–≤—Ç–æ—Ä—è–µ–º
3. –ï—Å–ª–∏ non-retryable ‚Üí —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ–º
4. –ü–æ—Å–ª–µ N –ø–æ–ø—ã—Ç–æ–∫ ‚Üí `MediaProcessingError`

---

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|--------------|----------|
| `max_retries` | 5 | –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫ |
| `base_delay` | 1.0 | –ë–∞–∑–æ–≤–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫) |
| `max_delay` | 30.0 | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ (—Å–µ–∫) |

---

### –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–∏

–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `@functools.wraps`, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å:
- `__name__` ‚Äî –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏
- `__doc__` ‚Äî docstring

–≠—Ç–æ –≤–∞–∂–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.

---

## ‚ö†Ô∏è MediaProcessingError

### –ö–æ–≥–¥–∞ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è

–ü–æ—Å–ª–µ –∏—Å—á–µ—Ä–ø–∞–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ:

```
MediaProcessingError: Failed after 5 retries: 429 Resource Exhausted
```

**–°–æ–¥–µ—Ä–∂–∏—Ç**:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
- –¢–µ–∫—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—à–∏–±–∫–∏
- Chain –∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–º—É –∏—Å–∫–ª—é—á–µ–Ω–∏—é (`__cause__`)

---

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

```python
try:
    result = analyzer.analyze(image_path)
except MediaProcessingError as e:
    # –í—Å–µ retry –∏—Å—á–µ—Ä–ø–∞–Ω—ã
    logger.error(f"Image analysis failed: {e}")
    task.status = "failed"
    task.error_message = str(e)
    task.save()
```

**–í–∞–∂–Ω–æ**: –ó–∞–¥–∞—á–∞ –Ω–µ —Ç–µ—Ä—è–µ—Ç—Å—è ‚Äî –æ–Ω–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º `failed` –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –∏–ª–∏ —Ä—É—á–Ω–æ–≥–æ retry.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π

| –°—Ç—Ä–∞—Ç–µ–≥–∏—è | –ü–ª—é—Å—ã | –ú–∏–Ω—É—Å—ã |
|-----------|-------|--------|
| –ë–µ–∑ retry | –ü—Ä–æ—Å—Ç–æ—Ç–∞ | –ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–±–æ—è—Ö |
| –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π delay | –ü—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ—Å—Ç—å | –ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤—ã—Ö —Å–±–æ—è—Ö |
| Exponential backoff | –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å | –î–æ–ª–≥–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ |
| Backoff + jitter | ‚úÖ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ | –ß—É—Ç—å —Å–ª–æ–∂–Ω–µ–µ |

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. –ù–µ retry –±–∏–∑–Ω–µ—Å-–æ—à–∏–±–∫–∏

‚ùå **–ü–ª–æ—Ö–æ**: retry –Ω–∞ `ValueError("Invalid image format")`

–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏—Å–ø—Ä–∞–≤–∏—Ç—Å—è –ø–æ–≤—Ç–æ—Ä–æ–º. –¢–æ–ª—å–∫–æ —Ç—Ä–∞—Ç–∏–º –≤—Ä–µ–º—è.

‚úÖ **–•–æ—Ä–æ—à–æ**: —Å—Ä–∞–∑—É –≤—ã–±—Ä–æ—Å–∏—Ç—å, –ø—É—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–∏—Ç.

---

### 2. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫

–ö–∞–∂–¥–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è:

```
[WARNING] Retry 1/5 after 429: waiting 2.3s
[WARNING] Retry 2/5 after 429: waiting 4.7s
[INFO] Success on attempt 3
```

–≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å API.

---

### 3. Timeout –Ω–∞ –≤–µ—Å—å retry-—Ü–∏–∫–ª

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç **–æ–±—â–µ–µ** –≤—Ä–µ–º—è retry. –ü—Ä–∏ 5 –ø–æ–ø—ã—Ç–∫–∞—Ö —Å max_delay=30 –º–æ–∂–Ω–æ –∂–¥–∞—Ç—å –¥–æ 2+ –º–∏–Ω—É—Ç.

–î–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å circuit breaker (Phase 7?).

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **–ü—Ä–µ–¥—ã–¥—É—â–∏–π**: [Gemini Vision Integration](26_gemini_vision_integration.md)
- **–°–ª–µ–¥—É—é—â–∏–π**: [Rate Limiting](28_rate_limiting.md) ‚Äî –ø—Ä–µ–≤–µ–Ω—Ç–∏–≤–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç 429
- **–û—á–µ—Ä–µ–¥—å**: [Media Queue Processor](29_media_queue_processor.md) ‚Äî graceful degradation

---

**‚Üê [Gemini Vision Integration](26_gemini_vision_integration.md)** | **[Rate Limiting](28_rate_limiting.md) ‚Üí**
