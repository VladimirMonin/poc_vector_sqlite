# ๐ Episode 44: RAG Engine Architecture

> ะะฐะบ ัะฒัะทะฐัั ัะตะผะฐะฝัะธัะตัะบะธะน ะฟะพะธัะบ ั ะณะตะฝะตัะฐัะธะตะน ะพัะฒะตัะพะฒ

---

## ๐ฏ ะะฐัะตะผ RAG?

ะัะตะดััะฐะฒั ัะธััะฐัะธั: ั ัะตะฑั ะตััั ะฑะฐะทะฐ ะดะพะบัะผะตะฝัะพะฒ (ะทะฐะผะตัะบะธ, ััะฐััะธ, ะบะพะด). ะขั ัะพัะตัั **ะทะฐะดะฐัั ะฒะพะฟัะพั** ะธ ะฟะพะปััะธัั ะพัะฒะตั, ะพัะฝะพะฒะฐะฝะฝัะน ะฝะฐ ัะฒะพะธั ะดะฐะฝะฝัั.

**ะะฑััะฝัะน LLM** (ChatGPT, Gemini):
- ะัะฒะตัะฐะตั ะฝะฐ ะพัะฝะพะฒะต ัะฒะพะธั ะทะฝะฐะฝะธะน (training data)
- ะะต ะทะฝะฐะตั ัะฒะพะธั ะดะพะบัะผะตะฝัะพะฒ
- ะะพะถะตั "ะณะฐะปะปััะธะฝะธัะพะฒะฐัั"

**RAG (Retrieval-Augmented Generation)**:
- ะกะฝะฐัะฐะปะฐ **ะธัะตั** ัะตะปะตะฒะฐะฝัะฝัะต ะดะพะบัะผะตะฝัั
- ะะพัะพะผ **ะณะตะฝะตัะธััะตั** ะพัะฒะตั ะฝะฐ ะธั ะพัะฝะพะฒะต
- ะัะฒะตัั ะฟะพะดะบัะตะฟะปะตะฝั ัะตะฐะปัะฝัะผะธ ะดะฐะฝะฝัะผะธ

---

## ๐ง ะะฐะบ ัะฐะฑะพัะฐะตั RAG

```mermaid
sequenceDiagram
    participant U as ะะพะปัะทะพะฒะฐัะตะปั
    participant R as RAGEngine
    participant S as SemanticCore
    participant L as LLMProvider

    U->>R: "ะงัะพ ัะฐะบะพะต RRF?"
    R->>S: search_chunks("RRF")
    S-->>R: [ChunkResult, ChunkResult, ...]
    R->>R: ะคะพัะผะธััะตะผ ะบะพะฝัะตะบัั
    R->>L: generate(prompt + context)
    L-->>R: "RRF โ ััะพ ะฐะปะณะพัะธัะผ..."
    R-->>U: ะัะฒะตั + ะธััะพัะฝะธะบะธ
```

**ะขัะธ ัะฐะณะฐ:**

1. **Retrieval** โ ะฝะฐัะพะดะธะผ ัะตะปะตะฒะฐะฝัะฝัะต ัะฐะฝะบะธ
2. **Augmentation** โ ัะพัะผะธััะตะผ ะบะพะฝัะตะบัั ะธะท ะฝะฐะนะดะตะฝะฝะพะณะพ
3. **Generation** โ LLM ะพัะฒะตัะฐะตั ะฝะฐ ะพัะฝะพะฒะต ะบะพะฝัะตะบััะฐ

---

## ๐ฆ ะะพะผะฟะพะฝะตะฝัั ัะธััะตะผั

### ะะฝัะตััะตะนั LLM ะฟัะพะฒะฐะนะดะตัะฐ

RAG ะฝะต ะฟัะธะฒัะทะฐะฝ ะบ ะบะพะฝะบัะตัะฝะพะน ะผะพะดะตะปะธ. ะัะฑะพะน ะฟัะพะฒะฐะนะดะตั ัะตะฐะปะธะทัะตั ะพะฑัะธะน ะธะฝัะตััะตะนั:

| ะะตัะพะด | ะะฐะทะฝะฐัะตะฝะธะต |
|-------|------------|
| `generate()` | ะะตะฝะตัะฐัะธั ัะตะบััะฐ |
| `model_name` | ะะฐะทะฒะฐะฝะธะต ะผะพะดะตะปะธ |

**ะะตะทัะปััะฐั ะณะตะฝะตัะฐัะธะธ** ัะพะดะตัะถะธั:

- ะขะตะบัั ะพัะฒะตัะฐ
- ะะพะปะธัะตััะฒะพ ัะพะบะตะฝะพะฒ (input/output)
- ะัะธัะธะฝะฐ ะพััะฐะฝะพะฒะบะธ (STOP, MAX_TOKENS)

### RAGEngine

ะัะบะตัััะฐัะพั, ัะฒัะทัะฒะฐััะธะน ะฟะพะธัะบ ะธ ะณะตะฝะตัะฐัะธั:

| ะะฐัะฐะผะตัั | Default | ะะฟะธัะฐะฝะธะต |
|----------|---------|----------|
| `core` | โ | SemanticCore ะดะปั ะฟะพะธัะบะฐ |
| `llm` | โ | ะัะพะฒะฐะนะดะตั LLM |
| `context_chunks` | 5 | ะะพะปะธัะตััะฒะพ ัะฐะฝะบะพะฒ ะบะพะฝัะตะบััะฐ |
| `system_prompt` | Built-in | ะะฐััะพะผะฝัะน ะฟัะพะผะฟั |

### RAGResult

ะะตะทัะปััะฐั RAG-ะทะฐะฟัะพัะฐ:

| ะะพะปะต | ะขะธะฟ | ะะฟะธัะฐะฝะธะต |
|------|-----|----------|
| `answer` | str | ะกะณะตะฝะตัะธัะพะฒะฐะฝะฝัะน ะพัะฒะตั |
| `sources` | list | ะะฐะนะดะตะฝะฝัะต ะธััะพัะฝะธะบะธ |
| `generation` | GenerationResult | ะะตัะฐะดะฐะฝะฝัะต LLM |
| `query` | str | ะััะพะดะฝัะน ะฒะพะฟัะพั |
| `full_docs` | bool | ะะตะถะธะผ ะฟะพะปะฝัั ะดะพะบัะผะตะฝัะพะฒ |

---

## ๐ ะะฒะฐ ัะตะถะธะผะฐ ะบะพะฝัะตะบััะฐ

### ะะตะถะธะผ chunks (ะฟะพ ัะผะพะปัะฐะฝะธั)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะพะฟัะพั: "ะะฐะบ ัะฐะฑะพัะฐะตั RRF?"                                    โ
โ                                                                 โ
โ  ะะพะธัะบ โ 5 ัะฐะฝะบะพะฒ ะฟะพ ~500 ัะธะผะฒะพะปะพะฒ ะบะฐะถะดัะน                       โ
โ  ะะพะฝัะตะบัั โ 2.5k ัะพะบะตะฝะพะฒ                                        โ
โ                                                                 โ
โ  โ ะญะบะพะฝะพะผะธั ัะพะบะตะฝะพะฒ                                            โ
โ  โ ะััะพะบะฐั ัะพัะฝะพััั                                            โ
โ  โ ะะณัะฐะฝะธัะตะฝะฝัะน ะบะพะฝัะตะบัั                                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะตะถะธะผ full_docs

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ะะพะฟัะพั: "ะกัะผะผะฐัะธะทะธััะน ััะพั ะดะพะบัะผะตะฝั"                           โ
โ                                                                 โ
โ  ะะพะธัะบ โ ะฝะฐัะพะดะธะผ ัะฐะฝะบ โ ะทะฐะณััะถะฐะตะผ ะฒะตัั ะดะพะบัะผะตะฝั                 โ
โ  ะะพะฝัะตะบัั โ 10-50k ัะพะบะตะฝะพะฒ                                      โ
โ                                                                 โ
โ  โ ะะพะปะฝัะน ะบะพะฝัะตะบัั                                             โ
โ  โ ะะปั ััะผะผะฐัะธะทะฐัะธะธ                                            โ
โ  โ ะะพัะพะถะต ะฟะพ ัะพะบะตะฝะฐะผ                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ะะพะณะดะฐ ะบะฐะบะพะน ะธัะฟะพะปัะทะพะฒะฐัั?

| ะะฐะดะฐัะฐ | ะะตะถะธะผ | ะัะธัะธะฝะฐ |
|--------|-------|---------|
| FAQ, ัะพัะตัะฝัะต ะฒะพะฟัะพัั | chunks | ะัะถะฝั ะบะพะฝะบัะตัะฝัะต ัะฐะบัั |
| ะกัะผะผะฐัะธะทะฐัะธั | full_docs | ะัะถะตะฝ ะฒะตัั ะดะพะบัะผะตะฝั |
| ะะฝะฐะปะธะท ััััะบัััั | full_docs | ะะฐะถะฝั ัะฒัะทะธ ะผะตะถะดั ัะฐัััะผะธ |
| ะะพะธัะบ ะบะพะดะฐ | chunks | ะัะถะตะฝ ะบะพะฝะบัะตัะฝัะน ััะฐะณะผะตะฝั |

---

## ๐จ ะคะพัะผะธัะพะฒะฐะฝะธะต ะบะพะฝัะตะบััะฐ

### ะคะพัะผะฐั ะดะปั chunks

```
[1] architecture.md [text] (score: 0.95)
RRF (Reciprocal Rank Fusion) โ ะฐะปะณะพัะธัะผ ะพะฑัะตะดะธะฝะตะฝะธั ัะตะทัะปััะฐัะพะฒ...

---

[2] search.md [code] (python) (score: 0.82)
def hybrid_search(query, k=60):
    return 1 / (k + rank)

---

[3] examples.md [text] (score: 0.71)
ะัะธะผะตั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะณะธะฑัะธะดะฝะพะณะพ ะฟะพะธัะบะฐ...
```

**ะกัััะบัััะฐ ะฑะปะพะบะฐ:**
- ะะพะผะตั ะธััะพัะฝะธะบะฐ
- ะะฐะณะพะปะพะฒะพะบ ะดะพะบัะผะตะฝัะฐ
- ะขะธะฟ ัะฐะฝะบะฐ ะธ ัะทัะบ
- Score ัะตะปะตะฒะฐะฝัะฝะพััะธ
- ะกะพะดะตัะถะธะผะพะต

### ะคะพัะผะฐั ะดะปั full_docs

```
[1] architecture.md (score: 0.95)
# ะััะธัะตะบัััะฐ ะฟะพะธัะบะฐ

ะะพะบัะผะตะฝั ะฟะพะปะฝะพัััั...
ะะตัั ะบะพะฝัะตะฝั...

---

[2] search.md (score: 0.82)
# ะะพะธัะบ

ะะตัั ะดะพะบัะผะตะฝั ัะตะปะธะบะพะผ...
```

---

## ๐ ะกะธััะตะผะฝัะน ะฟัะพะผะฟั

RAGEngine ะธัะฟะพะปัะทัะตั ะฟัะพะดัะผะฐะฝะฝัะน ัะธััะตะผะฝัะน ะฟัะพะผะฟั:

**ะะปััะตะฒัะต ะฟัะฐะฒะธะปะฐ:**

1. ะัะฒะตัะฐะน **ะขะะะฌะะ** ะฝะฐ ะพัะฝะพะฒะต ะบะพะฝัะตะบััะฐ
2. ะัะปะธ ะธะฝัะพัะผะฐัะธะธ ะฝะตั โ ัะบะฐะถะธ ะพะฑ ััะพะผ
3. ะัะดั ะบัะฐัะบะธะผ ะธ ัะพัะฝัะผ
4. ะคะพัะผะฐัะธััะน ะฒ Markdown
5. ะฆะธัะธััะน ะธััะพัะฝะธะบะธ

**ะะพัะตะผั ััะพ ะฒะฐะถะฝะพ?**

- ะัะตะดะพัะฒัะฐัะฐะตั "ะณะฐะปะปััะธะฝะฐัะธะธ"
- ะคะพะบััะธััะตั ะพัะฒะตั ะฝะฐ ัะตะฐะปัะฝัั ะดะฐะฝะฝัั
- ะะฑะตัะฟะตัะธะฒะฐะตั ะฟัะพะฒะตััะตะผะพััั

### ะะฐััะพะผะฝัะต ะฟัะพะผะฟัั

ะะพะถะฝะพ ะทะฐะผะตะฝะธัั ะฟัะพะผะฟั ะฟะพะปะฝะพัััั:

```
# ะก placeholder {context}
"ะขั ัะบัะฟะตัั Python. ะัะฟะพะปัะทัะน ะบะพะฝัะตะบัั:\n{context}"

# ะะตะท placeholder โ ะบะพะฝัะตะบัั ะดะพะฑะฐะฒะธััั ะฒ ะบะพะฝะตั
"ะัะดั ะบัะฐัะพะบ ะธ ะฟะพะปะตะทะตะฝ."
```

---

## โ๏ธ ะะฐะถะฝัะต ะฝัะฐะฝัั

### ะะณัะฐะฝะธัะตะฝะธะต ะบะพะฝัะตะบััะฐ

ะะพะฝัะตะฝั ัะฐะฝะบะพะฒ ะพะฑัะตะทะฐะตััั ะดะพ 2000 ัะธะผะฒะพะปะพะฒ ะฝะฐ ะธััะพัะฝะธะบ:
- ะะฐัะธัะฐ ะพั ะฟะตัะตะฟะพะปะฝะตะฝะธั ะบะพะฝัะตะบััะฐ LLM
- ะัะธะผะตัะฝะพ 500 ัะพะบะตะฝะพะฒ ะฝะฐ ะธััะพัะฝะธะบ
- 5 ะธััะพัะฝะธะบะพะฒ โ 2500 ัะพะบะตะฝะพะฒ ะบะพะฝัะตะบััะฐ

### ะะฑัะตะทะบะฐ ะทะฐะณะพะปะพะฒะบะพะฒ

ะะปะธะฝะฝัะต ะฟััะธ ะบ ัะฐะนะปะฐะผ ะพะฑัะตะทะฐัััั:
```
/very/long/path/to/document.md
โ .../path/to/document.md
```

ะกะพััะฐะฝัะตะผ ะฟะพัะปะตะดะฝะธะต 47 ัะธะผะฒะพะปะพะฒ + "..."

### ะะฑัะฐะฑะพัะบะฐ ะฟััััั ัะตะทัะปััะฐัะพะฒ

ะัะปะธ ะฟะพะธัะบ ะฝะธัะตะณะพ ะฝะต ะฝะฐััะป:
- ะะพะฝัะตะบัั = "No relevant context found."
- LLM ัะตััะฝะพ ัะบะฐะถะตั, ััะพ ะฝะตั ะธะฝัะพัะผะฐัะธะธ

---

## ๐ ะกัะฐะฒะฝะตะฝะธะต ั ะฐะปััะตัะฝะฐัะธะฒะฐะผะธ

| ะัะฟะตะบั | ะัะพััะพะน LLM | RAG |
|--------|-------------|-----|
| ะััะพัะฝะธะบ ะทะฝะฐะฝะธะน | Training data | ะขะฒะพะธ ะดะพะบัะผะตะฝัั |
| ะะบััะฐะปัะฝะพััั | ะะฐัะฐ ะพะฑััะตะฝะธั | ะัะตะณะดะฐ ัะฒะตะถะธะต |
| ะะฐะปะปััะธะฝะฐัะธะธ | ะงะฐัััะต | ะะตะดะบะธะต |
| ะัะพะฒะตััะตะผะพััั | โ | โ ะััะพัะฝะธะบะธ |
| ะกัะพะธะผะพััั | ะขะพะปัะบะพ ะณะตะฝะตัะฐัะธั | ะะพะธัะบ + ะณะตะฝะตัะฐัะธั |

---

## ๐ ะกะปะตะดัััะธะต ัะฐะณะธ

**Episode 45** ัะฐััะบะฐะถะตั ะฟัะพ CLI ะธะฝัะตััะตะนั ะดะปั RAG โ ะบะฐะบ ะทะฐะดะฐะฒะฐัั ะฒะพะฟัะพัั ะธะท ัะตัะผะธะฝะฐะปะฐ.

---

**โ ะัะตะดัะดััะธะน**: [Episode 43: Queue & Worker Commands](43_queue_worker_commands.md)  
**โ ะกะปะตะดัััะธะน**: [Episode 45: RAG Chat Interface](45_rag_chat_interface.md)
