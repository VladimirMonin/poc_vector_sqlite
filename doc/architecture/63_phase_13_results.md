# üìä Phase 13: –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞—É–¥–∏—Ç–∞

> –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ, —á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è

---

## üéØ –û–±–∑–æ—Ä –º–µ—Ç—Ä–∏–∫

–ê—É–¥–∏—Ç –≤—ã—è–≤–∏–ª **127 —á–∞–Ω–∫–æ–≤**, **6 –º–µ–¥–∏–∞-—Ñ–∞–π–ª–æ–≤**, **14 –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤** —á–µ—Ä–µ–∑ —Ä–µ–∞–ª—å–Ω—ã–π Gemini API.

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –§–∞–π–ª–æ–≤/–ó–∞–ø—Ä–æ—Å–æ–≤ | –£—Å–ø–µ—à–Ω–æ | –í—Ä–µ–º—è | –û—Ü–µ–Ω–∫–∞ |
|-----------|----------------|---------|-------|--------|
| **Chunking** | 13 —Ñ–∞–π–ª–æ–≤ | 127 —á–∞–Ω–∫–æ–≤ | ~2-5 —Å–µ–∫ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **Media** | 6 —Ñ–∞–π–ª–æ–≤ | 6 –∞–Ω–∞–ª–∏–∑–æ–≤ | 2-13 —Å–µ–∫ | ‚úÖ –û—Ç–ª–∏—á–Ω–æ |
| **Search** | 14 –∑–∞–ø—Ä–æ—Å–æ–≤ | 70 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ | 0.6 —Å–µ–∫ | ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã |

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ

### 1. Chunking Pipeline

**–ú–µ—Ç—Ä–∏–∫–∏:**
- 13 —Ñ–∞–π–ª–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
- 127 —á–∞–Ω–∫–æ–≤ —Å–æ–∑–¥–∞–Ω–æ —Å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –≤–µ–∫—Ç–æ—Ä–∞–º–∏ (768 dim)
- Embeddings –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å—Ç–∞–±–∏–ª—å–Ω–æ

**–ü—Ä–∏–º–µ—Ä –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:**
```markdown
Chunk: "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
Vector: [-0.053591, -0.004871, -0.007159, ...]
Dimension: 768 ‚úÖ
```

**–ü–æ—á–µ–º—É —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ Markdown –ø–∞—Ä—Å–∏—Ç—Å—è —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
- ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ embedder –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–µ–∫—Ç–æ—Ä—ã –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–ø—É—Å–∫–æ–≤
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (`source`, `type`, `category`)

---

### 2. Media Processing Quality

**–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏:**

| –¢–∏–ø | –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –í—Ä–µ–º—è | –ú–æ–¥–µ–ª—å |
|-----|------|--------|-------|--------|
| IMAGE | `cat_photo.png` | 490KB | 3.4 —Å–µ–∫ | flash-lite |
| IMAGE | `eiffel_tower.jpg` | 264KB | 2.2 —Å–µ–∫ | flash-lite |
| IMAGE | `code_screenshot.png` | 87KB | 1.9 —Å–µ–∫ | flash-lite |
| AUDIO | `podcast.mp3` | 384KB | 7.8 —Å–µ–∫ | flash-lite |
| VIDEO | `tutorial.mp4` | 5.3MB | 13 —Å–µ–∫ | flash-lite |
| VIDEO | `coding_session.mov` | 890KB | 4.3 —Å–µ–∫ | flash-lite |

**–°—Ä–µ–¥–Ω–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**
- üì∏ Images: **2.5 —Å–µ–∫** (87-490KB)
- üéµ Audio: **7.8 —Å–µ–∫** (384KB, 30 —Å–µ–∫ –∞—É–¥–∏–æ)
- üé¨ Video: **8.7 —Å–µ–∫** (890KB-5.3MB)

**–ö–∞—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∞:**

```json
{
  "alt_text": "A tabby cat with striking green eyes illuminated by golden hour sunlight.",
  "description": "This close-up portrait captures a tabby cat in profile...",
  "keywords": ["cat", "tabby cat", "pet", "golden hour", "sunset", ...]
}
```

**–ü–æ—á–µ–º—É —Ö–æ—Ä–æ—à–æ:**
- ‚úÖ –û–ø–∏—Å–∞–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω—ã–µ –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ
- ‚úÖ Alt-text –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è accessibility
- ‚úÖ Keywords —Ç–æ—á–Ω—ã–µ –∏ –ø–æ–ª–µ–∑–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞
- ‚úÖ OCR –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ code_screenshot.png
- ‚úÖ Video –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç frames + audio track

---

### 3. API Integration Stability

**Zero errors** –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ:
- 127 embedding requests (text)
- 6 multimodal requests (image/audio/video)

**Rate Limiting —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ù–∏ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏ 429 (Too Many Requests)
- Resilience patterns –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏ –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- Token Bucket –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–ø—Ä–∞–≤–ª—è–µ—Ç RPM

---

## ‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è

### 1. Hybrid Search Scores ‚Äî –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê

**–û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:**

| –†–µ–∂–∏–º | Min Score | Max Score | –°—Ä–µ–¥–Ω–∏–π | –ü—Ä–æ–±–ª–µ–º–∞ |
|-------|-----------|-----------|---------|----------|
| **Hybrid** | 0.031281 | 0.032787 | **0.032** | ‚ùå –°–ª–∏—à–∫–æ–º –Ω–∏–∑–∫–∏–µ |
| **Vector** | 0.747832 | 0.747832 | **0.748** | ‚úÖ –ù–æ—Ä–º–∞–ª—å–Ω—ã–µ |

**–ü—Ä–∏–º–µ—Ä—ã –∏–∑ –æ—Ç—á—ë—Ç–∞:**

```markdown
Query: "—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏"
Mode: hybrid

Result #1: Score 0.032787 (hybrid) ‚ùå
Result #2: Score 0.032266 (hybrid) ‚ùå
Result #3: Score 0.032258 (hybrid) ‚ùå
```

```markdown
Query: "Python variables types"
Mode: vector

Result #1: Score 0.747832 (vector) ‚úÖ
Result #2: Score 0.747832 (vector) ‚úÖ
Result #3: Score 0.747832 (vector) ‚úÖ
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**

1. **RRF Fusion –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:** Hybrid —Å–∫–æ—Ä—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0.6-0.9, –∞ –Ω–µ 0.03
2. **FTS5 –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:** FTS –≤–µ—Å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è
3. **–¢–æ–ª—å–∫–æ vector –ø–æ–∏—Å–∫ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:** Hybrid = degraded vector

**–í–µ—Ä–æ—è—Ç–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**

```python
# semantic_core/integrations/peewee/search_proxy.py
# RRF —Ñ–æ—Ä–º—É–ª–∞ –º–æ–∂–µ—Ç –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–∫–æ—Ä—ã
rrf_score = sum(1.0 / (rank + k) for rank in ranks)
# –ï—Å–ª–∏ k=60, –∞ ranks=[1,2,3], —Ç–æ score~0.03 ‚ùå
```

---

### 2. Duplicate Chunks

**–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –¥—É–±–ª–∏–∫–∞—Ç—ã:**

```markdown
Document ID: 1, Chunk: "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."
Document ID: 7, Chunk: "–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏ –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..." (SAME CONTENT)
```

**–ü–æ—á–µ–º—É –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –¢–µ—Å—Ç—ã —Å–æ–∑–¥–∞—é—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ document records —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º source
- Metadata —Ä–∞–∑–Ω–∞—è (`type: "plain_text"` vs `category: "text"`), –Ω–æ content –∏–¥–µ–Ω—Ç–∏—á–µ–Ω

**–†–∏—Å–∫:**
- Duplicate results –≤ –ø–æ–∏—Å–∫–µ
- –õ–∏—à–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ embeddings API
- Confusion –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –î–æ–±–∞–≤–∏—Ç—å unique constraint –Ω–∞ (source, content_hash)?
# –ò–ª–∏ deduplicate –ø—Ä–∏ ingestion –ø–æ hash(content)
```

---

### 3. FTS5 Granularity Mismatch

**–ü—Ä–æ–±–ª–µ–º–∞:**

```python
# –¢–µ—Å—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç chunk-level –ø–æ–∏—Å–∫
results = semantic_core.search("query", mode="hybrid")

# –ù–æ FTS5 —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ document-level:
SELECT doc_id FROM documents_fts WHERE documents_fts MATCH 'query'
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- FTS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç document IDs
- Vector –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç chunk IDs
- RRF –ø—ã—Ç–∞–µ—Ç—Å—è merge —Ä–∞–∑–Ω—ã–µ entities ‚Üí –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Å–∫–æ—Ä—ã

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**

| Level | Vector | FTS5 | RRF |
|-------|--------|------|-----|
| **Document** | doc similarity | doc match | ‚úÖ OK |
| **Chunk** | chunk similarity | ??? | ‚ùå FAIL |

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–º–µ—à–∏–≤–∞–µ—Ç —É—Ä–æ–≤–Ω–∏:**

```python
# Pseudo-code —Ç–µ–∫—É—â–µ–π –ª–æ–≥–∏–∫–∏
vector_results = [...chunks...]  # chunk-level
fts_results = [...documents...]  # document-level
rrf_score = merge(vector_results, fts_results)  # ‚ùå mismatch
```

---

### 4. No Media Search Tests

**–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ—Å—Ç—ã:**
- ‚ùå –ü–æ–∏—Å–∫ –ø–æ image keywords (`"golden hour cat"`)
- ‚ùå –ü–æ–∏—Å–∫ –ø–æ OCR text –∏–∑ screenshot
- ‚ùå –ü–æ–∏—Å–∫ –ø–æ audio transcription
- ‚ùå –ü–æ–∏—Å–∫ –ø–æ video descriptions

**–¢–µ–∫—É—â–∏–π coverage:**

```
‚úÖ Media ingestion (6 files)
‚úÖ Media analysis quality
‚ùå Media search functionality  <-- GAP
```

**–ü–æ—á–µ–º—É –∫—Ä–∏—Ç–∏—á–Ω–æ:**
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, –ø–æ–ø–∞–¥–∞—é—Ç –ª–∏ media –≤ search results
- –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è relevance keywords/alt_text
- –ú–æ–∂–µ—Ç –±—ã—Ç—å broken –∏ –º—ã –Ω–µ –∑–Ω–∞–µ–º

---

## üìà Performance Benchmarks

### Chunking Performance

| –§–∞–π–ª | –†–∞–∑–º–µ—Ä | –ß–∞–Ω–∫–æ–≤ | –í—Ä–µ–º—è | –°–∫–æ—Ä–æ—Å—Ç—å |
|------|--------|--------|-------|----------|
| `sample_article.txt` | 2KB | 7 | ~2 —Å–µ–∫ | 1KB/sec |
| `nested_headers_example.md` | 5KB | 45 | ~4 —Å–µ–∫ | 1.25KB/sec |
| All 13 files | ~15KB | 127 | ~30 —Å–µ–∫ | 0.5KB/sec |

**–í—ã–≤–æ–¥—ã:**
- ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å ~1KB/sec –¥–ª—è –º–∞–ª—ã—Ö —Ñ–∞–π–ª–æ–≤
- ‚ö†Ô∏è –ü–∞–¥–∞–µ—Ç –¥–æ 0.5KB/sec –Ω–∞ –±–∞—Ç—á–∞—Ö (API rate limiting)

---

### Media Processing Performance

**–õ–∏–Ω–µ–π–Ω–∞—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –æ—Ç —Ä–∞–∑–º–µ—Ä–∞:**

```
Images:  y = 0.005x + 1.5 —Å–µ–∫  (–≥–¥–µ x = KB)
Audio:   y = 0.02x + 2 —Å–µ–∫
Video:   y = 0.002x + 3 —Å–µ–∫
```

**–†–∏—Å–∫ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è:**

| –†–∞–∑–º–µ—Ä | Images | Audio | Video |
|--------|--------|-------|-------|
| 1MB | 6.5 —Å–µ–∫ | 22 —Å–µ–∫ | 5 —Å–µ–∫ |
| 10MB | 51 —Å–µ–∫ | 202 —Å–µ–∫ | 23 —Å–µ–∫ |
| 100MB | 501 —Å–µ–∫ | 2020 —Å–µ–∫ | 203 —Å–µ–∫ |

‚ö†Ô∏è **100MB video = 3.4 –º–∏–Ω—É—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏** (–±–µ–∑ —É—á—ë—Ç–∞ frame extraction)

---

## üéì –ö–ª—é—á–µ–≤—ã–µ –≤—ã–≤–æ–¥—ã

### ‚úÖ Production-Ready

1. **Chunking:** Stable, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤–µ–∫—Ç–æ—Ä—ã, —Ö–æ—Ä–æ—à–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
2. **Media Analysis:** –í—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ descriptions, —Å—Ç–∞–±–∏–ª—å–Ω—ã–π API
3. **Rate Limiting:** Zero 429 errors, RPM control —Ä–∞–±–æ—Ç–∞–µ—Ç
4. **Resilience:** Retry patterns –æ—Ç—Ä–∞–±–æ—Ç–∞–ª–∏ –±–µ–∑ —Å–±–æ–µ–≤

### ‚ö†Ô∏è Requires Fix Before Production

1. **Hybrid Search:** RRF scores –∞–Ω–æ–º–∞–ª—å–Ω–æ –Ω–∏–∑–∫–∏–µ (0.03 vs 0.75)
2. **FTS5 Integration:** Document/Chunk level mismatch
3. **Duplicate Detection:** –ù—É–∂–Ω–∞ dedupe —Å—Ç—Ä–∞—Ç–µ–≥–∏—è
4. **Media Search:** –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç E2E —Ç–µ—Å—Ç—ã

### üöÄ Next Steps

1. **Debug RRF Formula:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—é —Å–∫–æ—Ä–æ–≤ –≤ `search_proxy.py`
2. **Align FTS5:** –õ–∏–±–æ chunk-level FTS, –ª–∏–±–æ document-level vector
3. **Add Media Search Tests:** `test_search_by_image_keywords.py`
4. **Benchmark Long Videos:** –ß—Ç–æ –±—É–¥–µ—Ç —Å 1-hour tutorial?

---

**–ò—Ç–æ–≥–æ:** –°–∏—Å—Ç–µ–º–∞ **80% production-ready**, –Ω–æ hybrid search —Ç—Ä–µ–±—É–µ—Ç **–∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ñ–∏–∫—Å–∞**.
