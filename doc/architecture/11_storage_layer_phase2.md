# üóÑÔ∏è Storage Layer: Peewee + RRF + –§–∏–ª—å—Ç—Ä—ã (Phase 2)

> –ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –≤–µ–∫—Ç–æ—Ä–æ–≤ —Å –≥–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–∏—Å–∫–æ–º –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º

---

## üìå –ß—Ç–æ —ç—Ç–æ —Ç–∞–∫–æ–µ?

**Storage Layer** ‚Äî —ç—Ç–æ –∞–¥–∞–ø—Ç–µ—Ä –º–µ–∂–¥—É –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è–º–∏ (–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `BaseVectorStore`) –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–µ–π (Peewee ORM + SQLite + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è).

–û–Ω –∏–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é —Ä–∞–±–æ—Ç—É —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å —á–∞–Ω–∫–∞–º–∏, –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ `sqlite-vec`, –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ `fts5` –∏ –≥–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å RRF –∞–ª–≥–æ—Ä–∏—Ç–º–æ–º.

---

## üéØ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ?

**–ü—Ä–æ–±–ª–µ–º–∞**: –í Phase 1 –º—ã —Å–æ–∑–¥–∞–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ DTO, –Ω–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –±—ã–ª–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π:

- ‚ùå –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –¥–µ–ª–∞–ª fallback –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π
- ‚ùå –ù–µ –±—ã–ª–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º
- ‚ùå –ù–µ –±—ã–ª–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ RRF

**–†–µ—à–µ–Ω–∏–µ**: Phase 2 —Ä–µ–∞–ª–∏–∑—É–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Storage Layer —Å:

- ‚úÖ **Parent-Child –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π** (Document ‚Üí Chunks) —Å –∫–∞—Å–∫–∞–¥–Ω—ã–º —É–¥–∞–ª–µ–Ω–∏–µ–º
- ‚úÖ **–¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –ø–æ–∏—Å–∫–∞**: `vector`, `fts`, `hybrid` —Å –Ω–∞—Å—Ç–æ—è—â–∏–º RRF
- ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –ø–æ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º –ø–æ–ª—è–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö (JSON fields)
- ‚úÖ **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏** –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```mermaid
graph TB
    subgraph "Interfaces"
        IV[BaseVectorStore]
    end
    
    subgraph "Adapters"
        PVS[PeeweeVectorStore]
        VDB[VectorDatabase]
    end
    
    subgraph "Models (ORM)"
        DM[DocumentModel]
        CM[ChunkModel]
    end
    
    subgraph "SQLite Extensions"
        V[sqlite-vec]
        F[fts5]
    end
    
    IV --> PVS
    PVS --> VDB
    PVS --> DM
    PVS --> CM
    CM --> V
    DM --> F
```

**–°–ª–æ–∏**:

1. **Interface**: `BaseVectorStore` ‚Äî –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ª—é–±–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
2. **Adapter**: `PeeweeVectorStore` ‚Äî —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Peewee ORM
3. **ORM Models**: `DocumentModel` / `ChunkModel` ‚Äî —Ç–∞–±–ª–∏—Ü—ã –ë–î
4. **Extensions**: `sqlite-vec` (–≤–µ–∫—Ç–æ—Ä—ã) + `fts5` (FTS)

---

## üîç –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?

### 1Ô∏è‚É£ Parent-Child –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```mermaid
erDiagram
    DOCUMENTS ||--o{ CHUNKS : contains
    DOCUMENTS {
        int id PK
        text content
        json metadata
        datetime created_at
    }
    CHUNKS {
        int id PK
        int document_id FK
        text content
        int chunk_index
    }
    CHUNKS_VEC {
        int id PK
        float_array embedding
    }
    DOCUMENTS_FTS {
        int rowid
        text content
    }
```

**–°–≤—è–∑—å**: –û–¥–∏–Ω –¥–æ–∫—É–º–µ–Ω—Ç (`DocumentModel`) ‚Üí –º–Ω–æ–≥–æ —á–∞–Ω–∫–æ–≤ (`ChunkModel`).

**–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ**: –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è –≤—Å–µ –µ–≥–æ —á–∞–Ω–∫–∏ (—á–µ—Ä–µ–∑ `ON DELETE CASCADE`).

---

### 2Ô∏è‚É£ –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –ø–æ–∏—Å–∫–∞

#### Vector Search

–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –≤–µ–∫—Ç–æ—Ä–∞–º —á–µ—Ä–µ–∑ `sqlite-vec`:

```mermaid
graph LR
    A[–í–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞] --> B[vec_distance_cosine]
    B --> C[–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ distance]
    C --> D[TOP N —á–∞–Ω–∫–æ–≤]
    D --> E[–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ document_id]
    E --> F[–†–µ–∑—É–ª—å—Ç–∞—Ç—ã]
```

**–ö–ª—é—á–µ–≤–æ–µ**:

- –ü–æ–∏—Å–∫ –∏–¥–µ—Ç –ø–æ **—á–∞–Ω–∫–∞–º** (chunks_vec)
- –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è **–¥–æ–∫—É–º–µ–Ω—Ç—ã** (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `MIN(distance)` –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏

#### FTS Search

–ü–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º —á–µ—Ä–µ–∑ `fts5`:

```mermaid
graph LR
    A[–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞] --> B[FTS5 MATCH]
    B --> C[–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ rank]
    C --> D[TOP N –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤]
```

**–ö–ª—é—á–µ–≤–æ–µ**:

- –ü–æ–∏—Å–∫ —Å—Ä–∞–∑—É –ø–æ **–¥–æ–∫—É–º–µ–Ω—Ç–∞–º** (documents_fts)
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç boolean –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã (AND, OR, NOT)
- –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä—ã

#### Hybrid Search (RRF)

–ö–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏ FTS –ø–æ–∏—Å–∫–∞:

```mermaid
graph TB
    Q[–ó–∞–ø—Ä–æ—Å] --> QV[–í–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞]
    Q --> QT[–¢–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞]
    
    QV --> VS[Vector Search: TOP 100]
    QT --> FS[FTS Search: TOP 100]
    
    VS --> R1[Rank 1, 2, 3...]
    FS --> R2[Rank 1, 2, 3...]
    
    R1 --> RRF[RRF Score = 1/(k+rank_vec) + 1/(k+rank_fts)]
    R2 --> RRF
    
    RRF --> SORT[–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ RRF]
    SORT --> TOP[TOP N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤]
```

**RRF –∞–ª–≥–æ—Ä–∏—Ç–º** (Reciprocal Rank Fusion):

$$
\text{score}(doc) = \frac{1}{k + \text{rank}_{vector}} + \frac{1}{k + \text{rank}_{FTS}}
$$

–≥–¥–µ `k` ‚Äî –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ 60).

---

### 3Ô∏è‚É£ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º

–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–∞–∫ **JSON** –≤ –ø–æ–ª–µ `metadata`:

```json
{
  "title": "Python Guide",
  "category": "Programming",
  "author": "Alice",
  "year": 2024
}
```

**–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ SQL**:

```sql
WHERE json_extract(metadata, '$.category') = 'Programming'
  AND json_extract(metadata, '$.year') = 2024
```

**–†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —Ä–µ–∂–∏–º–æ–≤**: `vector`, `fts`, `hybrid`.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ –ø–æ–∏—Å–∫–∞

| –ö—Ä–∏—Ç–µ—Ä–∏–π | Vector | FTS | Hybrid (RRF) |
|----------|--------|-----|--------------|
| **–°–∏–Ω–æ–Ω–∏–º—ã** | ‚úÖ –ü–æ–Ω–∏–º–∞–µ—Ç | ‚ùå –ù–µ—Ç | ‚úÖ –î–∞ |
| **–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ** | ‚ö†Ô∏è –ú–æ–∂–µ—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å | ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç | ‚úÖ –ù–∞—Ö–æ–¥–∏—Ç |
| **–°–∫–æ—Ä–æ—Å—Ç—å** | üê¢ ~50ms | üöÄ ~5ms | ‚è±Ô∏è ~60ms |
| **–ò–Ω—Ç–µ—Ä–Ω–µ—Ç** | ‚ö†Ô∏è –î–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ | ‚úÖ –õ–æ–∫–∞–ª—å–Ω–æ | ‚ö†Ô∏è –î–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ |
| **–ö–∞—á–µ—Å—Ç–≤–æ** | üéØ –í—ã—Å–æ–∫–æ–µ | ‚ö° –°—Ä–µ–¥–Ω–µ–µ | üèÜ **–õ—É—á—à–µ–µ** |

**–í—ã–≤–æ–¥**: Hybrid (RRF) –¥–∞–µ—Ç –ª—É—á—à–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∫–æ–º–±–∏–Ω–∏—Ä—É—è –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –æ–±–æ–∏—Ö –º–µ—Ç–æ–¥–æ–≤.

---

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã RRF

### –ü–∞—Ä–∞–º–µ—Ç—Ä `k`

–ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º—É–ª–µ RRF:

| –ó–Ω–∞—á–µ–Ω–∏–µ k | –≠—Ñ—Ñ–µ–∫—Ç | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-----------|--------|-------------------|
| `k=10` | üî• **–°–∏–ª—å–Ω–æ** –≤–ª–∏—è–µ—Ç —Ä–∞–Ω–≥ | –î–æ–≤–µ—Ä—è–µ–º FTS + Vector –æ–¥–∏–Ω–∞–∫–æ–≤–æ |
| `k=60` | ‚öñÔ∏è **–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ** | **–°—Ç–∞–Ω–¥–∞—Ä—Ç** (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è) |
| `k=100` | üåä **–°–≥–ª–∞–∂–∏–≤–∞–µ—Ç** —Ä–∞–∑–ª–∏—á–∏—è | –ú–Ω–æ–≥–æ —à—É–º–∞ –≤ —Ä–∞–Ω–≥–∞—Ö |

**–ü—Ä–∏–º–µ—Ä –≤–ª–∏—è–Ω–∏—è**:

```
–î–æ–∫—É–º–µ–Ω—Ç A: rank_vec=1, rank_fts=5
–î–æ–∫—É–º–µ–Ω—Ç B: rank_vec=5, rank_fts=1

–ü—Ä–∏ k=10:
  score_A = 1/11 + 1/15 = 0.157
  score_B = 1/15 + 1/11 = 0.157  (—Ä–∞–≤–Ω—ã–µ!)

–ü—Ä–∏ k=60:
  score_A = 1/61 + 1/65 = 0.032
  score_B = 1/65 + 1/61 = 0.032  (—Ä–∞–≤–Ω—ã–µ!)

–ü—Ä–∏ k=100:
  score_A = 1/101 + 1/105 = 0.019
  score_B = 1/105 + 1/101 = 0.019  (—Ä–∞–≤–Ω—ã–µ!)
```

**–ó–æ–ª–æ—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ**: –ò—Å–ø–æ–ª—å–∑—É–π `k=60` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∏–∑–º–µ–Ω—è–π —Ç–æ–ª—å–∫–æ –ø—Ä–∏ A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏.

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. **Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏**

–ï—Å–ª–∏ –≤ –≥–∏–±—Ä–∏–¥–Ω–æ–º –ø–æ–∏—Å–∫–µ –ø–µ—Ä–µ–¥–∞–Ω —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä:

- `query_vector=None` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ FTS**
- `query_text=None` ‚Üí –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ Vector**

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `mode="hybrid"` –¥–∞–∂–µ –∫–æ–≥–¥–∞ –æ–¥–∏–Ω –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.

### 2. **TOP 100 –¥–ª—è RRF**

RRF —Å–Ω–∞—á–∞–ª–∞ –≤—ã–±–∏—Ä–∞–µ—Ç **TOP 100** –∏–∑ –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞, –ø–æ—Ç–æ–º –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç.

**–ü–æ—á–µ–º—É –Ω–µ TOP 10?** –ß—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ:

- –í –≤–µ–∫—Ç–æ—Ä–Ω–æ–º –ø–æ–∏—Å–∫–µ –Ω–∞ 50-–º –º–µ—Å—Ç–µ
- –í FTS –Ω–∞ 3-–º –º–µ—Å—Ç–µ
- –ü–æ—Å–ª–µ RRF –ø–æ–ø–∞–¥–∞—é—Ç –≤ TOP 5 ‚úÖ

### 3. **JSON –∏–Ω–¥–µ–∫—Å—ã**

SQLite **–Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç** JSON –ø–æ–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

–î–ª—è —á–∞—Å—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø–æ `metadata.category` –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å expression index:

```sql
CREATE INDEX idx_category 
ON documents (json_extract(metadata, '$.category'));
```

–ù–æ –ø–æ–∫–∞ —ç—Ç–æ–≥–æ –Ω–µ—Ç ‚Äî —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ø–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø—Ä–∏–µ–º–ª–µ–º–æ –¥–ª—è <10k –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤).

### 4. **–ö–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ**

–ü—Ä–∏ `store.delete(document_id)` —É–¥–∞–ª—è—é—Ç—Å—è:

1. –î–æ–∫—É–º–µ–Ω—Ç –∏–∑ `documents`
2. –í—Å–µ —á–∞–Ω–∫–∏ –∏–∑ `chunks` (CASCADE)
3. –í–µ–∫—Ç–æ—Ä—ã –∏–∑ `chunks_vec` (—á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä)
4. FTS –∑–∞–ø–∏—Å–∏ –∏–∑ `documents_fts` (—á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä)

–≠—Ç–æ –∞—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –≤–Ω—É—Ç—Ä–∏ `db.atomic()`.

---

## üß™ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º

```python
results = store.search(
    query_vector=embedding,
    filters={"category": "Python"},
    limit=10,
    mode="vector"
)
```

### FTS –ø–æ–∏—Å–∫ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏

```python
results = store.search(
    query_text="—Ü–∏–∫–ª—ã AND —Å–ø–∏—Å–∫–∏",
    filters={
        "category": "Programming",
        "year": 2024
    },
    limit=5,
    mode="fts"
)
```

### –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π k

```python
results = store.search(
    query_vector=embedding,
    query_text="Python —Å–∏–Ω—Ç–∞–∫—Å–∏—Å",
    filters={"author": "Alice"},
    k=60,  # —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ RRF
    limit=10,
    mode="hybrid"
)
```

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- **‚Üê [–ü—Ä–µ–¥—ã–¥—É—â–µ–µ: SOLID –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (Phase 1)](10_solid_refactoring.md)**
- **‚Üí –°–ª–µ–¥—É—é—â–µ–µ: Integration API (Phase 3)** *(–≤ –ø–ª–∞–Ω–∞—Ö)*

---

## üìö –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

**–†–µ–∞–ª–∏–∑–∞—Ü–∏—è**: `semantic_core/infrastructure/storage/peewee/`

- `adapter.py` ‚Äî PeeweeVectorStore (–ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞)
- `models.py` ‚Äî DocumentModel, ChunkModel (ORM)
- `engine.py` ‚Äî VectorDatabase (–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ + —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)

**–¢–µ—Å—Ç—ã**: `tests/test_phase_2_storage.py` (26 —Ç–µ—Å—Ç–æ–≤, –≤—Å–µ –ø—Ä–æ—Ö–æ–¥—è—Ç)

---

**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: 2 –¥–µ–∫–∞–±—Ä—è 2025
