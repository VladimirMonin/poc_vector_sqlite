–í–æ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ **–§–∞–∑—ã 4**. –û–Ω —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ —Ç–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è: –≥–∏–±–∫–æ—Å—Ç—å –≤—ã–±–æ—Ä–∞ –ø–∞—Ä—Å–µ—Ä–∞, —Ä–∞–±–æ—Ç—É —Å –∫–æ–¥–æ–º, "—Ö–ª–µ–±–Ω—ã–µ –∫—Ä–æ—à–∫–∏" –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–∫–∞—Ç—å –∫–∞–∫ —Ü–µ–ª—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Ç–∞–∫ –∏ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã (—á–∞–Ω–∫–∏/–±–ª–æ–∫–∏ –∫–æ–¥–∞).

-----

# üó∫Ô∏è Phase 4: Smart Structural Parsing & Granular Search

**–¶–µ–ª—å —ç—Ç–∞–ø–∞:** –ù–∞—É—á–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ø–æ–Ω–∏–º–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (Markdown AST), —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏–µ—Ä–∞—Ä—Ö–∏—é (–∑–∞–≥–æ–ª–æ–≤–∫–∏) –∏ —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∫–æ–¥/—Ç–µ–∫—Å—Ç), –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å API –¥–ª—è –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ (–ø–æ–∏—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤).

-----

### 1\. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –î–æ–º–µ–Ω–∞ (`domain`)

–ú—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—É—á–∏—Ç—å –Ω–∞—à–∏ DTO –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ.

#### –ê. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `Chunk` DTO

–î–æ–±–∞–≤–ª—è–µ–º —Ç–∏–ø–∏–∑–∞—Ü–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ.

* **`chunk_type`** (Enum):
  * `TEXT` (–æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç)
  * `CODE` (–±–ª–æ–∫ –∫–æ–¥–∞)
  * `TABLE` (—Ç–∞–±–ª–∏—Ü–∞ Markdown)
  * `IMAGE_REF` (—Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫—É ‚Äî –∑–∞–¥–µ–ª –Ω–∞ –±—É–¥—É—â–µ–µ)
* **`language`** (Optional[str]): –î–ª—è –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "python", "sql").
* **`metadata`** (Dict):
  * `headers` (List[str]): –ò–µ—Ä–∞—Ä—Ö–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ ["–ì–ª–∞–≤–∞ 1", "–†–∞–∑–¥–µ–ª –ê"].
  * `start_line`, `end_line`: –ù–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫ –≤ –∏—Å—Ö–æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ (–¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞).

-----

### 2\. –ù–æ–≤—ã–π –ú–æ–¥—É–ª—å –ü–∞—Ä—Å–∏–Ω–≥–∞ (`processing/parsers`)

–†–µ–∞–ª–∏–∑—É–µ–º –º–æ–¥—É–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –ø–∞—Ä—Å–µ—Ä–æ–≤ –Ω–∞ –±–∞–∑–µ AST (Abstract Syntax Tree).

#### –ê. –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å `DocumentParser` (–≤ `interfaces/parser.py`)

–ö–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è –ª—é–±–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞.

* `parse(content: str) -> Iterator[ParsingSegment]`
  * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Ç–æ–∫ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Å–µ–≥–º–µ–Ω—Ç–æ–≤ (–Ω–µ —á–∞–Ω–∫–æ–≤\!), –∞ –∏–º–µ–Ω–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü (–ø–∞—Ä–∞–≥—Ä–∞—Ñ, –∑–∞–≥–æ–ª–æ–≤–æ–∫, –±–ª–æ–∫ –∫–æ–¥–∞).

#### –ë. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `MarkdownNodeParser`

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–∏–±–ª–∏–æ—Ç–µ–∫—É `markdown-it-py`.

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**

1. **Token Stream:** –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –≤ –ø–æ—Ç–æ–∫ —Ç–æ–∫–µ–Ω–æ–≤.
2. **Context Tracking:** –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å—Ç–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (Breadcrumbs). –ü—Ä–∏ –≤—Ö–æ–¥–µ –≤ –Ω–æ–≤—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —É—Ä–æ–≤–µ–Ω—å —Å—Ç–µ–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è.
3. **Code Block Extraction:**
      * –û–±–Ω–∞—Ä—É–∂–∏–≤–∞–µ—Ç `fence` —Ç–æ–∫–µ–Ω—ã (\`\`\`).
      * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —è–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ info-—Å—Ç—Ä–æ–∫–∏.
      * –ü–æ–º–µ—á–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç –∫–∞–∫ `CODE`.
      * **–í–∞–∂–Ω–æ:** –ë–ª–æ–∫–∏ –∫–æ–¥–∞ *–Ω–∏–∫–æ–≥–¥–∞* –Ω–µ —Å–ª–∏–≤–∞—é—Ç—Å—è —Å –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –≤ –æ–¥–∏–Ω —á–∞–Ω–∫.
4. **Asset Detection:** –ù–∞—Ö–æ–¥–∏—Ç —Ç–æ–∫–µ–Ω—ã `image`. –°–æ–∑–¥–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç-—Å—Å—ã–ª–∫—É (–ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –§–∞–∑–µ 6).

#### –í. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π `SmartSplitter` (–≤ `processing/splitters`)

–≠—Ç–æ—Ç —Å–ø–ª–∏—Ç—Ç–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–≤–µ—Ä—Ö –ø–∞—Ä—Å–µ—Ä–∞.

**–õ–æ–≥–∏–∫–∞ –Ω–∞—Ä–µ–∑–∫–∏:**

1. –ü–æ–ª—É—á–∞–µ—Ç —Å–µ–≥–º–µ–Ω—Ç—ã –æ—Ç `MarkdownNodeParser`.
2. **–ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞:** –ü—ã—Ç–∞–µ—Ç—Å—è —Å–∫–ª–µ–∏—Ç—å –º–µ–ª–∫–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø–∞—Ä–∞–≥—Ä–∞—Ñ—ã, –ø–æ–∫–∞ –æ–Ω–∏ –≤–ª–µ–∑–∞—é—Ç –≤ `chunk_size`.
3. **–ò–∑–æ–ª—è—Ü–∏—è:** –ï—Å–ª–∏ –ø—Ä–∏—à–µ–ª —Å–µ–≥–º–µ–Ω—Ç `CODE`, –æ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞–Ω–∫ (–¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω –º–∞–ª–µ–Ω—å–∫–∏–π). –ï—Å–ª–∏ –∫–æ–¥ –æ–≥—Ä–æ–º–Ω—ã–π ‚Äî —Ä–µ–∂–µ—Ç –µ–≥–æ –ø–æ—Å—Ç—Ä–æ—á–Ω–æ, –¥—É–±–ª–∏—Ä—É—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∞.
4. **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –°–ø–∏—Å–æ–∫ `Chunk` –æ–±—ä–µ–∫—Ç–æ–≤ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ `chunk_type` –∏ `metadata['headers']`.

-----

### 3\. –ü–æ–ª–∏—Ç–∏–∫–∞ –ö–æ–Ω—Ç–µ–∫—Å—Ç–∞ (`processing/context`)

–û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∞, —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è `HierarchicalContextStrategy`

–≠—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç "–ü—Ä–æ–º–ø—Ç –¥–ª—è –≠–º–±–µ–¥–¥–∏–Ω–≥–∞".

**–ê–ª–≥–æ—Ä–∏—Ç–º:**

1. **–î–ª—è –¢–µ–∫—Å—Ç–∞:**
      * –ë–µ—Ä–µ—Ç —Å—Ç–µ–∫ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤: `H1 > H2`.
      * –§–æ—Ä–º–∏—Ä—É–µ—Ç: `Document: {DocTitle}\nSection: {H1} > {H2}\nContent: {Text}`.
2. **–î–ª—è –ö–æ–¥–∞:**
      * –î–æ–±–∞–≤–ª—è–µ—Ç —è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —è–∑—ã–∫–∞.
      * –§–æ—Ä–º–∏—Ä—É–µ—Ç: `Document: {DocTitle}\nContext: {H1} > {H2}\nType: Python Code\nCode:\n{CodeBlock}`.
      * *–ó–∞—á–µ–º:* –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å—É "—Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ python" –Ω–∞—Ö–æ–¥–∏—Ç—å –∏–º–µ–Ω–Ω–æ –∫–æ–¥, –∞ –Ω–µ –µ–≥–æ –æ–ø–∏—Å–∞–Ω–∏–µ.

-----

### 4\. –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ API –ü–æ–∏—Å–∫–∞ (`integrations/search_proxy.py`)

–≠—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å –æ –≥–∏–±–∫–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞. –ú—ã –¥–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–±–æ—Ä: –∏—Å–∫–∞—Ç—å "—Ä–æ–¥–∏—Ç–µ–ª–µ–π" (–¥–æ–∫—É–º–µ–Ω—Ç—ã) –∏–ª–∏ "–¥–µ—Ç–µ–π" (—á–∞–Ω–∫–∏).

#### –ê. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ `SearchProxy`

–î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥—ã –¥–ª—è –≥—Ä–∞–Ω—É–ª—è—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.

1. **`search_documents(query, ...)`** (–°—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥):

      * –ù–∞—Ö–æ–¥–∏—Ç —á–∞–Ω–∫–∏.
      * –°—Ö–ª–æ–ø—ã–≤–∞–µ—Ç –∏—Ö (Group By Parent ID).
      * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç—ã –º–æ–¥–µ–ª–∏ ORM (Note, Article).

2. **`search_chunks(query, type_filter=None, ...)`** (–ù–æ–≤—ã–π –º–µ—Ç–æ–¥):

      * –ò—â–µ—Ç —á–∞–Ω–∫–∏.
      * **–ù–µ —Å—Ö–ª–æ–ø—ã–≤–∞–µ—Ç**. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ `ChunkResult`.
      * –ü–æ–∑–≤–æ–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ —Ç–∏–ø—É: `type_filter='CODE'`.
      * *–†–µ–∑—É–ª—å—Ç–∞—Ç:* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –∫–æ–¥–∞ –∏–ª–∏ –∞–±–∑–∞—Ü–µ–≤ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º, –æ—Ç–∫—É–¥–∞ –æ–Ω–∏ –≤–∑—è—Ç—ã.

#### –ë. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `PeeweeVectorStore`

–û–±–Ω–æ–≤–ª—è–µ–º SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è `search_chunks`. –û–Ω –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —á–∞–Ω–∫–æ–≤ + –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã —Ä–æ–¥–∏—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ JOIN), –Ω–æ –Ω–µ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏.

-----

### 5\. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ü–∞–π–ø–ª–∞–π–Ω–∞ (`pipeline.py`)

#### –õ–æ–≥–∏–∫–∞ –†–æ—É—Ç–∏–Ω–≥–∞ (Content Routing)

–û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–æ–¥ `ingest`, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–≥ –≤—ã–±–∏—Ä–∞—Ç—å –ø–∞—Ä—Å–µ—Ä, –∏–ª–∏ —Å–∏—Å—Ç–µ–º–∞ –≤—ã–±–∏—Ä–∞–ª–∞ –µ–≥–æ —Å–∞–º–∞.

```python
# –ü—Å–µ–≤–¥–æ–∫–æ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
# –í–∞—Ä–∏–∞–Ω—Ç 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (–ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞/–∫–æ–Ω—Ç–µ–Ω—Ç–∞)
index.ingest(doc) 

# –í–∞—Ä–∏–∞–Ω—Ç 2: –Ø–≤–Ω–æ
index.ingest(doc, parser="markdown")
index.ingest(doc, parser="simple") # –ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏–º –ø–∞—Ä—Å–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
```

-----

### ‚úÖ –ò—Ç–æ–≥ –§–∞–∑—ã 4: –ß—Ç–æ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å?

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Å–º–æ–∂–µ—Ç:

1. **–ü–æ–Ω–∏–º–∞—Ç—å Markdown:** –ù–µ –ª–æ–º–∞—Ç—å –≤–µ—Ä—Å—Ç–∫—É –∏ –∫–æ–¥.
2. **–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å–º—ã—Å–ª—É:** –ò—Å–∫–∞—Ç—å "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ –¥–µ–ø–ª–æ–π" –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—ã–π –∞–±–∑–∞—Ü, –¥–∞–∂–µ –µ—Å–ª–∏ —Ç–∞–º –Ω–µ—Ç —Å–ª–æ–≤–∞ "–¥–µ–ø–ª–æ–π" (–±–ª–∞–≥–æ–¥–∞—Ä—è –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –≤ –≤–µ–∫—Ç–æ—Ä–µ).
3. **–ü–æ–∏—Å–∫ –ö–æ–¥–∞:** `Model.search.chunks("—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞", type_filter="CODE")` ‚Äî –≤–µ—Ä–Ω–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏.
4. **–ì–∏–±–∫–æ—Å—Ç—å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Ä–µ—à–∞–µ—Ç, –Ω—É–∂–Ω—ã –µ–º—É —Ü–µ–ª—ã–µ —Å—Ç–∞—Ç—å–∏ –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã.


