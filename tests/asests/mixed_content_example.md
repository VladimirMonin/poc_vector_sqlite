# –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ–±–∑–æ—Ä: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

> **Note:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é RRF (Reciprocal Rank Fusion) –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞.

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞:
- ‚ùå –ü–ª–æ—Ö–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–æ—á–Ω—ã–º–∏ —Ç–µ—Ä–º–∏–Ω–∞–º–∏
- ‚ùå –ü—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Ä–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞
- ‚ùå –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç BM25 —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ —Ç–æ–ª—å–∫–æ FTS:
- ‚ùå –ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç —Å–∏–Ω–æ–Ω–∏–º—ã
- ‚ùå –¢—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–≥–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
- ‚ùå –ò–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —Å–µ–º–∞–Ω—Ç–∏–∫—É

## –†–µ—à–µ–Ω–∏–µ: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫

```sql
-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –¥–ª—è –≥–∏–±—Ä–∏–¥–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE VIRTUAL TABLE documents_vec 
    USING vec0(embedding float[768]);

CREATE VIRTUAL TABLE documents_fts 
    USING fts5(content, tokenize='porter unicode61');
```

### –ê–ª–≥–æ—Ä–∏—Ç–º RRF

Reciprocal Rank Fusion –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏:

$$
RRF(d) = \sum_{r \in R} \frac{1}{k + rank_r(d)}
$$

–ì–¥–µ:
- $d$ ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç
- $R$ ‚Äî –Ω–∞–±–æ—Ä —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–π
- $k$ ‚Äî –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (–æ–±—ã—á–Ω–æ 60)
- $rank_r(d)$ ‚Äî —Ä–∞–Ω–≥ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ $r$

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ Python

```python
from dataclasses import dataclass
from typing import List, Dict

@dataclass
class SearchResult:
    doc_id: int
    score: float
    source: str  # "vector" | "fts" | "hybrid"

def rrf_fusion(
    vector_results: List[SearchResult],
    fts_results: List[SearchResult],
    k: int = 60,
) -> List[SearchResult]:
    """–û–±—ä–µ–¥–∏–Ω—è–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–≤—É—Ö –ø–æ–∏—Å–∫–æ–≤ —á–µ—Ä–µ–∑ RRF.
    
    Args:
        vector_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
        fts_results: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã FTS –ø–æ–∏—Å–∫–∞
        k: –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
    
    Returns:
        –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫
    """
    scores: Dict[int, float] = {}
    
    for rank, result in enumerate(vector_results, start=1):
        doc_id = result.doc_id
        scores[doc_id] = scores.get(doc_id, 0) + 1 / (k + rank)
    
    for rank, result in enumerate(fts_results, start=1):
        doc_id = result.doc_id
        scores[doc_id] = scores.get(doc_id, 0) + 1 / (k + rank)
    
    # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é RRF-—Å–∫–æ—Ä–∞
    sorted_docs = sorted(scores.items(), key=lambda x: -x[1])
    
    return [
        SearchResult(doc_id=doc_id, score=score, source="hybrid")
        for doc_id, score in sorted_docs
    ]
```

## –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

| –ó–∞–ø—Ä–æ—Å | Vector Only | FTS Only | Hybrid |
|--------|-------------|----------|--------|
| "sqlite-vec" | üü° –°—Ä–µ–¥–Ω–µ | üü¢ –û—Ç–ª–∏—á–Ω–æ | üü¢ –û—Ç–ª–∏—á–Ω–æ |
| "–ø–æ—Ö–æ–∂–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã" | üü¢ –û—Ç–ª–∏—á–Ω–æ | üî¥ –ü–ª–æ—Ö–æ | üü¢ –û—Ç–ª–∏—á–Ω–æ |
| "–º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ NLP" | üü¢ –û—Ç–ª–∏—á–Ω–æ | üü° –°—Ä–µ–¥–Ω–µ | üü¢ –û—Ç–ª–∏—á–Ω–æ |

## –ß–µ–∫-–ª–∏—Å—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [x] –°–æ–∑–¥–∞—Ç—å vec0 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
- [x] –°–æ–∑–¥–∞—Ç—å fts5 –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å RRF —Ñ—É–Ω–∫—Ü–∏—é
- [x] –ù–∞–ø–∏—Å–∞—Ç—å unit-—Ç–µ—Å—Ç—ã
- [ ] –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

## –°—Å—ã–ª–∫–∏

1. [Reciprocal Rank Fusion Paper](https://example.com/rrf)
2. [SQLite-vec Documentation](https://github.com/asg017/sqlite-vec)
3. [FTS5 Full-text Search](https://sqlite.org/fts5.html)
