---
title: "–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ –∏ RRF"
description: "–ö–∞–∫ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Reciprocal Rank Fusion"
tags: [hybrid-search, rrf, fts5, ranking, search]
difficulty: intermediate
related: [01_embeddings, 02_vector_search, 04_chunking]
---

## –ß—Ç–æ —ç—Ç–æ üìå

**–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫** ‚Äî –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ) –∏ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ (FTS5) –ø–æ–∏—Å–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.

**RRF (Reciprocal Rank Fusion)** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º —Å–ª–∏—è–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ —Ñ–æ—Ä–º—É–ª–µ:

```
RRF_score(doc) = Œ£ 1 / (k + rank_i)
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| k | 60 | –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è (default) |
| rank_i | 1, 2, 3... | –ü–æ–∑–∏—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ i-–º –∏—Å—Ç–æ—á–Ω–∏–∫–µ |

---

## –ó–∞—á–µ–º –Ω—É–∂–Ω–æ üéØ

| –ü—Ä–æ–±–ª–µ–º–∞ | Vector | FTS5 | Hybrid |
|----------|--------|------|--------|
| –°–∏–Ω–æ–Ω–∏–º—ã ("—Ü–∏–∫–ª" ‚Üí "loop") | ‚úÖ | ‚ùå | ‚úÖ |
| –¢–æ—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã ("OAuth2") | ‚ùå | ‚úÖ | ‚úÖ |
| –†–µ–¥–∫–∏–µ —Å–ª–æ–≤–∞ | ‚ö†Ô∏è | ‚úÖ | ‚úÖ |
| –û–ø–µ—á–∞—Ç–∫–∏ | ‚ö†Ô∏è | ‚ùå | ‚ö†Ô∏è |

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: –î–æ–∫—É–º–µ–Ω—Ç—ã, –Ω–∞–π–¥–µ–Ω–Ω—ã–µ **–æ–±–æ–∏–º–∏** –º–µ—Ç–æ–¥–∞–º–∏, –ø–æ–¥–Ω–∏–º–∞—é—Ç—Å—è –Ω–∞–≤–µ—Ä—Ö.

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç üîç

```plantuml
@startuml
title –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–∏—Å–∫ —Å RRF

start
:–ü–æ–ª—É—á–∏—Ç—å –∑–∞–ø—Ä–æ—Å "—Å—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç";

fork
    :–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫;
    note right: embed_query() ‚Üí cosine distance
    :TOP 100 –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é;
fork again
    :FTS5 –ø–æ–∏—Å–∫;
    note right: MATCH —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—è
    :TOP 100 –ø–æ BM25;
end fork

:RRF —Å–ª–∏—è–Ω–∏–µ;
note right
  score = 1/(60+vec_rank) + 1/(60+fts_rank)
  –î–æ–∫—É–º–µ–Ω—Ç –≤ –æ–±–æ–∏—Ö ‚Üí –≤—ã—Å–æ–∫–∏–π score
end note

:–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ RRF score;
:LIMIT N —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤;

stop

legend right
  k=60 ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
  –ú–µ–Ω—å—à–µ k ‚Üí —Å–∏–ª—å–Ω–µ–µ –≤–ª–∏—è–µ—Ç —Ä–∞–Ω–≥
  –ë–æ–ª—å—à–µ k ‚Üí —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–µ–µ –≤–µ—Å–∞
endlegend
@enduml
```

---

## –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á—ë—Ç–∞ RRF üìä

**–ó–∞–ø—Ä–æ—Å**: "—Å—Ä–æ—á–Ω—ã–π —Å–∫—Ä–∏–ø—Ç"

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–æ–≤

| –î–æ–∫—É–º–µ–Ω—Ç | Vector rank | FTS rank |
|----------|-------------|----------|
| –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 2 | 1 |
| –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ | 1 | 2 |
| –¶–∏–∫–ª—ã –≤ Python | 3 | ‚Äî |

### RRF Score (k=60)

| –î–æ–∫—É–º–µ–Ω—Ç | –†–∞—Å—á—ë—Ç | Score |
|----------|--------|-------|
| –°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 1/(60+2) + 1/(60+1) = 0.0161 + 0.0164 | **0.0325** |
| –£–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ | 1/(60+1) + 1/(60+2) = 0.0164 + 0.0161 | 0.0325 |
| –¶–∏–∫–ª—ã –≤ Python | 1/(60+3) + 0 = 0.0159 | 0.0159 |

**–ò—Ç–æ–≥**: "–°–∫—Ä–∏–ø—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏" ‚Äî —Ç–æ–ø –≤ –æ–±–æ–∏—Ö ‚Üí –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ.

---

## –†–µ–∂–∏–º—ã –ø–æ–∏—Å–∫–∞ –≤ Semantic Core ‚öôÔ∏è

```python
# –¢–æ–ª—å–∫–æ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫
results = core.search(query, mode="vector")

# –¢–æ–ª—å–∫–æ –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π
results = core.search(query, mode="fts")

# –ì–∏–±—Ä–∏–¥–Ω—ã–π (default)
results = core.search(query, mode="hybrid", k=60)
```

| Mode | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|------|-------------------|
| `vector` | –°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–º—ã—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã ("—á—Ç–æ-—Ç–æ –ø—Ä–æ –º–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ") |
| `fts` | –¢–æ—á–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã, –∏–º–µ–Ω–∞, –∫–æ–¥—ã ("RFC 7231", "OAuth2") |
| `hybrid` | **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π** ‚Äî –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤ |

---

## SQL-—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–ø—Ä–æ—Å–∞ üí°

```sql
WITH vector_results AS (
    SELECT id, ROW_NUMBER() OVER (
        ORDER BY vec_distance_cosine(embedding, ?)
    ) as rank
    FROM chunks_vec
    LIMIT 100
),
fts_results AS (
    SELECT rowid as id, ROW_NUMBER() OVER (
        ORDER BY rank
    ) as rank  
    FROM chunks_fts
    WHERE chunks_fts MATCH ?
    LIMIT 100
),
rrf_scores AS (
    SELECT 
        COALESCE(v.id, f.id) as id,
        COALESCE(1.0/(60 + v.rank), 0) + 
        COALESCE(1.0/(60 + f.rank), 0) as score
    FROM vector_results v
    FULL OUTER JOIN fts_results f ON v.id = f.id
)
SELECT * FROM rrf_scores ORDER BY score DESC LIMIT 10;
```

---

## –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º ‚öôÔ∏è

```python
# –ü–æ–∏—Å–∫ —Ç–æ–ª—å–∫–æ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "Python"
results = core.search(
    query="—Ü–∏–∫–ª—ã",
    mode="hybrid",
    filters={"category": "Python"}
)
```

–§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è **–¥–æ** RRF —Å–ª–∏—è–Ω–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

---

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å üìä

| –ú–µ—Ç–æ–¥ | 10K –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ |
|-------|----------------|
| Vector only | ~50 ms |
| FTS only | ~5 ms |
| Hybrid (RRF) | ~60 ms |

**–ù–∞–∫–ª–∞–¥–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã RRF –º–∏–Ω–∏–º–∞–ª—å–Ω—ã** ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫.

---

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ k ‚öôÔ∏è

| k | –≠—Ñ—Ñ–µ–∫—Ç |
|---|--------|
| 10 | –°–∏–ª—å–Ω–µ–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç TOP-3 –æ—Ç –æ—Å—Ç–∞–ª—å–Ω—ã—Ö |
| **60** | **–°—Ç–∞–Ω–¥–∞—Ä—Ç** ‚Äî —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ |
| 100 | –ë–æ–ª–µ–µ –ø–ª–æ—Å–∫–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Å–æ–≤ |

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –û—Å—Ç–∞–≤–∏—Ç—å `k=60` –µ—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.

---

## –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã ‚ö†Ô∏è

| –ù—é–∞–Ω—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|----------|
| FULL OUTER JOIN | SQLite –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ‚Üí —ç–º—É–ª—è—Ü–∏—è —á–µ—Ä–µ–∑ UNION |
| TOP 100 –≤ CTE | –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ |
| –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ | FTS —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è MATCH |
| –ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –≤ FTS | –ü–æ–ª—É—á–∞–µ—Ç score —Ç–æ–ª—å–∫–æ –æ—Ç vector (–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç) |

---

## –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã üîó

- [–≠–º–±–µ–¥–¥–∏–Ω–≥–∏](01_embeddings.md) ‚Äî –∫–∞–∫ –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è –≤–µ–∫—Ç–æ—Ä—ã
- [–í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫](02_vector_search.md) ‚Äî sqlite-vec –∏ cosine distance
- [Chunking](04_chunking.md) ‚Äî –ø–æ—á–µ–º—É –∏—â–µ–º –ø–æ —á–∞–Ω–∫–∞–º, –∞ –Ω–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º
- [CLI Usage](../guides/core/cli-usage.md) ‚Äî `semantic search --mode hybrid`
