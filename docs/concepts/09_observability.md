---
title: "Observability & Logging"
description: "Semantic logging — dual-mode логирование для людей и AI"
tags: ["logging", "observability", "trace", "debug", "secrets"]
difficulty: "intermediate"
related: ["08_rag_architecture", "07_multimodal"]
---

# Observability & Logging 📊

> **Dual-mode logging**: Console (INFO+) для разработчика, File (TRACE) для AI-агентов.

---

## Проблема и решение 🎯

| Аудитория | Что нужно | Стандартный logging |
|-----------|-----------|---------------------|
| Разработчик | Краткие статусы, цвета | ❌ Монотонный текст |
| AI-агент | Полные пейлоады, промпты | ❌ Обрезанные сообщения |
| Debug | Что происходит внутри | ❌ Слишком шумно или тихо |

**Решение**: Раздельные хендлеры с разными уровнями и форматами.

---

## Архитектура логирования 📐

```
┌───────────────────────────────────────────────────────────┐
│                    Поток сообщения                        │
│                                                           │
│  logger.info("msg", **ctx)                               │
│        │                                                  │
│        ▼                                                  │
│  ┌─────────────────┐                                     │
│  │ SemanticLogger  │ ◀─ bind(batch_id=...), эмодзи      │
│  └────────┬────────┘                                     │
│           │                                               │
│           ▼                                               │
│  ┌─────────────────┐                                     │
│  │SensitiveFilter  │ ◀─ ***REDACTED*** для API keys     │
│  └────────┬────────┘                                     │
│           │                                               │
│     ┌─────┴─────┐                                        │
│     ▼           ▼                                        │
│ ┌───────┐  ┌────────┐                                   │
│ │Console│  │  File  │                                   │
│ │ INFO+ │  │ TRACE  │                                   │
│ │ Rich  │  │ JSON   │                                   │
│ └───────┘  └────────┘                                   │
└───────────────────────────────────────────────────────────┘
```

---

## Уровень TRACE 🔬

Кастомный уровень **ниже DEBUG** для детальных дампов:

| Уровень | Значение | Назначение |
|---------|----------|------------|
| TRACE | 5 | Полные пейлоады, промпты, JSON |
| DEBUG | 10 | Шаги алгоритма, внутренняя логика |
| INFO | 20 | Статусы операций |
| WARNING | 30 | Потенциальные проблемы |
| ERROR | 40 | Ошибки выполнения |

**TRACE используется для**:
- Полный текст промпта в LLM
- Сырой JSON-ответ от API
- Векторы (первые N элементов)
- Размеры батчей, токены

---

## SemanticLogger 🧠

Адаптер над `logging.Logger` с дополнительными возможностями:

| Метод | Назначение |
|-------|------------|
| `bind(**ctx)` | Привязка контекста (batch_id, doc_id) |
| `trace()` | Уровень TRACE для AI-агентов |
| `trace_ai()` | Логирование AI request/response |
| `error_with_context()` | Ошибка + traceback + контекст |

### Контекст через bind()

```
logger = get_logger(__name__)
log = logger.bind(batch_id="batch-123")
log.info("Processing")  
# ──▶ 📥 [batch-123] Processing

log2 = log.bind(chunk_id="chunk-42")
log2.info("Chunk ready")
# ──▶ 📥 [batch-123/chunk-42] Chunk ready
```

---

## Эмодзи-система 🎨

Каждый модуль имеет свой эмодзи для визуальной идентификации:

| Модуль | Эмодзи | Что делает |
|--------|--------|------------|
| embedder | 🧠 | Векторизация |
| storage | 💾 | Работа с БД |
| search | 🔍 | Поиск |
| batch | 📦 | Batch-обработка |
| media | 🖼️ | Мультимодальность |
| rag | 🤖 | RAG-запросы |
| pipeline | 📥 | Оркестрация |

---

## Secret Redaction 🔐

**SensitiveDataFilter** автоматически маскирует API-ключи:

```
┌─────────────────────────────────────────┐
│             Входное сообщение           │
│ "API key: AIzaSyD...xyz, token: sk-..." │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│           SensitiveFilter               │
│  • Regex для API key patterns           │
│  • Bearer tokens                         │
│  • sk-proj-*, AIza*, etc.               │
└────────────────┬────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────┐
│            Выходное сообщение           │
│ "API key: ***REDACTED***, token: ..."   │
└─────────────────────────────────────────┘
```

**Почему Filter, а не Formatter?**
- Filter применяется ДО всех хендлеров
- Работает для Console И File
- Секреты не попадают в память хендлеров

---

## Конфигурация 🔧

Через environment variables или `LoggingConfig`:

| Переменная | Дефолт | Описание |
|------------|--------|----------|
| `SEMANTIC_LOG_LEVEL` | INFO | Уровень консоли |
| `SEMANTIC_LOG_FILE` | None | Путь к файлу логов |
| `SEMANTIC_LOG_JSON` | false | JSON-формат для файла |
| `SEMANTIC_LOG_REDACT` | true | Маскировать API-ключи |

---

## Диагностика 🩺

Для баг-репортов и отладки:

| Функция | Что делает |
|---------|------------|
| `dump_debug_info()` | Полный дамп конфигурации |
| `check_config()` | Валидация настроек |
| `get_handlers_info()` | Список активных хендлеров |

---

## Связанные концепты 🔗

| Концепт | Как связан |
|---------|------------|
| [RAG Architecture](08_rag_architecture.md) | Логирование RAG-запросов |
| [Multimodal](07_multimodal.md) | Логирование анализа медиа |
| [Batch Processing](06_batch_processing.md) | Контекст batch_id в логах |

---

## Итог 📌

| Аспект | Реализация |
|--------|------------|
| Логгер | `SemanticLogger` через `get_logger()` |
| Уровни | TRACE (5) → ERROR (40) |
| Консоль | RichHandler + эмодзи |
| Файл | FileHandler + JSON (опционально) |
| Секреты | `SensitiveDataFilter` авто-маскирование |
| Контекст | `bind()` для иерархического контекста |
