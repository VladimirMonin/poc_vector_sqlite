<!DOCTYPE html>
<html lang="ru" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Semantic Knowledge Base{% endblock %}</title>
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    
    <!-- Auto Dark Mode -->
    <script>
        // Автоматическое определение темы системы
        (function() {
            const getPreferredTheme = () => {
                const stored = localStorage.getItem('theme');
                if (stored) return stored;
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            };
            
            const setTheme = (theme) => {
                document.documentElement.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
            };
            
            setTheme(getPreferredTheme());
            
            // Слушаем изменения системной темы
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!localStorage.getItem('theme')) {
                    setTheme(e.matches ? 'dark' : 'light');
                }
            });
            
            // Экспортируем для переключателя
            window.toggleTheme = () => {
                const current = document.documentElement.getAttribute('data-bs-theme');
                setTheme(current === 'dark' ? 'light' : 'dark');
            };
        })();
    </script>
    
    <style>
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 56px;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 56px - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        .sidebar .nav-link {
            font-weight: 500;
            color: var(--bs-secondary-color);
        }
        
        .sidebar .nav-link:hover {
            color: var(--bs-primary);
        }
        
        .sidebar .nav-link.active {
            color: var(--bs-primary);
        }
        
        .sidebar .nav-link .bi {
            margin-right: 8px;
        }
        
        /* Main content offset for sidebar */
        main {
            margin-left: 220px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            main {
                margin-left: 0;
            }
        }
        
        /* HTMX loading indicator */
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
        
        /* Score colors */
        .score-high { color: var(--bs-success); }
        .score-medium { color: var(--bs-warning); }
        .score-low { color: var(--bs-secondary); }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top bg-body-tertiary border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="{{ url_for('main.index') }}">
                <i class="bi bi-brain me-2"></i>
                Semantic KB
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('main.index') }}">
                            <i class="bi bi-house"></i> Главная
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('search.index') }}">
                            <i class="bi bi-search"></i> Поиск
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('chat.index') }}">
                            <i class="bi bi-chat-dots"></i> Чат
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('ingest.upload_page') }}">
                            <i class="bi bi-upload"></i> Загрузка
                        </a>
                    </li>
                </ul>
                
                <div class="d-flex align-items-center">
                    <!-- About -->
                    <a class="btn btn-link nav-link" href="{{ url_for('settings.about') }}" title="О приложении">
                        <i class="bi bi-info-circle"></i>
                    </a>
                    <!-- Theme toggle -->
                    <button class="btn btn-link nav-link" onclick="toggleTheme()" title="Переключить тему">
                        <i class="bi bi-moon-stars"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Sidebar -->
    <nav class="sidebar col-md-3 col-lg-2 bg-body-tertiary">
        <div class="sidebar-sticky pt-3">
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint == 'main.index' %}active{% endif %}" href="{{ url_for('main.index') }}">
                        <i class="bi bi-speedometer2"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint and request.endpoint.startswith('ingest') %}active{% endif %}" href="{{ url_for('ingest.documents_page') }}">
                        <i class="bi bi-file-text"></i>
                        Документы
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="bi bi-image"></i>
                        Медиа
                    </a>
                </li>
            </ul>
            
            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
                <span>Инструменты</span>
            </h6>
            <ul class="nav flex-column mb-2">
                <li class="nav-item">
                    <a class="nav-link {% if request.endpoint and request.endpoint.startswith('settings') %}active{% endif %}" href="{{ url_for('settings.index') }}">
                        <i class="bi bi-gear"></i>
                        Настройки
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">
                        <i class="bi bi-list-task"></i>
                        Очередь
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- Main content -->
    <main class="py-4" style="margin-top: 56px;">
        <div class="container-fluid px-4">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% block content %}{% endblock %}
        </div>
    </main>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Highlight.js (для подсветки кода) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>
        // Автоматическая подсветка кода после HTMX swap
        document.body.addEventListener('htmx:afterSwap', function(event) {
            event.detail.elt.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        });
        
        // Начальная подсветка
        hljs.highlightAll();
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>
