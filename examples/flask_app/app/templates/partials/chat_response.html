<!-- Chat response partial (HTMX target) -->
<!-- Вставляется в #chat-response после каждого ответа -->

<div class="message message-assistant" data-session-id="{{ response.session_id }}">
    <div class="message-content">
        {{ render_markdown(response.answer) | safe }}
    </div>
    
    {% if response.sources %}
    <div class="message-sources">
        <small class="text-muted d-block mb-2">
            <i class="bi bi-bookmark me-1"></i>
            Источники ({{ response.sources | length }}):
        </small>
        
        <div class="d-flex flex-wrap gap-1">
            {% for source in response.sources %}
            <span class="source-badge" 
                  data-bs-toggle="tooltip" 
                  data-bs-placement="top"
                  title="{{ source.content_preview }}">
                <span class="source-index">{{ source.index }}</span>
                <span class="source-title text-truncate" style="max-width: 150px;">
                    {{ source.title }}
                </span>
                <span class="badge bg-secondary">{{ source.chunk_type }}</span>
            </span>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% if response.tokens_used %}
    <div class="mt-2">
        <small class="text-muted">
            <i class="bi bi-lightning me-1"></i>
            {{ response.tokens_used }} токенов
        </small>
    </div>
    {% endif %}
</div>

<script>
// Initialize tooltips for new sources
document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
    new bootstrap.Tooltip(el);
});
</script>
